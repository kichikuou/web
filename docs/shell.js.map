{
  "version": 3,
  "sources": ["../shell/util.ts", "../shell/config.ts", "../shell/widgets.ts", "../shell/strings.ts", "../shell/toolbar.ts", "../shell/moduleloader.ts", "../shell/savedata.ts", "../shell/settings.ts", "../shell/cdimage.ts", "../shell/cddaloader.ts", "../shell/datafile.ts", "../shell/loadersource.ts", "../shell/cdda.ts", "../shell/volume.ts", "../shell/midi.ts", "../shell/loader.ts", "../shell/zoom.ts", "../shell/audio.ts", "../shell/textlog.ts", "../shell/shell.ts"],
  "sourcesContent": ["// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\n\nexport const $: (selector: string) => HTMLElement = document.querySelector.bind(document);\n\nexport const urlParams = new URLSearchParams(location.search.slice(1));\nexport const JSZIP_SCRIPT = 'lib/jszip.3.1.3.min.js';\n\nconst scriptPromises: Map<string, Promise<any>> = new Map();\nexport function loadScript(src: string): Promise<any> {\n    let p = scriptPromises.get(src);\n    if (!p) {\n        let e = document.createElement('script');\n        e.src = src;\n        p = new Promise((resolve, reject) => {\n            e.addEventListener('load', resolve, {once: true});\n            e.addEventListener('error', reject, {once: true});\n        });\n        document.body.appendChild(e);\n        scriptPromises.set(src, p);\n    }\n    return p;\n}\n\nexport function readFileAsArrayBuffer(blob: Blob): Promise<ArrayBuffer> {\n    return new Promise((resolve, reject) => {\n        let reader = new FileReader();\n        reader.onload = () => { resolve(reader.result as ArrayBuffer); };\n        reader.onerror = () => { reject(reader.error); };\n        reader.readAsArrayBuffer(blob);\n    });\n}\n\nexport function readFileAsText(blob: Blob): Promise<string> {\n    return new Promise((resolve, reject) => {\n        let reader = new FileReader();\n        reader.onload = () => { resolve(reader.result as string); };\n        reader.onerror = () => { reject(reader.error); };\n        reader.readAsText(blob);\n    });\n}\n\nexport function mkdirIfNotExist(path: string, fs?: typeof FS) {\n    try {\n        (fs || FS).mkdir(path);\n    } catch (err) {\n        // ignore EEXIST\n    }\n}\n\nexport function isMobileSafari(from?: string, to?: string): boolean {\n    let match = navigator.userAgent.match(/OS ([0-9_]+) like Mac OS X\\)/);\n    if (!match)\n        return false;\n    let ver = match[1].replace(/_/g, '.');\n    return (!from || from <= ver) && (!to || ver < to);\n}\n\nexport function JSZipOptions(): JSZipLoadOptions {\n    let opts: JSZipLoadOptions = {};\n    if (typeof TextDecoder !== 'undefined')\n        opts = {decodeFileName} as JSZipLoadOptions;\n    return opts;\n\n    function decodeFileName(bytes: Uint8Array): string {\n        try {\n            return new TextDecoder('utf-8', { fatal: true }).decode(bytes);\n        } catch (err) {\n            return new TextDecoder('shift_jis', { fatal: true }).decode(bytes);\n        }\n    }\n}\n\nexport class Deferred<T> {\n    public promise: Promise<T>;\n    private _resolve!: (value: T) => void;\n    private _reject!: (reason?: any) => void;\n\n    constructor() {\n        this.promise = new Promise((resolve, reject) => {\n            this._resolve = resolve;\n            this._reject = reject;\n        });\n    }\n    resolve(value: T) {\n        this._resolve(value);\n    }\n    reject(reason?: any) {\n        this._reject(reason);\n    }\n}\n\nexport function startMeasure(name: string, gaName?: string, gaParam?: string): () => void {\n    let startMark = name + '-start';\n    let endMark = name + '-end';\n    performance.mark(startMark);\n    return () => {\n        performance.mark(endMark);\n        performance.measure(name, startMark, endMark);\n        if (gaName) {\n            let duration = performance.getEntriesByName(name)[0].duration;\n            ga('send', 'timing', gaName, gaParam, Math.round(duration));\n        }\n    };\n}\n\nexport function gaException(description: any, exFatal: boolean = false) {\n    let exDescription = JSON.stringify(description, (_, value) => {\n        if (value instanceof DOMException) {\n            return {DOMException: value.name, message: value.message};\n        }\n        return value;\n    });\n    ga('send', 'exception', {exDescription, exFatal});\n}\n\n// xsystem35 constants\nexport enum Status {\n    OK = 0,\n    NG = -1,\n}\nexport enum Bool {\n    FALSE = 0,\n    TRUE = 1,\n}\n\nexport enum DRIType {\n    SCO = 0,\n    CG = 1,\n    WAVE = 2,\n    MIDI = 3,\n    DATA = 4,\n    RSC = 5,\n    BGM = 6,\n}\n\nexport function ald_getdata(type: DRIType, no: number): ArrayBuffer | null {\n    let dfile = _ald_getdata(type, no);\n    if (!dfile)\n        return null;\n    let ptr = Module.getValue(dfile + 8, '*');\n    let size = Module.getValue(dfile, 'i32');\n    let buf = Module.HEAPU8.buffer.slice(ptr, ptr + size);\n    _ald_freedata(dfile);\n    return buf;\n}\n\ndeclare global {\n    // xsystem35 exported functions\n    function _ags_setAntialiasedStringMode(on: number): void;\n    function _ald_getdata(type: number, no: number): number;\n    function _ald_freedata(data: number): void;\n    function _sdl_getDisplaySurface(): number;\n    function _audio_callback(ptr: number, len: number): number;\n    function _msgskip_activate(enable: number): void;\n    function _msgskip_setFlags(flags: number, mask: number): void;\n    function _sys_restart(): void;\n    function _nact_current_page(): number;\n    function _nact_current_addr(): number;\n\n    var Module: EmscriptenModule;\n    interface EmscriptenModule {\n        getValue: typeof getValue;\n        addRunDependency: typeof addRunDependency;\n        removeRunDependency: typeof removeRunDependency;\n        // Undocumented methods / attributes\n        canvas: HTMLCanvasElement;\n    }\n    function setWindowTitle(title: string): void;\n    function readAsync(url: string, onload: (response: any) => void, onerror: () => void): void;\n\n    namespace Asyncify {\n        function handleSleep(op : (wakeUp: (result: any) => void) => void): void;\n    }\n\n    // stbvorbis.js\n    namespace stbvorbis {\n        type DecodeResult = {\n            data: Float32Array[],\n            sampleRate: number,\n            eof: boolean,\n            error?: string\n        }\n        function decode(buf: ArrayBuffer|Uint8Array, callback: (event: DecodeResult) => void): void;\n    }\n}\n\n// https://storage.spec.whatwg.org\ninterface Navigator {\n    storage: StorageManager;\n}\ninterface StorageManager {\n    persisted: () => Promise<boolean>;\n    persist: () => Promise<boolean>;\n    // estimate: () => Promise<StorageEstimate>;\n}\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\n\nclass Config {\n    antialias = true;\n    pixelate = false;\n    unloadConfirmation = true;\n    volume = 1;\n    zoom = 'fit';\n    messageSkipFlags = 2 | 4 | 8;  // STOP_ON_UNSEEN, STOP_ON_MENU, STOP_ON_CLICK\n\n    constructor() {\n        let json = localStorage.getItem('KichikuouWeb.Config');\n        if (json) {\n            let val = JSON.parse(json);\n            if (val.antialias !== undefined) this.antialias = val.antialias;\n            if (val.pixelate !== undefined) this.pixelate = val.pixelate;\n            if (val.unloadConfirmation !== undefined) this.unloadConfirmation = val.unloadConfirmation;\n            if (val.volume !== undefined) this.volume = val.volume;\n            if (val.zoom !== undefined) this.zoom = val.zoom;\n            if (val.messageSkipFlags != undefined) this.messageSkipFlags = val.messageSkipFlags;\n        }\n    }\n\n    persist() {\n        localStorage.setItem('KichikuouWeb.Config', JSON.stringify({\n            antialias: this.antialias,\n            pixelate: this.pixelate,\n            unloadConfirmation: this.unloadConfirmation,\n            volume: this.volume,\n            zoom: this.zoom,\n            messageSkipFlags: this.messageSkipFlags,\n        }));\n    }\n}\nexport let config = new Config();\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$} from './util.js';\n\nexport function addToast(msg: string | Node, type?: 'success' | 'warning' | 'error'): HTMLElement {\n    let container = $('.toast-container');\n    let div = document.createElement('div');\n    div.classList.add('toast');\n    if (type)\n        div.classList.add('toast-' + type);\n    if (typeof msg === 'string')\n        div.innerText = msg;\n    else\n        div.appendChild(msg);\n    let btn = document.createElement('button');\n    btn.setAttribute('class', 'btn btn-clear float-right');\n    function dismiss() { if (div.parentNode === container) container.removeChild(div); }\n    btn.addEventListener('click', dismiss);\n    let timeout = type ? {success: 5000, warning: 10000, error: null}[type] : 5000;\n    if (timeout)\n        setTimeout(dismiss, timeout);\n    div.insertBefore(btn, div.firstChild);\n    container.insertBefore(div, container.firstChild);\n    return div;\n}\n\nexport function openFileInput(): Promise<File> {\n    return new Promise((resolve) => {\n        let input = document.createElement('input');\n        input.type = 'file';\n        input.addEventListener('change', (evt: Event) => {\n            document.body.removeChild(input);\n            resolve(input.files![0]);\n        });\n        input.style.display = 'none';\n        document.body.appendChild(input);\n        input.click();\n    });\n}\n\nexport function downloadAs(filename: string, url: string, target?: string) {\n    let elem = document.createElement('a');\n    elem.setAttribute('download', filename);\n    elem.setAttribute('href', url);\n    if (target)\n        elem.setAttribute('target', target);\n    document.body.appendChild(elem);\n    elem.click();\n    setTimeout(() => { document.body.removeChild(elem); }, 5000);\n}\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\n\nconst dictionary_en = {\n    cannot_install: 'Cannot install',\n    error_occurred: 'An error occurred.',\n    game_over: 'The game is over.',\n    import_savedata_confirm: 'Import save files from Kichikuou on Chrome?',\n    input_char_limit: (maxLength: number) => `Up to ${maxLength} characters`,\n    module_load_failed: (src: string) => `Failed to load ${src}. Please reload the page.`,\n    no_ald_in_zip: 'No game files (*.ALD/*.DAT) in the zip file.',\n    no_gamedata_dir: 'No GAMEDATA folder in the image.',\n    floppy_images_cant_be_used: 'Floppy disk images cannot be loaded.',\n    restart_confirmation: 'Restart the game?',\n    restore_success: 'Save files has been restored successfully.',\n    restore_failure: 'Save files could not be restored.',\n    unload_confirmation: 'Unsaved data will be lost.',\n    unrecognized_format: 'Unrecognized format.',\n};\ntype Dictionary = typeof dictionary_en;\n\nconst dictionary_ja: Dictionary = {\n    cannot_install: 'インストールできません',\n    error_occurred: 'エラーが発生しました。',\n    game_over: 'ゲームは終了しました。',\n    import_savedata_confirm: '鬼畜王 on Chrome のセーブデータを引き継ぎますか?',\n    input_char_limit: (maxLength: number) => `全角${maxLength}文字まで`,\n    module_load_failed: (src: string) => src + 'の読み込みに失敗しました。リロードしてください。',\n    no_ald_in_zip: 'ZIP内にゲームデータ (*.ALD/*.DATファイル) が見つかりません。',\n    no_gamedata_dir: 'イメージ内にGAMEDATAフォルダが見つかりません。',\n    floppy_images_cant_be_used: 'フロッピーディスクイメージは読み込めません。Windows版のデータを使用してください。',\n    restart_confirmation: 'ゲームを再起動しますか？',\n    restore_success: 'セーブデータの復元に成功しました。',\n    restore_failure: 'セーブデータを復元できませんでした。',\n    unload_confirmation: 'セーブしていないデータは失われます。',\n    unrecognized_format: '認識できない形式です。',\n};\n\nconst dicts:{[language: string]: Dictionary} = {\n    en: dictionary_en,\n    ja: dictionary_ja\n};\n\nfunction selectDictionary(): Dictionary {\n    let lang = document.documentElement.getAttribute('lang');\n    if (lang && dicts[lang])\n        return dicts[lang];\n    return dictionary_en;\n}\nexport const message = selectDictionary();\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$} from './util.js';\nimport {downloadAs} from './widgets.js';\nimport {message} from './strings.js';\n\nconst msgskip_button = $('#msgskip-button');\n\nfunction init() {\n    $('#restart-button').addEventListener('click', restart);\n    $('#screenshot-button').addEventListener('click', saveScreenshot);\n    msgskip_button.addEventListener('click', toggleMessageSkip);\n    document.addEventListener('gamestart', () => {\n        document.addEventListener('keydown', keyDownHandler);\n    });\n}\n\nexport function setCloseable() {\n    $('#toolbar-handler').addEventListener('click', open);\n    $('#toolbar-close-button').addEventListener('click', close);\n    $('#toolbar').classList.add('closeable');\n    close();\n}\n\nfunction open() {\n    $('#toolbar').classList.remove('closed');\n}\n\nfunction close() {\n    $('#toolbar').classList.add('closed');\n}\n\nfunction keyDownHandler(e: KeyboardEvent) {\n    switch (e.keyCode) {\n        case 80: // 'p'\n            saveScreenshot();\n            break;\n        case 82: // 'r'\n            restart();\n            break;\n        case 83: // 's'\n            toggleMessageSkip();\n            break;\n    }\n}\n\nexport function setSkipButtonState(enabled: number, activated: number) {\n    msgskip_button.classList.toggle('disabled', !enabled);\n    msgskip_button.classList.toggle('activated', !!activated);\n}\n\nfunction toggleMessageSkip() {\n    _msgskip_activate(msgskip_button.classList.contains('activated') ? 0 : 1);\n}\n\nfunction restart() {\n    if (window.confirm(message.restart_confirmation)) {\n        ga('send', 'event', 'Toolbar', 'Restart');\n        _sys_restart();\n    }\n}\n\nasync function saveScreenshot() {\n    let pixels = _sdl_getDisplaySurface();\n    let canvas = document.createElement('canvas');\n    canvas.width = Module.canvas.width;\n    canvas.height = Module.canvas.height;\n    let ctx = canvas.getContext('2d')!;\n    let image = ctx.createImageData(canvas.width, canvas.height);\n    let buffer = image.data;\n    let num = image.data.length;\n    for (let dst = 0; dst < num; dst += 4) {\n        buffer[dst] = Module.HEAPU8[pixels + 2];\n        buffer[dst + 1] = Module.HEAPU8[pixels + 1];\n        buffer[dst + 2] = Module.HEAPU8[pixels];\n        buffer[dst + 3] = 0xff;\n        pixels += 4;\n    }\n    ctx.putImageData(image, 0, 0);\n\n    let blob: Blob | null = await new Promise((resolve) => canvas.toBlob(resolve));\n    if (!blob) return;\n    // Unless target=\"_blank\", iOS safari replaces current page\n    downloadAs(getScreenshotFilename(), URL.createObjectURL(blob), '_blank');\n}\n\nfunction getScreenshotFilename(): string {\n    let now = new Date();\n    let MM = ('0' + (now.getMonth() + 1)).slice(-2);\n    let DD = ('0' + now.getDate()).slice(-2);\n    let hh = ('0' + now.getHours()).slice(-2);\n    let mm = ('0' + now.getMinutes()).slice(-2);\n    let ss = ('0' + now.getSeconds()).slice(-2);\n    return 'Screenshot-' + now.getFullYear() + MM + DD + '-' + hh + mm + ss + '.png';\n}\n\ninit();\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$, urlParams, readFileAsArrayBuffer, startMeasure, Status} from './util.js';\nimport {addToast} from './widgets.js';\nimport * as toolbar from './toolbar.js';\nimport {message} from './strings.js';\n\nconst FontGothic = 'MTLc3m.ttf';\nconst FontMincho = 'mincho.otf';\n\nlet fsReady: (_?: any) => void;\nexport let fileSystemReady: Promise<any> = new Promise((resolve) => { fsReady = resolve; });\nlet idbfsReady: (fs: typeof FS) => void;\nexport let saveDirReady: Promise<typeof FS> = new Promise((resolve) => { idbfsReady = resolve; });\n\nfunction init() {\n    window.Module = {} as EmscriptenModule;\n    Module.arguments = [];\n    for (let [name, val] of urlParams) {\n        if (name.startsWith('-')) {\n            Module.arguments.push(name);\n            if (val)\n                Module.arguments.push(val);\n        }\n    }\n    Module.print = Module.printErr = console.log.bind(console);\n    Module.canvas = <HTMLCanvasElement>document.getElementById('canvas');\n    Module.preRun = [\n        () => { Module.addRunDependency('gameFiles'); },\n        fsReady,\n        function loadFont() {\n            FS.mkdir('/fonts');\n            FS.createPreloadedFile('/fonts', FontGothic, 'fonts/' + FontGothic, true, false);\n        },\n        function prepareSaveDir() {\n            FS.mkdir('/save');\n            FS.mount(IDBFS, {}, '/save');\n            Module.addRunDependency('syncfs');\n            FS.syncfs(true, (err) => {\n                importSaveDataFromLocalFileSystem().then(() => {\n                    Module.removeRunDependency('syncfs');\n                    idbfsReady(FS);\n                });\n            });\n        },\n        () => {\n            // Don't let emscripten change the window title.\n            // Must be overwritten after the emscripten module is evaluated.\n            window.setWindowTitle = () => {};\n        }\n    ];\n}\n\nexport function loadModule(name: 'system3' | 'xsystem35'): Promise<any> {\n    $('#loader').classList.add('module-loading');\n    let src = name + '.js';\n    let script = document.createElement('script');\n    script.src = src;\n    script.onerror = () => {\n        ga('send', 'event', 'Game', 'ModuleLoadFailed', src);\n        addToast(message.module_load_failed(src), 'error');\n    };\n    document.body.appendChild(script);\n    let endMeasure = startMeasure('ModuleLoad', 'Module load', src);\n    return fileSystemReady.then(() => {\n        endMeasure();\n        $('#loader').hidden = true;\n        document.body.classList.add('bgblack-fade');\n        toolbar.setCloseable();\n    });\n}\n\nlet fsyncTimer: number | undefined;\nexport function syncfs(timeout: number) {\n    window.clearTimeout(fsyncTimer);\n    fsyncTimer = window.setTimeout(() => {\n        FS.syncfs(false, (err) => {\n            if (err)\n                console.log('FS.syncfs error: ', err);\n        });\n    }, timeout);\n    persistStorage();\n}\n\nlet persistRequested = false;\nasync function persistStorage() {\n    if (persistRequested || !(navigator.storage && navigator.storage.persist))\n        return;\n    persistRequested = true;\n    if (await navigator.storage.persisted())\n        return;\n    let result = await navigator.storage.persist();\n    ga('send', 'event', 'Game', 'StoragePersist', result ? 'granted' : 'refused');\n}\n\nlet mincho_loaded = false;\nexport function load_mincho_font(): Promise<number> {\n    if (mincho_loaded)\n        return Promise.resolve(Status.OK);\n    mincho_loaded = true;\n\n    return new Promise((resolve) => {\n        console.log('loading mincho font');\n        let endMeasure = startMeasure('FontLoad', 'Font load', FontMincho);\n        readAsync('fonts/' + FontMincho, (buf: ArrayBuffer) => {\n            endMeasure();\n            FS.writeFile('/fonts/' + FontMincho, new Uint8Array(buf));\n            resolve(Status.OK);\n        }, () => {\n            resolve(Status.NG);\n        });\n    });\n}\n\nasync function importSaveDataFromLocalFileSystem() {\n    function requestFileSystem(type: number, size: number): Promise<FileSystem> {\n        return new Promise((resolve, reject) => window.webkitRequestFileSystem(type, size, resolve, reject));\n    }\n    function getDirectory(dir: DirectoryEntry, path: string): Promise<DirectoryEntry> {\n        return new Promise((resolve, reject) => dir.getDirectory(path, {}, resolve, reject));\n    }\n    function readEntries(reader: DirectoryReader): Promise<Entry[]> {\n        return new Promise((resolve, reject) => reader.readEntries(resolve, reject));\n    }\n    function fileOf(entry: FileEntry): Promise<File> {\n        return new Promise((resolve, reject) => entry.file(resolve, reject));\n    }\n\n    if (FS.readdir('/save').length > 2)  // Are there any entries other than . and ..?\n        return;\n    if (!window.webkitRequestFileSystem)\n        return;\n    try {\n        let fs = await requestFileSystem(self.PERSISTENT, 0);\n        let savedir = (await getDirectory(fs.root, 'save')).createReader();\n        let entries: FileEntry[] = [];\n        while (true) {\n            let results = await readEntries(savedir);\n            if (!results.length)\n                break;\n            for (let e of results) {\n                if (e.isFile && e.name.toLowerCase().endsWith('.asd'))\n                    entries.push(e as FileEntry);\n            }\n        }\n        if (entries.length && window.confirm(message.import_savedata_confirm)) {\n            for (let e of entries) {\n                let content = await readFileAsArrayBuffer(await fileOf(e));\n                FS.writeFile('/save/' + e.name, new Uint8Array(content));\n            }\n            syncfs(0);\n            ga('send', 'event', 'Game', 'SaveDataImported');\n        }\n    } catch (err) {\n    }\n}\n\ninit();\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {loadScript, JSZIP_SCRIPT, readFileAsArrayBuffer, JSZipOptions, mkdirIfNotExist} from './util.js';\nimport {saveDirReady} from './moduleloader.js';\nimport {addToast, downloadAs} from './widgets.js';\nimport {message} from './strings.js';\n\ndeclare function FSLib(): {saveDirReady: Promise<typeof FS>};\n\nexport class SaveDataManager {\n    private FSready!: Promise<typeof FS>;\n\n    constructor() {\n        if ((<any>window).FS)\n            this.FSready = saveDirReady;\n        if (!this.FSready) {\n            this.FSready = (async () => {\n                await loadScript('fslib.js');\n                const fslib = await FSLib();\n                return fslib.saveDirReady;\n            })();\n        }\n        loadScript(JSZIP_SCRIPT);\n    }\n\n    public hasSaveData(): Promise<boolean> {\n        function find(fs: typeof FS, dir: string): boolean {\n            if (!fs.isDir(fs.stat(dir).mode))\n                return false;\n            for (let name of fs.readdir(dir) as string[]) {\n                if (name[0] === '.')\n                    continue;\n                if (name.toLowerCase().endsWith('.asd') || name.toLowerCase().endsWith('.dat'))\n                    return true;\n                if (find(fs, dir + '/' + name))\n                    return true;\n            }\n            return false;\n        }\n        return this.FSready.then((fs) => find(fs, '/save'));\n    }\n\n    public async download() {\n        await loadScript(JSZIP_SCRIPT);\n        let zip = new JSZip();\n        storeZip(await this.FSready, '/save', zip.folder('save'));\n        let blob = await zip.generateAsync({type: 'blob', compression: 'DEFLATE'});\n        downloadAs('savedata.zip', URL.createObjectURL(blob));\n        ga('send', 'event', 'Savedata', 'Downloaded');\n    }\n\n    public async extract(file: File) {\n        try {\n            let fs = await this.FSready;\n            if (file.name.toLowerCase().endsWith('.asd')) {\n                addSaveFile(fs, '/save/' + file.name, await readFileAsArrayBuffer(file));\n            } else {\n                await loadScript(JSZIP_SCRIPT);\n                let zip = new JSZip();\n                await zip.loadAsync(await readFileAsArrayBuffer(file), JSZipOptions());\n                let entries: JSZipObject[] = [];\n                zip.folder('save').forEach((path, z) => { entries.push(z); });\n                for (let z of entries) {\n                    if (z.dir)\n                        mkdirIfNotExist('/' + z.name.slice(0, -1), fs);\n                    else\n                        addSaveFile(fs, '/' + z.name, await z.async('arraybuffer'));\n                }\n            }\n            await new Promise((resolve, reject) => {\n                fs.syncfs(false, (err) => {\n                    if (err)\n                        reject(err);\n                    else\n                        resolve(undefined);\n                });\n            });\n            addToast(message.restore_success, 'success');\n            ga('send', 'event', 'Savedata', 'Restored');\n        } catch (err) {\n            addToast(message.restore_failure, 'error');\n            ga('send', 'event', 'Savedata', 'RestoreFailed', err.message);\n            console.warn(err);\n            ga('send', 'exception', {exDescription: err.stack, exFatal: false});\n        }\n    }\n}\n\nfunction storeZip(fs: typeof FS, dir: string, zip: JSZip) {\n    for (let name of fs.readdir(dir)) {\n        let path = dir + '/' + name;\n        if (name[0] === '.') {\n            continue;\n        } else if (fs.isDir(fs.stat(path).mode)) {\n            storeZip(fs, path, zip.folder(name));\n        } else if (!name.toLowerCase().endsWith('.asd.')) {\n            let content = fs.readFile(path, { encoding: 'binary' });\n            zip.file(name, content);\n        }\n    }\n}\n\nfunction addSaveFile(fs: typeof FS, path: string, content: ArrayBuffer) {\n    fs.writeFile(path, new Uint8Array(content));\n}\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$} from './util.js';\nimport {config} from './config.js';\nimport {SaveDataManager} from './savedata.js';\nimport {openFileInput} from './widgets.js';\n\n// Settings Dialog\n\nconst antialias = <HTMLInputElement>$('#antialias');\nconst unloadConfirmation = <HTMLInputElement>$('#unload-confirmation');\nconst messageSkipFlags: { [id: string]: number } = {\n    '#msgskip-skip-unseen': 1,\n    '#msgskip-stop-on-unseen': 2,\n    '#msgskip-stop-on-menu': 4,\n    '#msgskip-stop-on-click': 8,\n};\nlet saveDataManager: SaveDataManager | null = null;\nlet keyDownHandler: (ev: KeyboardEvent) => void;\n\nfunction init() {\n    $('#settings-button').addEventListener('click', openModal);\n    $('#settings-close').addEventListener('click', closeModal);\n    keyDownHandler = (ev: KeyboardEvent) => {\n        if (ev.keyCode === 27)  // escape\n            closeModal();\n    };\n    $('#settings-overlay').addEventListener('click', closeModal);\n\n    antialias.addEventListener('change', antialiasChanged);\n    antialias.checked = config.antialias;\n    unloadConfirmation.addEventListener('change', unloadConfirmationChanged);\n    unloadConfirmation.checked = config.unloadConfirmation;\n    for (const id in messageSkipFlags) {\n        const e = $(id) as HTMLInputElement;\n        e.addEventListener('change', messageSkipFlagChanged);\n        e.checked = !!(config.messageSkipFlags & messageSkipFlags[id]);\n    }\n    $('#msgskip-stop-on-unseen').toggleAttribute(\n        'disabled', ($('#msgskip-skip-unseen') as HTMLInputElement).checked);\n\n    $('#downloadSaveData').addEventListener('click', downloadSaveData);\n    $('#uploadSaveData').addEventListener('click', uploadSaveData);\n\n    document.addEventListener('gamestart', onGameStart);\n}\n\nfunction onGameStart() {\n    messageSkipFlagChanged();  // set the initial values\n}\n\nfunction openModal() {\n    $('#settings-modal').classList.add('active');\n    document.addEventListener('keydown', keyDownHandler);\n    saveDataManager = new SaveDataManager();\n    checkSaveData();\n}\n\nfunction closeModal() {\n    $('#settings-modal').classList.remove('active');\n    document.removeEventListener('keydown', keyDownHandler);\n    saveDataManager = null;\n}\n\nfunction antialiasChanged() {\n    config.antialias = antialias.checked;\n    config.persist();\n    if (!$('#xsystem35').hidden)\n        _ags_setAntialiasedStringMode(config.antialias ? 1 : 0);\n}\n\nfunction unloadConfirmationChanged() {\n    config.unloadConfirmation = unloadConfirmation.checked;\n    config.persist();\n}\n\nfunction messageSkipFlagChanged() {\n    let flags = 0;\n    for (const id in messageSkipFlags) {\n        if (($(id) as HTMLInputElement).checked)\n            flags |= messageSkipFlags[id];\n    }\n    $('#msgskip-stop-on-unseen').toggleAttribute(\n        'disabled', ($('#msgskip-skip-unseen') as HTMLInputElement).checked);\n    if ((window as any)['_msgskip_setFlags'])\n        _msgskip_setFlags(flags, 0xffffffff);\n    config.messageSkipFlags = flags;\n    config.persist();\n}\n\nasync function checkSaveData() {\n    if ($('#downloadSaveData').hasAttribute('disabled') &&\n        await saveDataManager!.hasSaveData())\n        $('#downloadSaveData').removeAttribute('disabled');\n}\n\nasync function downloadSaveData() {\n    saveDataManager!.download();\n}\n\nfunction uploadSaveData() {\n    openFileInput().then((file) =>\n        saveDataManager!.extract(file)).then(() =>\n        checkSaveData());\n}\n\ninit();\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {readFileAsArrayBuffer, readFileAsText} from './util.js';\nimport {openFileInput} from './widgets.js';\n\nexport class ISO9660FileSystem {\n    private decoder: TextDecoder;\n\n    static async create(sectorReader: Reader): Promise<ISO9660FileSystem> {\n        let best_vd: VolumeDescriptor | null = null;\n        for (let sector = 0x10;; sector++) {\n            let vd = new VolumeDescriptor(await sectorReader.readSector(sector));\n            switch (vd.type) {\n            case VDType.Primary:\n                if (!best_vd)\n                    best_vd = vd;\n                break;\n            case VDType.Supplementary:\n                if (vd.encoding())\n                    best_vd = vd;\n                break;\n            case VDType.Terminator:\n                if (!best_vd)\n                    throw new Error('PVD not found');\n                return new ISO9660FileSystem(sectorReader, best_vd);\n            }\n        }\n    }\n\n    private constructor(private sectorReader: Reader, private vd: VolumeDescriptor) {\n        this.decoder = new TextDecoder(vd.encoding());\n    }\n\n    volumeLabel(): string {\n        return this.vd.volumeLabel(this.decoder);\n    }\n\n    rootDir(): DirEnt {\n        return this.vd.rootDirEnt(this.decoder);\n    }\n\n    async getDirEnt(name: string, parent: DirEnt): Promise<DirEnt | null> {\n        name = name.toLowerCase();\n        for (let e of await this.readDir(parent)) {\n            if (e.name.toLowerCase() === name)\n                return e;\n        }\n        return null;\n    }\n\n    async readDir(dirent: DirEnt): Promise<DirEnt[]> {\n        let sector = dirent.sector;\n        let position = 0;\n        let length = dirent.size;\n        let entries: DirEnt[] = [];\n        let buf: ArrayBuffer;\n        while (position < length) {\n            if (position === 0)\n                buf = await this.sectorReader.readSector(sector);\n            let child = new DirEnt(buf!, position, this.decoder);\n            if (child.length === 0) {\n                // Padded end of sector\n                position = 2048;\n            } else {\n                entries.push(child);\n                position += child.length;\n            }\n            if (position > 2048)\n                throw new Error('dirent across sector boundary');\n            if (position === 2048) {\n                sector++;\n                position = 0;\n                length -= 2048;\n            }\n        }\n        return entries;\n    }\n\n    readFile(dirent: DirEnt): Promise<Uint8Array[]> {\n        return this.sectorReader.readSequentialSectors(dirent.sector, dirent.size);\n    }\n}\n\nenum VDType {\n    Primary = 1,\n    Supplementary = 2,\n    Terminator = 255\n}\n\nclass VolumeDescriptor {\n    private view: DataView;\n    constructor(private buf: ArrayBuffer) {\n        this.view = new DataView(buf);\n        if (ASCIIArrayToString(new Uint8Array(this.buf, 1, 5)) !== 'CD001')\n            throw new Error('Not a valid CD image');\n    }\n    get type(): number {\n        return this.view.getUint8(0);\n    }\n    volumeLabel(decoder: TextDecoder): string {\n        return decoder.decode(new DataView(this.buf, 40, 32)).trim();\n    }\n    encoding(): string | undefined {\n        if (this.type === VDType.Primary)\n            return 'shift_jis';\n        if (this.escapeSequence().match(/%\\/[@CE]/))\n            return 'utf-16be';  // Joliet\n        return undefined;\n    }\n    escapeSequence(): string {\n        return ASCIIArrayToString(new Uint8Array(this.buf, 88, 32)).trim();\n    }\n    rootDirEnt(decoder: TextDecoder): DirEnt {\n        return new DirEnt(this.buf, 156, decoder);\n    }\n}\n\nexport class DirEnt {\n    private view: DataView;\n    constructor(private buf: ArrayBuffer, private offset: number, private decoder: TextDecoder) {\n        this.view = new DataView(buf, offset);\n    }\n    get length(): number {\n        return this.view.getUint8(0);\n    }\n    get sector(): number {\n        return this.view.getUint32(2, true);\n    }\n    get size(): number {\n        return this.view.getUint32(10, true);\n    }\n    get isDirectory(): boolean {\n        return (this.view.getUint8(25) & 2) !== 0;\n    }\n    get name(): string {\n        let len = this.view.getUint8(32);\n        let name = new DataView(this.buf, this.offset + 33, len)\n        if (len === 1) {\n            switch (name.getUint8(0)) {\n            case 0:\n                return '.';\n            case 1:\n                return '..';\n            }\n        }\n        return this.decoder.decode(name).split(';')[0];\n    }\n}\n\nexport interface Reader {\n    readSector(sector: number): Promise<ArrayBuffer>;\n    readSequentialSectors(startSector: number, length: number): Promise<Uint8Array[]>;\n    maxTrack(): number;\n    extractTrack(track: number): Promise<Blob>;\n    reloadImage(): Promise<any>;\n}\n\nexport async function createReader(img: File, metadata?: File) {\n    if (img.name.endsWith('.iso')) {\n        return new IsoReader(img);\n    } else if (!metadata) {\n        throw new Error('No metadata file');\n    } else if (metadata.name.endsWith('.cue')) {\n        let reader = new ImgCueReader(img);\n        await reader.parseCue(metadata);\n        return reader;\n    } else if (metadata.name.endsWith('.ccd')) {\n        let reader = new ImgCueReader(img);\n        await reader.parseCcd(metadata);\n        return reader;\n    } else {\n        let reader = new MdfMdsReader(img);\n        await reader.parseMds(metadata);\n        return reader;\n    }\n}\n\nclass ImageReaderBase {\n    constructor(public image: File) { }\n\n    async readSequential(startOffset: number,\n                            bytesToRead: number,\n                            blockSize: number,\n                            sectorSize: number,\n                            sectorOffset: number): Promise<Uint8Array[]> {\n        let sectors = Math.ceil(bytesToRead / sectorSize);\n        let blob = this.image.slice(startOffset, startOffset + sectors * blockSize);\n        let buf = await readFileAsArrayBuffer(blob);\n        let bufs: Uint8Array[] = [];\n        for (let i = 0; i < sectors; i++) {\n            bufs.push(new Uint8Array(buf, i * blockSize + sectorOffset, Math.min(bytesToRead, sectorSize)));\n            bytesToRead -= sectorSize;\n        }\n        return bufs;\n    }\n\n    reloadImage(): Promise<any> {\n        return openFileInput().then((file) => {\n            this.image = file;\n        });\n    }\n}\n\nclass IsoReader extends ImageReaderBase implements Reader {\n    readSector(sector: number): Promise<ArrayBuffer> {\n        return readFileAsArrayBuffer(this.image.slice(sector * 2048, (sector + 1) * 2048));\n    }\n\n    async readSequentialSectors(startSector: number, length: number): Promise<Uint8Array[]> {\n        let start = startSector * 2048;\n        let buf = await readFileAsArrayBuffer(this.image.slice(start, start + length));\n        return [new Uint8Array(buf)];\n    }\n\n    maxTrack(): number {\n        return 1;\n    }\n\n    extractTrack(track: number): Promise<Blob> {\n        throw 'not implemented';\n    }\n}\n\nclass ImgCueReader extends ImageReaderBase implements Reader {\n    private tracks: Array<{ isAudio: boolean; index: number[]; }> = [];\n\n    constructor(img: File) {\n        super(img);\n    }\n\n    readSector(sector: number): Promise<ArrayBuffer> {\n        let start = sector * 2352 + 16;\n        let end = start + 2048;\n        return readFileAsArrayBuffer(this.image.slice(start, end));\n    }\n\n    readSequentialSectors(startSector: number, length: number): Promise<Uint8Array[]> {\n        return this.readSequential(startSector * 2352, length, 2352, 2048, 16);\n    }\n\n    async parseCue(cueFile: File) {\n        let lines = (await readFileAsText(cueFile)).split('\\n');\n        let currentTrack: number | null = null;\n        for (let line of lines) {\n            let fields = line.trim().split(/\\s+/);\n            switch (fields[0]) {\n                case 'TRACK':\n                    currentTrack = Number(fields[1]);\n                    this.tracks[currentTrack] = { isAudio: fields[2] === 'AUDIO', index: [] };\n                    break;\n                case 'INDEX':\n                    if (currentTrack)\n                        this.tracks[currentTrack].index[Number(fields[1])] = this.indexToSector(fields[2]);\n                    break;\n                default:\n                    // Do nothing\n            }\n        }\n    }\n\n    async parseCcd(ccdFile: File) {\n        let lines = (await readFileAsText(ccdFile)).split('\\n');\n        let currentTrack: number | null = null;\n        for (let line of lines) {\n            line = line.trim();\n            let match = line.match(/\\[TRACK ([0-9]+)\\]/);\n            if (match) {\n                currentTrack = Number(match[1]);\n                this.tracks[currentTrack] = { isAudio: false, index: [] };\n                continue;\n            }\n            if (!currentTrack)\n                continue;\n            let keyval = line.split(/=/);\n            switch (keyval[0]) {\n                case 'MODE':\n                    this.tracks[currentTrack].isAudio = keyval[1] === '0';\n                    break;\n                case 'INDEX 0':\n                    this.tracks[currentTrack].index[0] = Number(keyval[1]);\n                    break;\n                case 'INDEX 1':\n                    this.tracks[currentTrack].index[1] = Number(keyval[1]);\n                    break;\n                default:\n                    // Do nothing\n            }\n        }\n    }\n\n    maxTrack(): number {\n        return this.tracks.length - 1;\n    }\n\n    async extractTrack(track: number): Promise<Blob> {\n        if (!this.tracks[track] || !this.tracks[track].isAudio)\n            throw new Error('Invalid track ' + track);\n\n        let start = this.tracks[track].index[1] * 2352;\n        let end: number;\n        if (this.tracks[track + 1]) {\n            let index = this.tracks[track + 1].index[0] || this.tracks[track + 1].index[1];\n            end = index * 2352;\n        } else {\n            end = this.image.size;\n        }\n        return new Blob([\n            createWaveHeader(end - start),\n            this.image.slice(start, end)\n        ], { type: 'audio/wav' });\n    }\n\n    private indexToSector(index: string): number {\n        let msf = index.split(':').map(Number);\n        return msf[0] * 60 * 75 + msf[1] * 75 + msf[2];\n    }\n}\n\nenum MdsTrackMode { Audio = 0xa9, Mode1 = 0xaa }\n\nclass MdfMdsReader extends ImageReaderBase implements Reader {\n    private tracks: Array<{ mode: number; sectorSize: number; offset: number; sectors: number; }> = [];\n\n    constructor(mdf: File) {\n        super(mdf);\n    }\n\n    async parseMds(mdsFile: File) {\n        let buf = await readFileAsArrayBuffer(mdsFile);\n\n        let signature = ASCIIArrayToString(new Uint8Array(buf, 0, 16));\n        if (signature !== 'MEDIA DESCRIPTOR')\n            throw new Error(mdsFile.name + ': not a mds file');\n\n        let header = new DataView(buf, 0, 0x70);\n        let entries = header.getUint8(0x62);\n        if (0x70 + entries * 0x58 > buf.byteLength)\n            throw new Error(mdsFile.name + ': unknown format');\n\n        for (let i = 0; i < entries; i++) {\n            let trackData = new DataView(buf, 0x70 + i * 0x50, 0x50);\n            let extraData = new DataView(buf, 0x70 + entries * 0x50 + i * 8, 8);\n            let mode = trackData.getUint8(0x00);\n            let track = trackData.getUint8(0x04);\n            let sectorSize = trackData.getUint16(0x10, true);\n            let offset = trackData.getUint32(0x28, true); // >4GB offset is not supported.\n            let sectors = extraData.getUint32(0x4, true);\n            if (track < 100)\n                this.tracks[track] = { mode, sectorSize, offset, sectors };\n        }\n        if (this.tracks[1].mode !== MdsTrackMode.Mode1)\n            throw new Error('track 1 is not mode1');\n    }\n\n    readSector(sector: number): Promise<ArrayBuffer> {\n        let start = sector * this.tracks[1].sectorSize + 16;\n        let end = start + 2048;\n        return readFileAsArrayBuffer(this.image.slice(start, end));\n    }\n\n    readSequentialSectors(startSector: number, length: number): Promise<Uint8Array[]> {\n        let track = this.tracks[1];\n        return this.readSequential(track.offset + startSector * track.sectorSize,\n                                    length, track.sectorSize, 2048, 16);\n    }\n\n    maxTrack(): number {\n        return this.tracks.length - 1;\n    }\n\n    async extractTrack(track: number): Promise<Blob> {\n        if (!this.tracks[track] || this.tracks[track].mode !== MdsTrackMode.Audio)\n            throw new Error('Invalid track ' + track);\n\n        let size = this.tracks[track].sectors * 2352;\n        let chunks = await this.readSequential(this.tracks[track].offset, size,\n                                                this.tracks[track].sectorSize, 2352, 0);\n        return new Blob([<any>createWaveHeader(size)].concat(chunks), { type: 'audio/wav' });\n    }\n}\n\nfunction ASCIIArrayToString(buffer: Uint8Array): string {\n    return String.fromCharCode.apply(null, buffer as any);\n}\n\nfunction createWaveHeader(size: number): ArrayBuffer {\n    let buf = new ArrayBuffer(44);\n    let view = new DataView(buf);\n    view.setUint32(0, 0x52494646, false); // 'RIFF'\n    view.setUint32(4, size + 36, true); // filesize - 8\n    view.setUint32(8, 0x57415645, false); // 'WAVE'\n    view.setUint32(12, 0x666D7420, false); // 'fmt '\n    view.setUint32(16, 16, true); // size of fmt chunk\n    view.setUint16(20, 1, true); // PCM format\n    view.setUint16(22, 2, true); // stereo\n    view.setUint32(24, 44100, true); // sampling rate\n    view.setUint32(28, 176400, true); // bytes/sec\n    view.setUint16(32, 4, true); // block size\n    view.setUint16(34, 16, true); // bit/sample\n    view.setUint32(36, 0x64617461, false); // 'data'\n    view.setUint32(40, size, true); // data size\n    return buf;\n}\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport { DRIType, ald_getdata, isMobileSafari } from './util.js';\n\nexport interface CDDALoaderSource {\n    extractTrack(track: number): Promise<Blob>;\n}\n\nexport class CDDALoader {\n    private cache: string[];\n    private lastTrack: number | undefined;\n\n    constructor(private source: CDDALoaderSource) {\n        this.cache = [];\n        document.addEventListener('visibilitychange', this.onVisibilityChange.bind(this));\n\n        // Delete the CDDA cache created by (now removed) IOSCDDALoader.\n        if (isMobileSafari()) {\n            indexedDB.deleteDatabase('cdda');\n        }\n    }\n\n    async getCDDA(track: number): Promise<string> {\n        if (!this.cache[track]) {\n            const blob = await this.source.extractTrack(track);\n            this.cache[track] = URL.createObjectURL(blob);\n        }\n        this.lastTrack = track;\n        return this.cache[track];\n    }\n\n    private onVisibilityChange() {\n        if (!document.hidden)\n            return;\n        for (let i = 0; i < this.cache.length; i++) {\n            if (i !== this.lastTrack && this.cache[i])\n                URL.revokeObjectURL(this.cache[i]);\n        }\n        const newCache: string[] = [];\n        if (this.lastTrack)\n            newCache[this.lastTrack] = this.cache[this.lastTrack];\n        this.cache = newCache;\n    }\n}\n\nexport class BGMLoader implements CDDALoaderSource {\n    async extractTrack(track: number): Promise<Blob> {\n        const buf = ald_getdata(DRIType.BGM, track - 1);\n        if (!buf)\n            throw new Error('BGMLoader: Invalid track ' + track);\n        return new Blob([buf]);\n    }\n}\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {urlParams} from './util.js';\n\nconst major = 240;\nlet entryCount = 0;\n\ntype PatchTable = [number, number, number][]; // addr, old, new\n\n// See xsystem35-sdl2/patch/README.TXT\nconst PastelChimePatch: PatchTable = [\n    [0x1c68, 0x54, 0x47]\n];\n\nconst TADAModePatch: PatchTable = [\n    [0x0087b, 0x40, 0x41],\n    [0x01b79, 0x40, 0x41],\n    [0x16e5f, 0x24, 0x40],\n    [0x16e60, 0xae, 0x92],\n    [0x16e61, 0x06, 0x05]\n];\n\nexport function registerDataFile(fname: string, size: number, chunks: Uint8Array[]) {\n    let patch: PatchTable | null = null;;\n    switch (fname.toUpperCase()) {\n    case 'ぱすてるSA.ALD':\n        patch = PastelChimePatch;\n        break;\n    case '鬼畜王SA.ALD':\n        if (urlParams.get('tada') === '1')\n            patch = TADAModePatch;\n        break;\n    }\n\n    const path = '/' + fname;\n    if (fname.match(/\\.(ald|ain|alk|kld)$/i)) {\n        // Put the file content in the WASM memory space, so that it won't\n        // consume additional heap space when mmaped.\n        const dev = FS.makedev(major, entryCount++);\n        const ops = new NodeOps(size, chunks, patch);\n        FS.registerDevice(dev, ops);\n        FS.mkdev(path, dev);\n    } else {\n        // Store as a regular file.\n        var f = FS.open(path, 'w');\n        for (const chunk of chunks) {\n            FS.write(f, chunk, 0, chunk.byteLength);\n        }\n        FS.close(f);\n    }\n}\n\nclass NodeOps {\n    private addr: number | undefined;\n    private chunks: Uint8Array[] | null\n\n    constructor(private size: number, chunks: Uint8Array[], private patchTbl: PatchTable | null) {\n        this.chunks = chunks;\n    }\n\n    read(stream: any, buffer: Int8Array, offset: number, length: number, position: number): number {\n        if (buffer !== Module.HEAP8)\n            throw new Error('Invalid argument');\n        if (this.addr === undefined)\n            this.load();\n        let src = this.addr! + position;\n        length = Math.min(length, this.size - position);\n        // load() might have invalidated `buffer`, so use Module.HEAP8 directly\n        Module.HEAP8.set(Module.HEAPU8.subarray(src, src + length), offset);\n        return length;\n    }\n\n    llseek(stream: any, offset: number, whence: number): number {\n        let position = offset;\n        if (whence === 1)  // SEEK_CUR\n            position += stream.position;\n        else if (whence === 2)  // SEEK_END\n            position += this.size;\n        return position;\n    }\n\n    mmap() {\n        if (this.addr === undefined)\n            this.load();\n        return { ptr: this.addr, allocated: false };\n    }\n\n    private load() {\n        let ptr = this.addr = Module._malloc(this.size);\n        for (let c of this.chunks!) {\n            Module.HEAPU8.set(c, ptr);\n            ptr += c.byteLength;\n        }\n        this.chunks = null;\n        this.patch();\n    }\n\n    private patch() {\n        if (!this.patchTbl)\n            return;\n        for (let a of this.patchTbl) {\n            if (Module.HEAPU8[this.addr! + a[0]] !== a[1]) {\n                console.log('Patch failed');\n                return;\n            }\n        }\n        for (let a of this.patchTbl)\n            Module.HEAPU8[this.addr! + a[0]] = a[2];\n        console.log('Patch applied');\n        this.patchTbl = null;\n    }\n}\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$, startMeasure, mkdirIfNotExist, readFileAsArrayBuffer, loadScript, JSZIP_SCRIPT, JSZipOptions} from './util.js';\nimport * as cdimage from './cdimage.js';\nimport {CDDALoader, BGMLoader} from './cddaloader.js';\nimport {registerDataFile} from './datafile.js';\nimport {loadModule, saveDirReady} from './moduleloader.js';\nimport {message} from './strings.js';\n\nexport class NoGamedataError implements Error {\n    public name = 'NoGamedataError';\n    constructor(public message: string) {}\n\n    toString() {\n        return this.name + ': ' + this.message;\n    }\n}\n\nexport abstract class LoaderSource {\n    protected abstract createCDDALoader(): CDDALoader;\n    protected abstract doLoad(): Promise<void>;\n\n    public hasMidi = false;\n    private hasBGM = false;\n    private aldFiles: string[] | null = null;\n\n    async startLoad() {\n        await this.doLoad();\n        this.createGr();\n    }\n\n    getCDDALoader(): CDDALoader {\n        if (this.hasBGM)\n            return new CDDALoader(new BGMLoader());\n        return this.createCDDALoader();\n    }\n\n    protected async loadSystem3(savedir: string) {\n        await loadModule('system3');\n        Module.arguments.push('-savedir', savedir);\n        saveDirReady.then(() => { mkdirIfNotExist(savedir.replace(/\\/@$/, '')); });\n    }\n\n    protected async loadXsystem35() {\n        await loadModule('xsystem35');\n        this.aldFiles = [];\n    }\n\n    protected addFile(fname: string, size: number, chunks: Uint8Array[]) {\n        registerDataFile(fname, size, chunks);\n        this.aldFiles?.push(fname);\n    }\n\n    private createGr() {\n        if (!this.aldFiles) {\n            return;\n        }\n        const resourceType: { [ch: string]: string } = {\n            b: 'BGM', d: 'Data', g: 'Graphics', m: 'Midi', r: 'Resource', s: 'Scenario', w: 'Wave',\n        };\n        let basename = '';\n        let lines: string[] = [];\n        for (let name of this.aldFiles) {\n            if (name.toLowerCase() === 'system39.ain') {\n                lines.push('Ain ' + name);\n                continue;\n            }\n            if (!name.toLowerCase().endsWith('.ald')) {\n                continue;\n            }\n            let type = name.charAt(name.length - 6).toLowerCase();\n            let id = name.charAt(name.length - 5);\n            basename = name.slice(0, -6);\n            if (!resourceType[type]) {\n                console.log('Resource file of unknown type: ' + name);\n                continue;\n            }\n            lines.push(resourceType[type] + id.toUpperCase() + ' ' + name);\n            if (type == 'm')\n                this.hasMidi = true;\n            if (type == 'b')\n                this.hasBGM = true;\n        }\n        for (let i = 0; i < 26; i++) {\n            let id = String.fromCharCode(65 + i);\n            lines.push('Save' + id + ' save/' + basename + 's' + id.toLowerCase() + '.asd');\n        }\n        lines.push(`MsgSkip save/${basename}.msgskip`);\n        FS.writeFile('xsystem35.gr', lines.join('\\n') + '\\n');\n    }\n}\n\nexport class CDImageSource extends LoaderSource {\n    private imageReader!: cdimage.Reader;\n\n    constructor(private imageFile: File, private metadataFile: File | undefined, private patchFiles: File[]) {\n        super();\n    }\n\n    protected async doLoad() {\n        this.imageReader = await cdimage.createReader(this.imageFile, this.metadataFile);\n        let isofs = await cdimage.ISO9660FileSystem.create(this.imageReader);\n        // this.walk(isofs, isofs.rootDir(), '/');\n        let gamedata = await this.findGameDir(isofs);\n        if (!gamedata)\n            throw new NoGamedataError(message.no_gamedata_dir);\n\n        let isSystem3 = !!await isofs.getDirEnt('system3.exe', gamedata);\n        if (isSystem3) {\n            await this.loadSystem3(await this.saveDir(isofs));\n        } else {\n            await this.loadXsystem35();\n        }\n\n        let endMeasure = startMeasure('ImageLoad', 'Image load', this.imageFile.name);\n        for (let e of await isofs.readDir(gamedata)) {\n            if (this.patchFiles.some((f) => f.name.toLowerCase() === e.name.toLowerCase()))\n                continue;\n            if (isSystem3) {\n                if (!e.name.toLowerCase().endsWith('.dat'))\n                    continue;\n            } else {\n                if (e.name.match(/^\\.|\\.(exe|dll|txt|ini)$/i))\n                    continue;\n            }\n            let em = startMeasure(e.name);\n            let chunks = await isofs.readFile(e);\n            em();\n            this.addFile(e.name, e.size, chunks);\n        }\n        for (let f of this.patchFiles) {\n            let content = await readFileAsArrayBuffer(f);\n            this.addFile(f.name, f.size, [new Uint8Array(content)]);\n        }\n        endMeasure();\n    }\n\n    createCDDALoader(): CDDALoader {\n        return new CDDALoader(this.imageReader);\n    }\n\n    private async findGameDir(isofs: cdimage.ISO9660FileSystem): Promise<cdimage.DirEnt | null> {\n        for (let e of await isofs.readDir(isofs.rootDir())) {\n            if (e.isDirectory) {\n                if (e.name.toLowerCase() === 'gamedata' || await isofs.getDirEnt('adisk.dat', e))\n                    return e;\n            }\n            if (e.name.toLowerCase() === 'adisk.dat')\n                return isofs.rootDir();\n        }\n        return null;\n    }\n\n    private async saveDir(isofs: cdimage.ISO9660FileSystem): Promise<string> {\n        let dirname = isofs.volumeLabel();\n        if (!dirname) {\n            if (await isofs.getDirEnt('prog.bat', isofs.rootDir())) {\n                dirname = 'ProG';\n            } else if (await isofs.getDirEnt('dps_all.bat', isofs.rootDir())) {\n                dirname = 'DPS_all';\n            } else {\n                dirname = 'untitled';\n                ga('send', 'event', 'Loader', 'NoVolumeLabel');\n            }\n        }\n        return '/save/' + dirname;\n    }\n\n    // For debug\n    private async walk(isofs: cdimage.ISO9660FileSystem, dir: cdimage.DirEnt, dirname: string) {\n        for (let e of await isofs.readDir(dir)) {\n            if (e.name !== '.' && e.name !== '..') {\n                console.log(dirname + e.name);\n                if (e.isDirectory)\n                    this.walk(isofs, e, dirname + e.name + '/');\n            }\n        }\n    }\n}\n\nexport class FileSource extends LoaderSource {\n    private tracks: File[] = [];\n    private files: File[] = []\n\n    constructor(fs: FileList) {\n        super()\n        for (let i = 0; i < fs.length; i++) {\n            this.files.push(fs[i]);\n        }\n    }\n\n    protected async doLoad() {\n        if (this.files.some(f => f.name.toLowerCase() === 'adisk.dat')) {\n            await this.loadSystem3('/save/@');\n        } else {\n            await this.loadXsystem35();\n        }\n        for (let f of this.files) {\n            let match = /(\\d+)\\.(wav|mp3|ogg)$/.exec(f.name.toLowerCase());\n            if (match) {\n                this.tracks[Number(match[1])] = f;\n                continue;\n            }\n            let content = await readFileAsArrayBuffer(f);\n            this.addFile(f.name, f.size, [new Uint8Array(content)]);\n        }\n    }\n\n    createCDDALoader(): CDDALoader {\n        return new CDDALoader(this);\n    }\n\n    async extractTrack(track: number): Promise<Blob> {\n        if (!this.tracks[track])\n            throw new Error('FileSource: Invalid track ' + track);\n        return this.tracks[track];\n    }\n}\n\nexport class ZipSource extends LoaderSource {\n    private tracks: JSZipObject[] = [];\n\n    constructor(private zipFile: File) {\n        super();\n    }\n\n    protected async doLoad() {\n        await loadScript(JSZIP_SCRIPT);\n        const zip = new JSZip();\n        await zip.loadAsync(await readFileAsArrayBuffer(this.zipFile), JSZipOptions());\n\n        const dataFiles = zip.file(/\\.(ald|ain|dat|mda|ttf|otf|ini|xsys35rc)$/i);\n        if (dataFiles.length === 0) {\n            const msg = zip.file(/\\.(d88|dsk|hdm|xdf)$/i).length > 0 ?\n                message.floppy_images_cant_be_used : message.no_ald_in_zip;\n            throw new NoGamedataError(msg);\n        }\n        if (zip.file(/adisk.dat/i).length > 0) {\n            await this.loadSystem3('/save/@');\n        } else {\n            await this.loadXsystem35();\n        }\n\n        for (const f of dataFiles) {\n            const content: ArrayBuffer = await zip.files[f.name].async('arraybuffer');\n            const basename = f.name.split('/').pop()!;\n            this.addFile(basename, content.byteLength, [new Uint8Array(content)]);\n        }\n        for (const f of zip.file(/\\d+\\.(wav|mp3|ogg)$/i)) {\n            const n = Number(/(\\d+)\\.\\w+$/.exec(f.name)![1]);\n            this.tracks[n] = f;\n        }\n    }\n\n    createCDDALoader(): CDDALoader {\n        return new CDDALoader(this);\n    }\n\n    async extractTrack(track: number): Promise<Blob> {\n        if (!this.tracks[track])\n            throw new Error('ZipSource: Invalid track ' + track);\n        return this.tracks[track].async('blob');\n    }\n}\n\ntype SevenZipWorkerResponse = { files: { name: string, content: Uint8Array }[] } | { error: string };\nexport class SevenZipSource extends LoaderSource {\n    private tracks: Blob[] = [];\n\n    constructor(private file: File) {\n        super();\n    }\n\n    protected async doLoad() {\n        const worker = new Worker('worker/archiveworker.js');\n        worker.postMessage({ file: this.file });\n        $('#loader').classList.add('module-loading');  // Show the spinner\n        const e = await new Promise<MessageEvent<SevenZipWorkerResponse>>((resolve) => {\n            worker.addEventListener('message', (e) => resolve(e));\n        });\n        if ('error' in e.data) {\n            $('#loader').classList.remove('module-loading');\n            throw new Error(e.data.error);\n        }\n        const { files } = e.data;\n        if (files.some(f => f.name.toLowerCase() === 'adisk.dat')) {\n            await this.loadSystem3('/save/@');\n        } else {\n            await this.loadXsystem35();\n        }\n\n        for (const f of files) {\n            let match = /(\\d+)\\.(wav|mp3|ogg)$/i.exec(f.name);\n            if (match) {\n                this.tracks[Number(match[1])] = new Blob([f.content]);\n                continue;\n            }\n            this.addFile(f.name, f.content.byteLength, [f.content]);\n        }\n    }\n\n    createCDDALoader(): CDDALoader {\n        return new CDDALoader(this);\n    }\n\n    async extractTrack(track: number): Promise<Blob> {\n        if (!this.tracks[track])\n            throw new Error('SevenZipSource: Invalid track ' + track);\n        return this.tracks[track];\n    }\n}\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$, Deferred, gaException, isMobileSafari} from './util.js';\nimport {CDDALoader} from './cddaloader.js';\nimport * as volumeControl from './volume.js';\n\nconst audio = <HTMLAudioElement>$('audio');\nlet cddaLoader: CDDALoader | undefined;\nlet currentTrack: number | null = null;\nlet isVolumeSupported: boolean;\nlet fadeVolume = 1.0;\nlet fader: Fader | undefined;\nlet unmute: (() => void) | null = null;  // Non-null if emulating mute by pause\n\nclass Fader {\n    private done: Deferred<void>;\n    private timer: number | undefined;\n\n    constructor(duration: number, target: number) {\n        const start = performance.now();\n        const initial = fadeVolume;\n        this.done = new Deferred();\n        this.timer = setInterval(() => {\n            const t = performance.now() - start;\n            fadeVolume = t >= duration ? target : initial + (t / duration) * (target - initial);\n            audio.volume = volumeControl.volume() * fadeVolume;\n            if (t >= duration) {\n                clearInterval(this.timer);\n                this.timer = undefined;\n                this.done.resolve();\n            }\n        }, 10);\n    }\n\n    cancel() {\n        clearInterval(this.timer);\n        this.timer = undefined;\n        this.done.resolve();\n    }\n\n    wait(): Promise<void> {\n        return this.done.promise;\n    }\n}\n\nfunction init() {\n    // Volume control of <audio> is not supported in iOS\n    isVolumeSupported = !isMobileSafari();\n\n    volumeControl.addEventListener(onVolumeChanged);\n    audio.volume = volumeControl.volume();\n    audio.addEventListener('error', onAudioError);\n    removeUserGestureRestriction(true);\n    if (!isVolumeSupported) {\n        volumeControl.hideSlider();\n        if (audio.volume === 0)\n            unmute = () => {};\n    }\n}\n\nexport function setCDDALoader(loader: CDDALoader) {\n    cddaLoader = loader;\n}\n\nexport async function play(track: number, loop: number) {\n    currentTrack = track;\n    if (unmute) {\n        unmute = () => { play(track, loop); };\n        return;\n    }\n    audio.currentTime = 0;\n    try {\n        const url = await cddaLoader!.getCDDA(track)\n        startPlayback(url, loop);\n    } catch (err) {\n        ga('send', 'event', 'CDDA', 'InvalidTrack');\n    }\n}\n\nexport async function stop(fadeout_ms?: number) {\n    if (fadeout_ms) {\n        await fade(fadeout_ms, 0);\n    }\n    audio.pause();\n    currentTrack = null;\n    if (unmute)\n        unmute = () => {};\n}\n\nexport async function fade(duration: number, target: number): Promise<void> {\n    if (!isVolumeSupported) {\n        return;\n    }\n    if (fader) {\n        fader.cancel();\n        fader = undefined;\n    }\n    if (duration <= 0) {\n        fadeVolume = target;\n        audio.volume = volumeControl.volume() * fadeVolume;\n        return;\n    }\n    fader = new Fader(duration, target);\n    return fader.wait();\n}\n\nexport function getPosition(): number {\n    if (!currentTrack)\n        return 0;\n    let time = Math.round(audio.currentTime * 75);\n    if (unmute || audio.error)\n        time += 750;  // unblock Kichikuou OP\n    return currentTrack | time << 8;\n}\n\nfunction startPlayback(url: string, loop: number) {\n    audio.setAttribute('src', url);\n    audio.loop = (loop !== 0);\n    audio.load();\n    audio.play().catch((err) => {\n        if (err.message.startsWith('The play() request was interrupted') ||  // Chrome\n            err.name === 'AbortError') {  // Safari\n            // These errors are harmless, do nothing\n        } else if (err.name === 'NotAllowedError' || err.message.indexOf('gesture') >= 0) {\n            // Audio still locked?\n            removeUserGestureRestriction(false);\n            ga('send', 'event', 'CDDA', 'UnlockAgain');\n        } else {\n            let {name, message} = err;\n            gaException({type: 'CDDA', name, message});\n        }\n    });\n}\n\nfunction onVolumeChanged(evt: CustomEvent) {\n    if (isVolumeSupported) {\n        audio.volume = evt.detail;\n        return;\n    }\n    let muted = evt.detail === 0;\n    if (!!unmute === muted)\n        return;\n    if (muted) {\n        audio.pause();\n        unmute = () => { audio.play(); };\n    } else {\n        let f = unmute!;\n        unmute = null;\n        f();\n    }\n}\n\nfunction onAudioError(err: ErrorEvent) {\n    if (audio.error) {\n        let {code, message} = audio.error;\n        gaException({type: 'Audio', code, message});\n    } else {\n        gaException({type: 'Audio', code: 'unknown'});\n    }\n}\n\nfunction removeUserGestureRestriction(firstTime: boolean) {\n    let hanlder = () => {\n        if (!firstTime) {\n            audio.play();\n        } else if (!currentTrack) {\n            audio.load();\n            console.log('CDDA unlocked');\n        }\n        window.removeEventListener('touchend', hanlder);\n        window.removeEventListener('mouseup', hanlder);\n    };\n    window.addEventListener('touchend', hanlder);\n    window.addEventListener('mouseup', hanlder);\n}\n\ninit();\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$} from './util.js';\nimport {config} from './config.js';\n\nconst slider = <HTMLInputElement>$('#volume-control-slider');\nlet audioContext: AudioContext;\nlet masterGain: GainNode;\nlet vol = config.volume;  // 0.0 - 1.0\nlet muted = false;\n\nfunction init() {\n    slider.value = String(Math.round(vol * 100));\n\n    $('#volume-control-icon').addEventListener('click', onIconClicked);\n    slider.addEventListener('input', onSliderValueChanged);\n    slider.addEventListener('change', onSliderValueSettled);\n    // Firefox fix, https://github.com/emscripten-ports/SDL2/issues/41\n    slider.addEventListener('mouseup', () => {slider.blur()});\n\n    audioContext = new AudioContext();\n    removeUserGestureRestriction();  // For Safari\n    masterGain = audioContext.createGain();\n    masterGain.connect(audioContext.destination);\n    addEventListener(onVolumeChanged);\n    masterGain.gain.value = volume();\n\n    document.addEventListener('gamestart', () => {\n        document.addEventListener('keydown', keyDownHandler);\n    });\n}\n\nexport function audioNode(): AudioNode {\n    return masterGain;\n}\n\nfunction removeUserGestureRestriction() {\n    let handler = () => {\n        let src = audioContext.createBufferSource();\n        src.buffer = audioContext.createBuffer(1, 1, 22050);\n        src.connect(audioContext.destination);\n        src.start();\n        console.log('AudioContext unlocked');\n        window.removeEventListener('touchend', handler);\n        window.removeEventListener('mouseup', handler);\n    };\n    window.addEventListener('touchend', handler);\n    window.addEventListener('mouseup', handler);\n}\n\nexport function volume(): number {\n    return muted ? 0 : parseInt(slider.value, 10) / 100;\n}\n\nexport function addEventListener(handler: (evt: CustomEvent) => any) {\n    $('#volume-control').addEventListener('volumechange', handler as any);\n}\n\nexport function hideSlider() {\n    slider.hidden = true;\n}\n\nexport function suspendForModalDialog() {\n    audioContext.suspend();\n    setTimeout(() => audioContext.resume(), 0);\n}\n\nfunction onIconClicked(e: Event) {\n    muted = !muted;\n    if (muted) {\n        $('#volume-control-icon').classList.remove('fa-volume-up');\n        $('#volume-control-icon').classList.add('fa-volume-off');\n        slider.value = '0';\n    } else {\n        $('#volume-control-icon').classList.remove('fa-volume-off');\n        $('#volume-control-icon').classList.add('fa-volume-up');\n        slider.value = String(Math.round(vol * 100));\n    }\n    dispatchEvent();\n}\n\nfunction onSliderValueChanged(e: Event) {\n    vol = parseInt(slider.value, 10) / 100;\n    if (vol > 0 && muted) {\n        muted = false;\n        $('#volume-control-icon').classList.remove('fa-volume-off');\n        $('#volume-control-icon').classList.add('fa-volume-up');\n    }\n    dispatchEvent();\n}\n\nfunction onSliderValueSettled(e: Event) {\n    config.volume = vol;\n    config.persist();\n}\n\nfunction dispatchEvent() {\n    let event = new CustomEvent('volumechange', { detail: volume() });\n    $('#volume-control').dispatchEvent(event);\n}\n\nfunction onVolumeChanged(evt: CustomEvent) {\n    masterGain.gain.value = evt.detail;\n}\n\nfunction keyDownHandler(e: KeyboardEvent) {\n    if (e.keyCode === 77) { // m\n        onIconClicked(e);\n    }\n}\n\ninit();\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {loadScript} from './util.js';\n\ndeclare class Timidity {\n    constructor(dst: AudioNode, baseurl?: string);\n    load(urlOrBuf: string | Uint8Array): Promise<void>;\n    play(): void;\n    pause(): void;\n    on(event: 'playing', callback: (playbackTime: number) => void): void;\n    on(event: 'error', callback: (err: Error) => void): void;\n    on(event: string, callback: () => void): void;\n    currentTime: number;\n}\n\nlet timidity: Timidity | undefined;\nlet gain!: GainNode;\nlet playing = false;\nlet fadeFinishTime = 0;\nlet stopTimer: number | null = null;\n\nexport function init(destNode: AudioNode) {\n    Module.addRunDependency('timidity');\n    loadScript('/timidity/timidity.js').then(() => {\n        gain = destNode.context.createGain();\n        gain.connect(destNode);\n        timidity = new Timidity(gain, '/timidity/');\n        timidity.on('playing', onPlaying);\n        timidity.on('error', onError);\n        timidity.on('ended', onEnd);\n        Module.removeRunDependency('timidity');\n    });\n}\n\nexport function play(loop: number, data: number, datalen: number) {\n    if (!timidity)\n        return;\n    timidity.load(Module.HEAPU8.slice(data, data + datalen));\n    timidity.play();\n    playing = true;\n    // NOTE: `loop` is ignored.\n}\n\nexport function stop() {\n    if (!timidity)\n        return;\n    playing = false;\n    timidity.pause();\n}\n\nexport function pause() {\n    if (!timidity)\n        return;\n    timidity.pause();\n}\n\nexport function resume() {\n    if (!timidity)\n        return;\n    timidity.play();\n}\n\nexport function getPosition(): number {\n    if (!timidity)\n        return 0;\n    return Math.round(timidity.currentTime * 1000);\n}\n\nexport function setVolume(vol: number) {\n    if (!timidity)\n        return;\n    gain.gain.value = vol / 100;\n}\n\nexport function getVolume(): number {\n    if (!timidity)\n        return 100;\n    return gain.gain.value * 100;\n}\n\nexport function fadeStart(ms: number, vol: number, stopAfterFade: number) {\n    if (!timidity)\n        return;\n    // Cancel previous fade\n    gain.gain.cancelScheduledValues(gain.context.currentTime);\n    if (stopTimer !== null) {\n        clearTimeout(stopTimer);\n        stopTimer = null;\n    }\n\n    // Resetting the volume while not playing?\n    if (ms === 0 && vol === 100 && (stopTimer || !playing)) {\n        // No worries, playback always starts with volume 100%\n        return;\n    }\n\n    gain.gain.linearRampToValueAtTime(vol / 100, gain.context.currentTime + ms / 1000);\n    fadeFinishTime = performance.now() + ms;\n    if (stopAfterFade) {\n        if (ms === 0)\n            stop();\n        else {\n            stopTimer = setTimeout(() => {\n                stop();\n                stopTimer = null;\n            }, ms);\n        }\n    }\n}\n\nexport function isFading(): number {\n    if (!timidity)\n        return 0;\n    return performance.now() < fadeFinishTime ? 1 : 0;\n}\n\nfunction onPlaying(playbackTime: number) {\n    if (!playbackTime)\n        return;\n    // Reset volume to 100% at the start of playback\n    gain.gain.setValueAtTime(1, playbackTime);\n}\n\nfunction onError(err: Error) {\n    console.warn(err);\n    ga('send', 'event', 'MIDI', err.message);\n}\n\nfunction onEnd() {\n    if (playing)\n        timidity!.play();\n}\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$} from './util.js';\nimport {config} from './config.js';\nimport {LoaderSource, CDImageSource, FileSource, ZipSource, SevenZipSource, NoGamedataError} from './loadersource.js';\nimport {setCDDALoader} from './cdda.js';\nimport {addToast} from './widgets.js';\nimport * as midiPlayer from './midi.js';\nimport * as volumeControl from './volume.js';\nimport {message} from './strings.js';\n\nlet imageFile: File | undefined;\nlet metadataFile: File | undefined;\nlet patchFiles: File[] = [];\nlet installing = false;\n\nfunction init() {\n    $('#fileselect').addEventListener('change', handleFileSelect, false);\n    document.body.ondragover = handleDragOver;\n    document.body.ondrop = handleDrop;\n}\n\nfunction handleFileSelect(evt: Event) {\n    let input = <HTMLInputElement>evt.target;\n    handleFiles(input.files!);\n    input.value = '';\n}\n\nfunction handleDragOver(evt: DragEvent) {\n    evt.stopPropagation();\n    evt.preventDefault();\n    evt.dataTransfer!.dropEffect = 'copy';\n}\n\nfunction handleDrop(evt: DragEvent) {\n    evt.stopPropagation();\n    evt.preventDefault();\n    handleFiles(evt.dataTransfer!.files);\n}\n\nasync function handleFiles(files: FileList) {\n    if (installing || files.length === 0)\n        return;\n\n    let hasALD = false;\n    let recognized = false;\n    for (let file of files) {\n        if (isImageFile(file)) {\n            imageFile = file;\n            $('#imgReady').classList.remove('notready');\n            $('#imgReady').textContent = file.name;\n            recognized = true;\n        } else if (isMetadataFile(file)) {\n            metadataFile = file;\n            $('#cueReady').classList.remove('notready');\n            $('#cueReady').textContent = file.name;\n            recognized = true;\n        } else if (file.name.match(/\\.(ald|ain)$/i) || file.name.toLowerCase() === 'adisk.dat') {\n            hasALD = true;\n            patchFiles.push(file);\n        }\n    }\n\n    let source: LoaderSource | null = null;\n    if (imageFile && (metadataFile || imageFile.name.toLowerCase().endsWith('.iso'))) {\n        source = new CDImageSource(imageFile, metadataFile, patchFiles);\n    } else if (!imageFile && !metadataFile) {\n        if (files.length == 1 && files[0].name.toLowerCase().endsWith('.zip')) {\n            source = new ZipSource(files[0]);\n        } else if (files.length == 1 && files[0].name.match(/\\.(rar|7z)$/i)) {\n            source = new SevenZipSource(files[0]);\n        } else if (files.length > 2 && hasALD) {\n            source = new FileSource(files);\n        }\n    }\n\n    if (!source) {\n        if (!recognized)\n            addToast(`${files[0].name}: ${message.unrecognized_format}`, 'warning');\n        return;\n    }\n\n    installing = true;\n    try {\n        await source.startLoad();\n        setCDDALoader(source.getCDDALoader());\n        loaded(source.hasMidi);\n    } catch (err) {\n        if (err instanceof NoGamedataError) {\n            ga('send', 'event', 'Loader', 'NoGamedata', err.message);\n            addToast(`${message.cannot_install}: ${err.message}`, 'warning');\n        } else if (err instanceof Error) {\n            ga('send', 'event', 'Loader', 'LoadFailed', err.message);\n            addToast(`${message.cannot_install}: ${message.unrecognized_format}`, 'warning');\n        }\n    }\n    installing = false;\n}\n\nfunction isImageFile(file: File): boolean {\n    let name = file.name.toLowerCase();\n    return name.endsWith('.img') || name.endsWith('.mdf') || name.endsWith('.iso');\n}\n\nfunction isMetadataFile(file: File): boolean {\n    let name = file.name.toLowerCase();\n    return name.endsWith('.cue') || name.endsWith('.ccd') || name.endsWith('.mds');\n}\n\nfunction loaded(hasMidi: boolean) {\n    if (hasMidi)\n        midiPlayer.init(volumeControl.audioNode());\n    $('#xsystem35').hidden = false;\n    document.body.classList.add('game');\n    $('#toolbar').classList.remove('before-game-start');\n    window.onbeforeunload = onBeforeUnload;\n    setTimeout(() => {\n        Module.arguments.push(config.antialias ? '-antialias' : '-noantialias');\n        Module.arguments.push('-fm');\n        Module.removeRunDependency('gameFiles');\n        document.dispatchEvent(new Event('gamestart'));\n    }, 0);\n}\n\nfunction onBeforeUnload(e: BeforeUnloadEvent) {\n    if (config.unloadConfirmation) {\n        e.returnValue = message.unload_confirmation;\n        volumeControl.suspendForModalDialog();\n    }\n}\n\ninit();\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$} from './util.js';\nimport {config} from './config.js';\n\nconst canvas = <HTMLCanvasElement>$('#canvas');\nconst zoomSelect = <HTMLInputElement>$('#zoom');\nconst pixelateCheckbox = <HTMLInputElement>$('#pixelate');\nlet throttling = false;\n\nfunction init() {\n    zoomSelect.addEventListener('change', handleZoom);\n    zoomSelect.value = config.zoom;\n    if (CSS.supports('image-rendering', 'pixelated') || CSS.supports('image-rendering', '-moz-crisp-edges')) {\n        pixelateCheckbox.addEventListener('change', handlePixelate);\n        if (config.pixelate) {\n            pixelateCheckbox.checked = true;\n            handlePixelate();\n        }\n    } else {\n        pixelateCheckbox.setAttribute('disabled', 'true');\n    }\n    if (screen.orientation) {\n        screen.orientation.addEventListener('change', () => {\n            if (screen.orientation.type.startsWith('landscape'))\n                requestFullscreen();\n            else\n                exitFullscreen();\n        });\n    }\n    window.addEventListener('resize', onResize);\n}\n\nexport function handleZoom() {\n    let value = zoomSelect.value;\n    config.zoom = value;\n    config.persist();\n    let navbarStyle = $('.navbar').style;\n    if (value === 'fit') {\n        $('#xsystem35').classList.add('fit');\n        navbarStyle.maxWidth = 'none';\n        canvas.style.width = '';\n    } else {\n        $('#xsystem35').classList.remove('fit');\n        let ratio = Number(value);\n        navbarStyle.maxWidth = canvas.style.width = canvas.width * ratio + 'px';\n    }\n}\n\nfunction onResize() {\n    if (throttling)\n        return;\n    throttling = true;\n    window.requestAnimationFrame(() => {\n        recalcAspectRatio();\n        throttling = false;\n    });\n}\n\nexport function recalcAspectRatio() {\n    let container = $('.contents');\n    let target = $('#xsystem35');\n    let containerAspect = container.offsetWidth / container.offsetHeight;\n    if (!containerAspect)\n        return;\n    let canvasAspect = canvas.width / canvas.height;\n    if (containerAspect < canvasAspect) {\n        target.classList.add('letterbox');\n        target.classList.remove('pillarbox');\n    } else {\n        target.classList.remove('letterbox');\n        target.classList.add('pillarbox');\n    }\n}\n\nfunction handlePixelate() {\n    config.pixelate = pixelateCheckbox.checked;\n    config.persist();\n    if (pixelateCheckbox.checked)\n        canvas.classList.add('pixelated');\n    else\n        canvas.classList.remove('pixelated');\n}\n\nfunction requestFullscreen() {\n    let e = document.documentElement;\n    if (e.requestFullscreen)\n        e.requestFullscreen();\n    else if ((e as any).webkitRequestFullScreen)\n        (e as any).webkitRequestFullScreen();\n}\n\nfunction exitFullscreen() {\n    if (document.exitFullscreen) {\n        if ((document as any).fullscreenElement)\n            document.exitFullscreen();\n    } else if ((document as any).webkitExitFullscreen) {\n        if ((document as any).webkitFullscreenElement)\n            (document as any).webkitExitFullscreen();\n    }\n}\n\ninit();\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {gaException, Bool, Status, DRIType, ald_getdata, loadScript} from './util.js';\nimport * as volumeControl from './volume.js';\n\ndeclare global {\n    interface BaseAudioContext {\n        resume(): Promise<void>;  // Missing in lib.dom.d.ts of TypeScript 3.6.2\n    }\n}\n\nconst slots: (PCMSound | null)[] = [];\nlet bufCache: AudioBuffer[] = [];\nconst destNode = volumeControl.audioNode();\n\nfunction init() {\n    document.addEventListener('visibilitychange', onVisibilityChange);\n}\n\nasync function load(no: number): Promise<AudioBuffer> {\n    const buf = ald_getdata(DRIType.WAVE, no - 1);\n    if (!buf)\n        throw new Error('Failed to open wave ' + no);\n\n    // If the AudioContext was not created inside a user-initiated event\n    // handler, then it will be suspended. Attempt to resume it.\n    destNode.context.resume();\n\n    const audioBuf = await decodeAudioData(buf);\n    bufCache[no] = audioBuf;\n    return audioBuf;\n}\n\nasync function decodeAudioData(buf: ArrayBuffer): Promise<AudioBuffer> {\n    try {\n        return await destNode.context.decodeAudioData(buf);\n    } catch (err) {\n        const a = new Uint8Array(buf);\n        if (a[0] === 0x4f && a[1] === 0x67 && a[2] === 0x67 && a[3] === 0x53) { // 'OggS'\n            await loadScript('lib/stbvorbis-0.2.2.js');\n            const data: Float32Array[][] = [];\n            let sampleRate = 0;\n            return new Promise((resolve, reject) => {\n                stbvorbis.decode(buf, (event) => {\n                    if (event.error) {\n                        reject(event.error);\n                    } else if (!event.eof) {\n                        if (data.length === 0) sampleRate = event.sampleRate;\n                        data.push(event.data);\n                    } else {\n                        const nr_channels = data[0].length;\n                        const len = data.reduce((sum, channels) => sum + channels[0].length, 0);\n                        const audioBuf = destNode.context.createBuffer(nr_channels, len, sampleRate);\n                        for (let ch = 0; ch < nr_channels; ch++) {\n                            const b = audioBuf.getChannelData(ch);\n                            let offset = 0;\n                            for (const chunks of data) {\n                                b.set(chunks[ch], offset);\n                                offset += chunks[ch].length;\n                            }\n                        }\n                        resolve(audioBuf);\n                    }\n                });\n            });\n        }\n        throw err;\n    }\n}\n\nexport function pcm_reset() {\n    for (let i = 0; i < slots.length; i++) {\n        pcm_unload(i);\n    }\n}\n\nexport function pcm_load(slot: number, no: number) {\n    return Asyncify.handleSleep((wakeUp: (result: Status) => void) => {\n        pcm_stop(slot);\n        if (bufCache[no]) {\n            slots[slot] = new PCMSoundSimple(destNode, bufCache[no]);\n            return wakeUp(Status.OK);\n        }\n        load(no).then((audioBuf) => {\n            slots[slot] = new PCMSoundSimple(destNode, audioBuf);\n            wakeUp(Status.OK);\n        }, (err) => {\n            gaException({type: 'PCM', err});\n            wakeUp(Status.NG);\n        });\n    });\n}\n\nexport function pcm_load_mixlr(slot: number, noL: number, noR: number) {\n    return Asyncify.handleSleep((wakeUp: (result: Status) => void) => {\n        pcm_stop(slot);\n        if (bufCache[noL] && bufCache[noR]) {\n            slots[slot] = new PCMSoundMixLR(destNode, bufCache[noL], bufCache[noR]);\n            return wakeUp(Status.OK);\n        }\n        let ps: [Promise<AudioBuffer>, Promise<AudioBuffer>] = [\n            bufCache[noL] ? Promise.resolve(bufCache[noL]) : load(noL),\n            bufCache[noR] ? Promise.resolve(bufCache[noR]) : load(noR),\n        ];\n        Promise.all(ps).then((bufs) => {\n            slots[slot] = new PCMSoundMixLR(destNode, bufs[0], bufs[1]);\n            wakeUp(Status.OK);\n        }).catch((err) => {\n            gaException({type: 'PCM', err});\n            wakeUp(Status.NG);\n        });\n    });\n}\n\nexport function pcm_unload(slot: number): Status {\n    let sound = slots[slot];\n    if (!sound)\n        return Status.NG;\n    sound.stop();\n    slots[slot] = null;\n    return Status.OK;\n}\n\nexport function pcm_start(slot: number, loop: number): Status {\n    let sound = slots[slot];\n    if (!sound) {\n        console.log('pcm_start: invalid slot', slot);\n        return Status.NG;\n    }\n    sound.start(loop);\n    return Status.OK;\n}\n\nexport function pcm_stop(slot: number): Status {\n    let sound = slots[slot];\n    if (!sound)\n        return Status.NG;\n    sound.stop();\n    if (slot === 0)  // slot 0 plays at most once\n        slots[slot] = null;\n    return Status.OK;\n}\n\nexport function pcm_fadeout(slot: number, msec: number): Status {\n    let sound = slots[slot];\n    if (!sound)\n        return Status.NG;\n    sound.fadeout(msec);\n    return Status.OK;\n}\n\nexport function pcm_getpos(slot: number): number {\n    let sound = slots[slot];\n    if (!sound)\n        return 0;\n    return sound.getPosition() * 1000;\n}\n\nexport function pcm_setvol(slot: number, vol: number): Status {\n    let sound = slots[slot];\n    if (!sound)\n        return Status.NG;\n    sound.setGain(vol / 100);\n    return Status.OK;\n}\n\nexport function pcm_getwavelen(slot: number): number {\n    let sound = slots[slot];\n    if (!sound)\n        return 0;\n    return sound.duration * 1000;\n}\n\nexport function pcm_isplaying(slot: number): Bool {\n    let sound = slots[slot];\n    if (!sound)\n        return Bool.FALSE;\n    return sound.isPlaying() ? Bool.TRUE : Bool.FALSE;\n}\n\nexport function pcm_waitend(slot: number) {\n    return Asyncify.handleSleep((wakeUp: (result: Status) => void) => {\n        let sound = slots[slot];\n        if (!sound || !sound.isPlaying())\n            return wakeUp(Status.OK);\n        sound.end_callback = () => wakeUp(Status.OK);\n    });\n}\n\nfunction onVisibilityChange() {\n    if (document.hidden)\n        bufCache = [];\n}\n\nabstract class PCMSound {\n    end_callback: (() => void) | null = null;\n    protected context: BaseAudioContext;\n    protected gain: GainNode;\n    protected startTime: number | null = null;\n\n    constructor(protected dst: AudioNode) {\n        this.context = dst.context;\n        this.gain = this.context.createGain();\n        this.gain.connect(dst);\n    }\n    abstract start(loop: number): void;\n    abstract stop(): void;\n    setGain(gain: number) {\n        this.gain.gain.value = gain;\n    }\n    fadeout(msec: number) {\n        this.gain.gain.linearRampToValueAtTime(0, this.context.currentTime + msec / 1000);\n    }\n    getPosition(): number {\n        if (this.startTime === null)\n            return 0;\n        return this.context.currentTime - this.startTime;\n    }\n    isPlaying(): boolean {\n        return this.startTime !== null;\n    }\n    abstract get duration(): number;\n\n    protected ended() {\n        this.startTime = null;\n        if (this.end_callback) {\n            this.end_callback();\n            this.end_callback = null;\n        }\n    }\n}\n\nclass PCMSoundSimple extends PCMSound {\n    private node!: AudioBufferSourceNode;\n\n    constructor(dst: AudioNode, private buf: AudioBuffer) {\n        super(dst);\n    }\n\n    start(loop: number) {\n        this.node = this.context.createBufferSource();\n        this.node.buffer = this.buf;\n        this.node.connect(this.gain);\n        this.node.onended = this.onended.bind(this);\n        if (loop !== 1)\n            this.node.loop = true;\n        if (loop <= 1)\n            this.node.start();\n        else\n            this.node.start(0, 0, this.buf.duration * loop);\n        this.startTime = this.context.currentTime;\n    }\n\n    stop() {\n        if (this.startTime !== null) {\n            this.node.stop();\n            this.startTime = null;\n        }\n    }\n\n    get duration() {\n        return this.buf.duration;\n    }\n\n    private onended() {\n        this.ended();\n    }\n}\n\nclass PCMSoundMixLR extends PCMSound {\n    private lsrc: AudioBufferSourceNode;\n    private rsrc: AudioBufferSourceNode;\n    private endCount = 0;\n\n    constructor(dst: AudioNode, lbuf: AudioBuffer, rbuf: AudioBuffer) {\n        super(dst);\n        this.lsrc = this.context.createBufferSource();\n        this.rsrc = this.context.createBufferSource();\n        this.lsrc.buffer = lbuf;\n        this.rsrc.buffer = rbuf;\n        let merger = this.context.createChannelMerger(2);\n        merger.connect(this.gain);\n        this.lsrc.connect(merger, 0, 0);\n        this.rsrc.connect(merger, 0, 1);\n        this.lsrc.onended = this.rsrc.onended = this.onended.bind(this);\n    }\n\n    start(loop: number) {\n        if (loop !== 1)\n            console.warn('PCMSoundMixLR: loop is not supported ' + loop);\n        this.lsrc.start();\n        this.rsrc.start();\n        this.startTime = this.context.currentTime;\n    }\n\n    stop() {\n        if (this.startTime !== null) {\n            this.lsrc.stop();\n            this.rsrc.stop();\n            this.startTime = null;\n        }\n    }\n\n    get duration() {\n        return Math.max(this.lsrc.buffer!.duration, this.rsrc.buffer!.duration);\n    }\n\n    private onended() {\n        this.endCount++;\n        if (this.endCount === 2)\n            this.ended();\n    }\n}\n\nlet scriptNode: ScriptProcessorNode;\n\nexport function enable_audio_hook(): number {\n    if (!scriptNode) {\n        const BUFSIZE = 4096;\n        scriptNode = destNode.context.createScriptProcessor(BUFSIZE, 0, 2);\n        let bufptr = Module._malloc(BUFSIZE * 2 * 2);\n        scriptNode.addEventListener('audioprocess', (event) => {\n            const output0 = event.outputBuffer.getChannelData(0);\n            const output1 = event.outputBuffer.getChannelData(1);\n            if (_audio_callback(bufptr, BUFSIZE)) {\n                for (let i = 0; i < BUFSIZE; i++) {\n                    output0[i] = Module.HEAP16[(bufptr >> 1) + i * 2] / 0x8000;\n                    output1[i] = Module.HEAP16[(bufptr >> 1) + i * 2 + 1] / 0x8000;\n                }\n            } else {\n                for (let i = 0; i < BUFSIZE; i++) {\n                    output0[i] = output1[i] = 0;\n                }\n            }\n        });\n        scriptNode.connect(destNode);\n    }\n    // If the AudioContext was not created inside a user-initiated event\n    // handler, then it will be suspended. Attempt to resume it.\n    scriptNode.context.resume();\n\n    return scriptNode.context.sampleRate;\n}\n\ninit();\n", "// Copyright (c) 2019 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$, urlParams} from './util.js';\n\nconst textLogMaxLines = 2000;\n\n// Ignore mouse wheel events on the game canvas up to this timestamp.\nlet wheelIgnoreTime = 0;\n\n// Text from these scenario pages won't be shown in the text log.\nconst quietPagesTable: [RegExp | string, number[]][] = [\n    ['ＲＡＮＣＥ', [2]],\n    ['ＲＡＮＣＥ２', [2]],\n    ['Ｒａｎｃｅ３', [1]],\n    [/^(Ｒａｎｃｅ４　－教団の遺産－　Ｆｏｒ　Ｗｉｎ９５|Rance4 -Legacy of the Sect- For Win95)$/,\n     [10, 11, 16, 88, 90]],\n    ['ランス 4.1 〜お薬工場を救え！〜', [6]],\n    ['ランス 4.2 〜エンジェル組〜', [7]],\n    [/^(鬼畜王ランス|Kichikuou Rance)$/, [7, 11, 15, 16, 17, 18, 23, 24, 32, 33, 197]],\n    ['闘神都市', [1]],\n    ['闘神都市Ⅱ　ｆｏｒ　Ｗｉｎ９５', [4, 5, 6, 7, 8]],\n    ['あゆみちゃん物語', [6]],\n    [/^グレイメルカ ver1\\./, [1, 2, 5, 6]],\n];\n\nconst textlogContent = $('#textlog-content');\n\n$('#textlog-button').addEventListener('click', openTextLog);\n$('#textlog-close').addEventListener('click', closeTextLog);\n$('#textlog-overlay').addEventListener('click', closeTextLog);\n\ndocument.addEventListener('gamestart', () => {\n    document.addEventListener('keydown', (e: KeyboardEvent) => {\n        if (e.keyCode === 76) { // l\n            openTextLog();\n        } else if (e.keyCode === 27) { // esc\n            closeTextLog();\n        }\n    });\n});\n\n$('#canvas').addEventListener('wheel', (e: WheelEvent) => {\n    // Do not open text log if the game is actively checking mouse wheel state.\n    if (performance.now() < wheelIgnoreTime) {\n        return;\n    }\n    if (e.deltaY <= 0) {\n        openTextLog();\n    }\n});\n\ntextlogContent.addEventListener('wheel', (e: WheelEvent) => {\n    if (e.deltaY > 0 && textlogContent.scrollTop + textlogContent.clientHeight >= textlogContent.scrollHeight) {\n        closeTextLog();\n    }\n});\n\nfunction openTextLog() {\n    const classes = $('#textlog-modal').classList;\n    if (classes.contains('active')) {\n        return;\n    }\n    render(textlogContent);\n    classes.add('active');\n    textlogContent.scrollTop = textlogContent.scrollHeight;\n}\n\nfunction closeTextLog() {\n    $('#textlog-modal').classList.remove('active');\n}\n\nlet currentPage = -1;\nlet linebuf = '';\nlet lines: string[] = [];\nlet quietPages: number[] = [];\nlet consoleLog = urlParams.get('consoleTextLog') === '1';\n\nexport function message(s: string, page: number) {\n    if (linebuf === '')\n        currentPage = page;\n    linebuf += s;\n}\n\nexport function newline() {\n    if (linebuf !== '') {\n        if (!skiplog(currentPage)) {\n            if (consoleLog)\n                console.log(currentPage + ': ' + linebuf);\n            addLine(linebuf);\n        }\n        linebuf = '';\n    }\n}\n\nexport function nextpage() {\n    newline();\n    if (lines[lines.length - 1] !== '') {\n        if (consoleLog)\n            console.log('');\n        addLine('');\n    }\n}\n\nexport function keywait() {\n    newline();\n}\n\nfunction render(e: HTMLElement) {\n    e.textContent = lines.join('\\n');\n}\n\nexport function setTitle(title: string) {\n    for (const [pattern, pages] of quietPagesTable) {\n        if (pattern instanceof RegExp ? pattern.test(title) : pattern === title) {\n            quietPages = pages;\n            return;\n        }\n    }\n    quietPages = [];\n}\n\nfunction addLine(s: string) {\n    lines.push(s);\n    if (lines.length > textLogMaxLines)\n        lines.shift();\n}\n\nfunction skiplog(page: number) {\n    return quietPages.includes(page);\n}\n\nexport function disableWheelEvent(duration: number) {\n    wheelIgnoreTime = performance.now() + duration;\n}\n", "// Copyright (c) 2017 Kichikuou <KichikuouChrome@gmail.com>\n// This source code is governed by the MIT License, see the LICENSE file.\nimport {$, gaException, Status} from './util.js';\nimport './settings.js';\nimport './loader.js';\nimport {syncfs, load_mincho_font} from './moduleloader.js';\nimport * as zoom from './zoom.js';\nimport * as cdPlayer from './cdda.js';\nimport * as audio from './audio.js';\nimport * as midiPlayer from './midi.js';\nimport * as toolbar from './toolbar.js';\nimport * as texthook from './textlog.js';\nimport {addToast} from './widgets.js';\nimport {message} from './strings.js';\n\nclass System35Shell {\n    constructor() {\n        const message_ = message;\n        window.onerror = (message, url, line, column, error) => {\n            const address = scenario_address();\n            gaException({type: 'onerror', message, url, line, column, address}, true);\n            addToast(message_.error_occurred, 'error');\n            window.onerror = null;\n        };\n        window.addEventListener('unhandledrejection', (evt: any) => {\n            const reason = evt.reason;\n            const address = scenario_address();\n            console.log(address, reason);\n            if (reason instanceof Error) {\n                let {name, message, stack} = reason;\n                gaException({type: 'rejection', name, message, stack, address}, true);\n                if (name === 'RuntimeError') {\n                    addToast(message_.error_occurred, 'error');\n                }\n            } else {\n                gaException({type: 'rejection', name: reason.constructor.name, reason, address}, true);\n            }\n        });\n    }\n\n    windowSizeChanged() {\n        zoom.handleZoom();\n        zoom.recalcAspectRatio();\n    }\n\n    setWindowTitle(title: string) {\n        let colon = title.indexOf(':');\n        if (colon !== -1) {\n            title = title.slice(colon + 1).trim();\n            texthook.setTitle(title);\n            $('.navbar-brand').textContent = title;\n            ga('set', 'dimension1', title);\n            ga('send', 'event', 'Game', 'GameStart', title);\n        }\n    }\n\n    inputString(title: string, initialValue: string, maxLength: number): string | null {\n        title += ' (' + message.input_char_limit(maxLength) + ')';\n        let result = window.prompt(title, initialValue);\n        if (result) {\n            result = result.substring(0, maxLength);\n        }\n        return result;\n    }\n\n    inputNumber(title: string, min: number, max: number, initial: number): number {\n        title += ` (${min}-${max})`;\n        const s = window.prompt(title, initial + '');\n        if (s) {\n            const val = parseInt(s);\n            if (min <= val && val <= max)\n                return val;\n        }\n        return -1;\n    }\n\n    setSkipButtonState(enabled: number, activated: number) {\n        toolbar.setSkipButtonState(enabled, activated);\n    }\n\n    quit() {\n        addToast(message.game_over);\n        ga('send', 'event', 'Game', 'GameEnd');\n        window.onbeforeunload = null;\n    }\n\n    syncfs(timeout = 100) {\n        syncfs(timeout);\n    }\n}\n\nfunction scenario_address(): string | undefined {\n    if (!window['_nact_current_page']) return undefined;\n    return _nact_current_page() + ':' + _nact_current_addr().toString(16);\n}\n\nlet shell = new System35Shell();\n\nlet xsystem35 = {Status, shell, cdPlayer, midiPlayer, audio, texthook, load_mincho_font};\n(window as any).xsystem35 = xsystem35;\n\nif (typeof WebAssembly !== 'object') {\n    document.getElementById('unsupported')!.hidden = false;\n}\n\nif ('serviceWorker' in navigator) {\n    window.addEventListener('load', () => {\n        navigator.serviceWorker.register('service-worker.js');\n    });\n}\n\nwindow.addEventListener('beforeinstallprompt', (e: any) => {\n    e.userChoice.then((choiceResult: any) => {\n        ga('send', 'event', 'App', 'InstallPrompt', choiceResult.outcome);\n    });\n});\n"],
  "mappings": "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",
  "names": []
}
