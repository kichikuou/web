var rr=Object.defineProperty;var ee=(r,e)=>{for(var t in e)rr(r,t,{get:e[t],enumerable:!0})};var o=document.querySelector.bind(document),T=new URLSearchParams(location.search.slice(1)),_="lib/jszip.3.1.3.min.js",lt=new Map;function w(r){let e=lt.get(r);if(!e){let t=document.createElement("script");t.src=r,e=new Promise((n,i)=>{t.addEventListener("load",n,{once:!0}),t.addEventListener("error",i,{once:!0})}),document.body.appendChild(t),lt.set(r,e)}return e}function d(r){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=()=>{t(n.error)},n.readAsArrayBuffer(r)})}function be(r){return new Promise((e,t)=>{let n=new FileReader;n.onload=()=>{e(n.result)},n.onerror=()=>{t(n.error)},n.readAsText(r)})}function te(r,e){try{(e||FS).mkdir(r)}catch(t){}}function re(r,e){let t=navigator.userAgent.match(/OS ([0-9_]+) like Mac OS X\)/);if(!t)return!1;let n=t[1].replace(/_/g,".");return(!r||r<=n)&&(!e||n<e)}function ne(){let r={};return typeof TextDecoder!="undefined"&&(r={decodeFileName:e}),r;function e(t){try{return new TextDecoder("utf-8",{fatal:!0}).decode(t)}catch(n){return new TextDecoder("shift_jis",{fatal:!0}).decode(t)}}}var we=class{constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}};function M(r,e,t){let n=r+"-start",i=r+"-end";return performance.mark(n),()=>{if(performance.mark(i),performance.measure(r,n,i),e){let a=performance.getEntriesByName(r)[0].duration;ga("send","timing",e,t,Math.round(a))}}}function p(r,e=!1){let t=JSON.stringify(r,(n,i)=>i instanceof DOMException?{DOMException:i.name,message:i.message}:i);ga("send","exception",{exDescription:t,exFatal:e})}var G=(t=>(t[t.OK=0]="OK",t[t.NG=-1]="NG",t))(G||{});function ie(r,e){let t=_ald_getdata(r,e);if(!t)return null;let n=Module.getValue(t+8,"*"),i=Module.getValue(t,"i32"),a=Module.HEAPU8.buffer.slice(n,n+i);return _ald_freedata(t),a}var ct=class{constructor(){this.antialias=!0;this.pixelate=!1;this.unloadConfirmation=!0;this.volume=1;this.zoom="fit";this.messageSkipFlags=14;let e=localStorage.getItem("KichikuouWeb.Config");if(e){let t=JSON.parse(e);t.antialias!==void 0&&(this.antialias=t.antialias),t.pixelate!==void 0&&(this.pixelate=t.pixelate),t.unloadConfirmation!==void 0&&(this.unloadConfirmation=t.unloadConfirmation),t.volume!==void 0&&(this.volume=t.volume),t.zoom!==void 0&&(this.zoom=t.zoom),t.messageSkipFlags!=null&&(this.messageSkipFlags=t.messageSkipFlags)}}persist(){localStorage.setItem("KichikuouWeb.Config",JSON.stringify({antialias:this.antialias,pixelate:this.pixelate,unloadConfirmation:this.unloadConfirmation,volume:this.volume,zoom:this.zoom,messageSkipFlags:this.messageSkipFlags}))}},c=new ct;function v(r,e){let t=o(".toast-container"),n=document.createElement("div");n.classList.add("toast"),e&&n.classList.add("toast-"+e),typeof r=="string"?n.innerText=r:n.appendChild(r);let i=document.createElement("button");i.setAttribute("class","btn btn-clear float-right");function a(){n.parentNode===t&&t.removeChild(n)}i.addEventListener("click",a);let s=e?{success:5e3,warning:1e4,error:null}[e]:5e3;return s&&setTimeout(a,s),n.insertBefore(i,n.firstChild),t.insertBefore(n,t.firstChild),n}function ae(){return new Promise(r=>{let e=document.createElement("input");e.type="file",e.addEventListener("change",t=>{document.body.removeChild(e),r(e.files[0])}),e.style.display="none",document.body.appendChild(e),e.click()})}function oe(r,e,t){let n=document.createElement("a");n.setAttribute("download",r),n.setAttribute("href",e),t&&n.setAttribute("target",t),document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n)},5e3)}var ut={cannot_install:"Cannot install",game_over:"The game is over.",import_savedata_confirm:"Import save files from Kichikuou on Chrome?",input_char_limit:r=>`Up to ${r} characters`,module_load_failed:r=>`Failed to load ${r}. Please reload the page.`,no_ald_in_zip:"No game files (*.ALD/*.DAT) in the zip file.",no_gamedata_dir:"No GAMEDATA folder in the image.",restart_confirmation:"Restart the game?",restore_success:"Save files has been restored successfully.",restore_failure:"Save files could not be restored.",unload_confirmation:"Unsaved data will be lost.",unrecognized_format:"Unrecognized format."},nr={cannot_install:"インストールできません",game_over:"ゲームは終了しました。",import_savedata_confirm:"鬼畜王 on Chrome のセーブデータを引き継ぎますか?",input_char_limit:r=>`全角${r}文字まで`,module_load_failed:r=>r+"の読み込みに失敗しました。リロードしてください。",no_ald_in_zip:"ZIP内にゲームデータ (*.ALD/*.DATファイル) が見つかりません。",no_gamedata_dir:"イメージ内にGAMEDATAフォルダが見つかりません。",restart_confirmation:"ゲームを再起動しますか？",restore_success:"セーブデータの復元に成功しました。",restore_failure:"セーブデータを復元できませんでした。",unload_confirmation:"セーブしていないデータは失われます。",unrecognized_format:"認識できない形式です。"},dt={en:ut,ja:nr};function ir(){let r=document.documentElement.getAttribute("lang");return r&&dt[r]?dt[r]:ut}var u=ir();var se=o("#msgskip-button");function ar(){o("#restart-button").addEventListener("click",gt),o("#screenshot-button").addEventListener("click",vt),se.addEventListener("click",ht),document.addEventListener("gamestart",()=>{document.addEventListener("keydown",sr)})}function ft(){o("#toolbar-handler").addEventListener("click",or),o("#toolbar-close-button").addEventListener("click",mt),o("#toolbar").classList.add("closeable"),mt()}function or(){o("#toolbar").classList.remove("closed")}function mt(){o("#toolbar").classList.add("closed")}function sr(r){switch(r.keyCode){case 80:vt();break;case 82:gt();break;case 83:ht();break}}function pt(r,e){se.classList.toggle("disabled",!r),se.classList.toggle("activated",!!e)}function ht(){_msgskip_activate(se.classList.contains("activated")?0:1)}function gt(){window.confirm(u.restart_confirmation)&&(ga("send","event","Toolbar","Restart"),_sys_restart())}async function vt(){let r=_sdl_getDisplaySurface(),e=document.createElement("canvas");e.width=Module.canvas.width,e.height=Module.canvas.height;let t=e.getContext("2d"),n=t.createImageData(e.width,e.height),i=n.data,a=n.data.length;for(let l=0;l<a;l+=4)i[l]=Module.HEAPU8[r+2],i[l+1]=Module.HEAPU8[r+1],i[l+2]=Module.HEAPU8[r],i[l+3]=255,r+=4;t.putImageData(n,0,0);let s=await new Promise(l=>e.toBlob(l));!s||oe(lr(),URL.createObjectURL(s),"_blank")}function lr(){let r=new Date,e=("0"+(r.getMonth()+1)).slice(-2),t=("0"+r.getDate()).slice(-2),n=("0"+r.getHours()).slice(-2),i=("0"+r.getMinutes()).slice(-2),a=("0"+r.getSeconds()).slice(-2);return"Screenshot-"+r.getFullYear()+e+t+"-"+n+i+a+".png"}ar();var wt="MTLc3m.ttf",ye="mincho.otf",Et,cr=new Promise(r=>{Et=r}),At,le=new Promise(r=>{At=r});function dr(){window.Module={},Module.arguments=[];for(let[r,e]of T)r.startsWith("-")&&(Module.arguments.push(r),e&&Module.arguments.push(e));Module.print=Module.printErr=console.log.bind(console),Module.canvas=document.getElementById("canvas"),Module.preRun=[()=>{Module.addRunDependency("gameFiles")},Et,function(){FS.mkdir("/fonts"),FS.createPreloadedFile("/fonts",wt,"fonts/"+wt,!0,!1)},function(){FS.mkdir("/save"),FS.mount(IDBFS,{},"/save"),Module.addRunDependency("syncfs"),FS.syncfs(!0,e=>{mr().then(()=>{Module.removeRunDependency("syncfs"),At(FS)})})},()=>{window.setWindowTitle=()=>{}}]}function xe(r){o("#loader").classList.add("module-loading");let e=r+".js",t=document.createElement("script");t.src=e,t.onerror=()=>{ga("send","event","Game","ModuleLoadFailed",e),v(u.module_load_failed(e),"error")},document.body.appendChild(t);let n=M("ModuleLoad","Module load",e);return cr.then(()=>{n(),o("#loader").hidden=!0,document.body.classList.add("bgblack-fade"),ft()})}var yt;function Se(r){window.clearTimeout(yt),yt=window.setTimeout(()=>{FS.syncfs(!1,e=>{e&&console.log("FS.syncfs error: ",e)})},r),ur()}var xt=!1;async function ur(){if(xt||!(navigator.storage&&navigator.storage.persist)||(xt=!0,await navigator.storage.persisted()))return;let r=await navigator.storage.persist();ga("send","event","Game","StoragePersist",r?"granted":"refused")}var St=!1;function Dt(){return St?Promise.resolve(0):(St=!0,new Promise(r=>{console.log("loading mincho font");let e=M("FontLoad","Font load",ye);readAsync("fonts/"+ye,t=>{e(),FS.writeFile("/fonts/"+ye,new Uint8Array(t)),r(0)},()=>{r(-1)})}))}async function mr(){function r(i,a){return new Promise((s,l)=>window.webkitRequestFileSystem(i,a,s,l))}function e(i,a){return new Promise((s,l)=>i.getDirectory(a,{},s,l))}function t(i){return new Promise((a,s)=>i.readEntries(a,s))}function n(i){return new Promise((a,s)=>i.file(a,s))}if(!(FS.readdir("/save").length>2)&&!!window.webkitRequestFileSystem)try{let i=await r(self.PERSISTENT,0),a=(await e(i.root,"save")).createReader(),s=[];for(;;){let l=await t(a);if(!l.length)break;for(let g of l)g.isFile&&g.name.toLowerCase().endsWith(".asd")&&s.push(g)}if(s.length&&window.confirm(u.import_savedata_confirm)){for(let l of s){let g=await d(await n(l));FS.writeFile("/save/"+l.name,new Uint8Array(g))}Se(0),ga("send","event","Game","SaveDataImported")}}catch(i){}}dr();var Ee=class{constructor(){window.FS&&(this.FSready=le),this.FSready||(this.FSready=(async()=>(await w("fslib.js"),(await FSLib()).saveDirReady))()),w(_)}hasSaveData(){function e(t,n){if(!t.isDir(t.stat(n).mode))return!1;for(let i of t.readdir(n))if(i[0]!=="."&&(i.toLowerCase().endsWith(".asd")||i.toLowerCase().endsWith(".dat")||e(t,n+"/"+i)))return!0;return!1}return this.FSready.then(t=>e(t,"/save"))}async download(){await w(_);let e=new JSZip;Lt(await this.FSready,"/save",e.folder("save"));let t=await e.generateAsync({type:"blob",compression:"DEFLATE"});oe("savedata.zip",URL.createObjectURL(t)),ga("send","event","Savedata","Downloaded")}async extract(e){try{let t=await this.FSready;if(e.name.toLowerCase().endsWith(".asd"))kt(t,"/save/"+e.name,await d(e));else{await w(_);let n=new JSZip;await n.loadAsync(await d(e),ne());let i=[];n.folder("save").forEach((a,s)=>{i.push(s)});for(let a of i)a.dir?te("/"+a.name.slice(0,-1),t):kt(t,"/"+a.name,await a.async("arraybuffer"))}await new Promise((n,i)=>{t.syncfs(!1,a=>{a?i(a):n(void 0)})}),v(u.restore_success,"success"),ga("send","event","Savedata","Restored")}catch(t){v(u.restore_failure,"error"),ga("send","event","Savedata","RestoreFailed",t.message),console.warn(t),ga("send","exception",{exDescription:t.stack,exFatal:!1})}}};function Lt(r,e,t){for(let n of r.readdir(e)){let i=e+"/"+n;if(n[0]!=="."){if(r.isDir(r.stat(i).mode))Lt(r,i,t.folder(n));else if(!n.toLowerCase().endsWith(".asd.")){let a=r.readFile(i,{encoding:"binary"});t.file(n,a)}}}}function kt(r,e,t){r.writeFile(e,new Uint8Array(t))}var De=o("#antialias"),ke=o("#unload-confirmation"),ce={"#msgskip-skip-unseen":1,"#msgskip-stop-on-unseen":2,"#msgskip-stop-on-menu":4,"#msgskip-stop-on-click":8},W=null,Le;function fr(){o("#settings-button").addEventListener("click",hr),o("#settings-close").addEventListener("click",Ae),Le=r=>{r.keyCode===27&&Ae()},o("#settings-overlay").addEventListener("click",Ae),De.addEventListener("change",gr),De.checked=c.antialias,ke.addEventListener("change",vr),ke.checked=c.unloadConfirmation;for(let r in ce){let e=o(r);e.addEventListener("change",Ct),e.checked=!!(c.messageSkipFlags&ce[r])}o("#msgskip-stop-on-unseen").toggleAttribute("disabled",o("#msgskip-skip-unseen").checked),o("#downloadSaveData").addEventListener("click",br),o("#uploadSaveData").addEventListener("click",wr),document.addEventListener("gamestart",pr)}function pr(){Ct()}function hr(){o("#settings-modal").classList.add("active"),document.addEventListener("keydown",Le),W=new Ee,Ft()}function Ae(){o("#settings-modal").classList.remove("active"),document.removeEventListener("keydown",Le),W=null}function gr(){c.antialias=De.checked,c.persist(),o("#xsystem35").hidden||_ags_setAntialiasedStringMode(c.antialias?1:0)}function vr(){c.unloadConfirmation=ke.checked,c.persist()}function Ct(){let r=0;for(let e in ce)o(e).checked&&(r|=ce[e]);o("#msgskip-stop-on-unseen").toggleAttribute("disabled",o("#msgskip-skip-unseen").checked),window._msgskip_setFlags&&_msgskip_setFlags(r,4294967295),c.messageSkipFlags=r,c.persist()}async function Ft(){o("#downloadSaveData").hasAttribute("disabled")&&await W.hasSaveData()&&o("#downloadSaveData").removeAttribute("disabled")}async function br(){W.download()}function wr(){ae().then(r=>W.extract(r)).then(()=>Ft())}fr();var H=class{constructor(e,t){this.sectorReader=e;this.vd=t;this.decoder=new TextDecoder(t.encoding())}static async create(e){let t=null;for(let n=16;;n++){let i=new Pt(await e.readSector(n));switch(i.type){case de.Primary:t||(t=i);break;case de.Supplementary:i.encoding()&&(t=i);break;case de.Terminator:if(!t)throw new Error("PVD not found");return new H(e,t)}}}volumeLabel(){return this.vd.volumeLabel(this.decoder)}rootDir(){return this.vd.rootDirEnt(this.decoder)}async getDirEnt(e,t){e=e.toLowerCase();for(let n of await this.readDir(t))if(n.name.toLowerCase()===e)return n;return null}async readDir(e){let t=e.sector,n=0,i=e.size,a=[],s;for(;n<i;){n===0&&(s=await this.sectorReader.readSector(t));let l=new Pe(s,n,this.decoder);if(l.length===0?n=2048:(a.push(l),n+=l.length),n>2048)throw new Error("dirent across sector boundary");n===2048&&(t++,n=0,i-=2048)}return a}readFile(e){return this.sectorReader.readSequentialSectors(e.sector,e.size)}},de=(n=>(n[n.Primary=1]="Primary",n[n.Supplementary=2]="Supplementary",n[n.Terminator=255]="Terminator",n))(de||{}),Pt=class{constructor(e){this.buf=e;if(this.view=new DataView(e),Fe(new Uint8Array(this.buf,1,5))!=="CD001")throw new Error("Not a valid CD image")}get type(){return this.view.getUint8(0)}volumeLabel(e){return e.decode(new DataView(this.buf,40,32)).trim()}encoding(){if(this.type===1)return"shift_jis";if(this.escapeSequence().match(/%\/[@CE]/))return"utf-16be"}escapeSequence(){return Fe(new Uint8Array(this.buf,88,32)).trim()}rootDirEnt(e){return new Pe(this.buf,156,e)}},Pe=class{constructor(e,t,n){this.buf=e;this.offset=t;this.decoder=n;this.view=new DataView(e,t)}get length(){return this.view.getUint8(0)}get sector(){return this.view.getUint32(2,!0)}get size(){return this.view.getUint32(10,!0)}get isDirectory(){return(this.view.getUint8(25)&2)!==0}get name(){let e=this.view.getUint8(32),t=new DataView(this.buf,this.offset+33,e);if(e===1)switch(t.getUint8(0)){case 0:return".";case 1:return".."}return this.decoder.decode(t).split(";")[0]}};async function Tt(r,e){if(r.name.endsWith(".iso"))return new _t(r);if(e)if(e.name.endsWith(".cue")){let t=new Ce(r);return await t.parseCue(e),t}else if(e.name.endsWith(".ccd")){let t=new Ce(r);return await t.parseCcd(e),t}else{let t=new Mt(r);return await t.parseMds(e),t}else throw new Error("No metadata file")}var ue=class{constructor(e){this.image=e}async readSequential(e,t,n,i,a){let s=Math.ceil(t/i),l=this.image.slice(e,e+s*n),g=await d(l),P=[];for(let E=0;E<s;E++)P.push(new Uint8Array(g,E*n+a,Math.min(t,i))),t-=i;return P}reloadImage(){return ae().then(e=>{this.image=e})}async calculateCacheKey(e){if(!crypto.subtle)return;let t=await d(e),n=await crypto.subtle.digest("SHA-1",t);this.cddaCacheKey=btoa(String.fromCharCode(...new Uint8Array(n)))}},_t=class extends ue{readSector(e){return d(this.image.slice(e*2048,(e+1)*2048))}async readSequentialSectors(e,t){let n=e*2048,i=await d(this.image.slice(n,n+t));return[new Uint8Array(i)]}maxTrack(){return 1}extractTrack(e){throw"not implemented"}},Ce=class extends ue{constructor(e){super(e);this.tracks=[]}readSector(e){let t=e*2352+16,n=t+2048;return d(this.image.slice(t,n))}readSequentialSectors(e,t){return this.readSequential(e*2352,t,2352,2048,16)}async parseCue(e){await this.calculateCacheKey(e);let t=(await be(e)).split(`
`),n=null;for(let i of t){let a=i.trim().split(/\s+/);switch(a[0]){case"TRACK":n=Number(a[1]),this.tracks[n]={isAudio:a[2]==="AUDIO",index:[]};break;case"INDEX":n&&(this.tracks[n].index[Number(a[1])]=this.indexToSector(a[2]));break;default:}}}async parseCcd(e){await this.calculateCacheKey(e);let t=(await be(e)).split(`
`),n=null;for(let i of t){i=i.trim();let a=i.match(/\[TRACK ([0-9]+)\]/);if(a){n=Number(a[1]),this.tracks[n]={isAudio:!1,index:[]};continue}if(!n)continue;let s=i.split(/=/);switch(s[0]){case"MODE":this.tracks[n].isAudio=s[1]==="0";break;case"INDEX 0":this.tracks[n].index[0]=Number(s[1]);break;case"INDEX 1":this.tracks[n].index[1]=Number(s[1]);break;default:}}}maxTrack(){return this.tracks.length-1}async extractTrack(e){if(!this.tracks[e]||!this.tracks[e].isAudio)throw new Error("Invalid track "+e);let t=this.tracks[e].index[1]*2352,n;return this.tracks[e+1]?n=(this.tracks[e+1].index[0]||this.tracks[e+1].index[1])*2352:n=this.image.size,new Blob([Bt(n-t),this.image.slice(t,n)],{type:"audio/wav"})}indexToSector(e){let t=e.split(":").map(Number);return t[0]*60*75+t[1]*75+t[2]}};var Mt=class extends ue{constructor(e){super(e);this.tracks=[]}async parseMds(e){await this.calculateCacheKey(e);let t=await d(e);if(Fe(new Uint8Array(t,0,16))!=="MEDIA DESCRIPTOR")throw new Error(e.name+": not a mds file");let a=new DataView(t,0,112).getUint8(98);if(112+a*88>t.byteLength)throw new Error(e.name+": unknown format");for(let s=0;s<a;s++){let l=new DataView(t,112+s*80,80),g=new DataView(t,112+a*80+s*8,8),P=l.getUint8(0),E=l.getUint8(4),A=l.getUint16(16,!0),z=l.getUint32(40,!0),Q=g.getUint32(4,!0);E<100&&(this.tracks[E]={mode:P,sectorSize:A,offset:z,sectors:Q})}if(this.tracks[1].mode!==170)throw new Error("track 1 is not mode1")}readSector(e){let t=e*this.tracks[1].sectorSize+16,n=t+2048;return d(this.image.slice(t,n))}readSequentialSectors(e,t){let n=this.tracks[1];return this.readSequential(n.offset+e*n.sectorSize,t,n.sectorSize,2048,16)}maxTrack(){return this.tracks.length-1}async extractTrack(e){if(!this.tracks[e]||this.tracks[e].mode!==169)throw new Error("Invalid track "+e);let t=this.tracks[e].sectors*2352,n=await this.readSequential(this.tracks[e].offset,t,this.tracks[e].sectorSize,2352,0);return new Blob([Bt(t)].concat(n),{type:"audio/wav"})}};function Fe(r){return String.fromCharCode.apply(null,r)}function Bt(r){let e=new ArrayBuffer(44),t=new DataView(e);return t.setUint32(0,1380533830,!1),t.setUint32(4,r+36,!0),t.setUint32(8,1463899717,!1),t.setUint32(12,1718449184,!1),t.setUint32(16,16,!0),t.setUint16(20,1,!0),t.setUint16(22,2,!0),t.setUint32(24,44100,!0),t.setUint32(28,176400,!0),t.setUint16(32,4,!0),t.setUint16(34,16,!0),t.setUint32(36,1684108385,!1),t.setUint32(40,r,!0),e}var L=class{constructor(e){this.source=e;this.cache=[],document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this))}async getCDDA(e){if(!this.cache[e]){let t=await this.source.extractTrack(e);this.cache[e]=URL.createObjectURL(t)}return this.lastTrack=e,this.cache[e]}onVisibilityChange(){if(!document.hidden)return;for(let t=0;t<this.cache.length;t++)t!==this.lastTrack&&this.cache[t]&&URL.revokeObjectURL(this.cache[t]);let e=[];this.lastTrack&&(e[this.lastTrack]=this.cache[this.lastTrack]),this.cache=e}},_e=class{constructor(e){this.imageReader=e;this.mp3Urls=[];e.cddaCacheKey&&(this.mp3Cache=new Ut(e.cddaCacheKey),this.mp3Cache.startSpeculativeCache(this.imageReader))}async getCDDA(e){if(this.mp3Urls[e])return this.mp3Urls[e];if(this.mp3Cache){let n=await this.mp3Cache.getTrack(e);if(n){let i=URL.createObjectURL(n);return this.mp3Urls[e]=i,i}}let t=await this.imageReader.extractTrack(e);try{if(this.mp3Cache){let n=await d(t);this.mp3Cache.convertAndStore(e,n)}return URL.createObjectURL(t)}catch(n){n.constructor.name==="FileError"&&n.code===1?ga("send","event","CDDAload","NOT_FOUND_ERR"):p({type:"CDDAload",name:n.constructor.name,code:n.code});let i=document.importNode(o("#cdda-error").content,!0);this.reloadToast&&this.reloadToast.parentElement&&this.reloadToast.querySelector(".btn-clear").click();let a=this.reloadToast=v(i,"error");return new Promise(s=>{a.querySelector(".cdda-reload-button").addEventListener("click",()=>{this.imageReader.reloadImage().then(()=>{ga("send","event","CDDAload","reloaded"),a.querySelector(".btn-clear").click(),this.mp3Cache&&this.mp3Cache.startSpeculativeCache(this.imageReader),s(this.getCDDA(e))})})})}}},Sr="cdda",Te="tracks",Er=15e3,Ut=class{constructor(e){this.cachedTracks=[];this.pendingEncodes=0;this.worker=new Worker("worker/cddacacheworker.js"),this.worker.addEventListener("message",t=>this.handleWorkerMessage(t.data)),this.dbp=new Promise((t,n)=>{let i=indexedDB.open(Sr,1);i.onupgradeneeded=()=>i.result.createObjectStore(Te),i.onsuccess=()=>t(i.result),i.onerror=()=>{p({type:"IDBOpen",err:i.error}),n(i.error)}}),this.dbp.then(()=>this.init(e))}convertAndStore(e,t){this.worker.postMessage({track:e,data:t},[t]),this.pendingEncodes++,this.cachedTracks.push(e)}async getTrack(e){try{return await this.get(e)}catch(t){return null}}startSpeculativeCache(e){setTimeout(async()=>{if(this.pendingEncodes){this.startSpeculativeCache(e);return}for(let t=2;t<e.maxTrack();t++)if(!this.cachedTracks.includes(t)){try{let n=await e.extractTrack(t),i=await d(n);this.convertAndStore(t,i),ga("send","event","MP3Cache","speculativeCache"),this.startSpeculativeCache(e)}catch(n){}return}},Er)}handleWorkerMessage(e){let t=new Blob(e.data,{type:"audio/mp3"});this.put(e.track,t),this.pendingEncodes--}async init(e){let t=await this.get("key");if(e!=t)t&&ga("send","event","MP3Cache","purged"),await this.clear(),await this.put("key",e);else{let n;await this.withStore("readonly",i=>{n=i.getAllKeys()}),this.cachedTracks=n.result}}async get(e){let t;return await this.withStore("readonly",n=>{t=n.get(e)}),t.result}put(e,t){return this.withStore("readwrite",n=>n.put(t,e))}clear(){return this.withStore("readwrite",e=>e.clear())}async withStore(e,t){let n=await this.dbp;return new Promise((i,a)=>{let s=n.transaction(Te,e);s.oncomplete=()=>i(),s.onabort=l=>{p({type:"IDBTransactionAbort",ev:l}),a(l)},s.onerror=()=>{p({type:"IDBTransaction",err:s.error}),a(s.error)},setTimeout(()=>a("IDB transaction timeout"),1e3),t(s.objectStore(Te))})}},Me=class{async extractTrack(e){let t=ie(6,e-1);if(!t)throw new Error("BGMLoader: Invalid track "+e);return new Blob([t])}};var Ar=240,Dr=0,kr=[[7272,84,71]],Lr=[[2171,64,65],[7033,64,65],[93791,36,64],[93792,174,146],[93793,6,5]];function Rt(r,e,t){let n=null;switch(r.toUpperCase()){case"ぱすてるSA.ALD":n=kr;break;case"鬼畜王SA.ALD":T.get("tada")==="1"&&(n=Lr);break}let i="/"+r;if(r.match(/\.(ald|ain|alk|kld)$/i)){let s=FS.makedev(Ar,Dr++),l=new It(e,t,n);FS.registerDevice(s,l),FS.mkdev(i,s)}else{var a=FS.open(i,"w");for(let s of t)FS.write(a,s,0,s.byteLength);FS.close(a)}}var It=class{constructor(e,t,n){this.size=e;this.patchTbl=n;this.chunks=t}read(e,t,n,i,a){if(t!==Module.HEAP8)throw new Error("Invalid argument");this.addr===void 0&&this.load();let s=this.addr+a;return i=Math.min(i,this.size-a),Module.HEAP8.set(Module.HEAPU8.subarray(s,s+i),n),i}llseek(e,t,n){let i=t;return n===1?i+=e.position:n===2&&(i+=this.size),i}mmap(){return this.addr===void 0&&this.load(),{ptr:this.addr,allocated:!1}}load(){let e=this.addr=Module._malloc(this.size);for(let t of this.chunks)Module.HEAPU8.set(t,e),e+=t.byteLength;this.chunks=null,this.patch()}patch(){if(!!this.patchTbl){for(let e of this.patchTbl)if(Module.HEAPU8[this.addr+e[0]]!==e[1]){console.log("Patch failed");return}for(let e of this.patchTbl)Module.HEAPU8[this.addr+e[0]]=e[2];console.log("Patch applied"),this.patchTbl=null}}};var $=class{constructor(e){this.message=e;this.name="NoGamedataError"}toString(){return this.name+": "+this.message}},K=class{constructor(){this.hasMidi=!1;this.hasBGM=!1;this.aldFiles=null}async startLoad(){await this.doLoad(),this.createGr()}getCDDALoader(){return this.hasBGM?new L(new Me):this.createCDDALoader()}async loadSystem3(e){await xe("system3"),Module.arguments.push("-savedir",e),le.then(()=>{te(e.replace(/\/@$/,""))})}async loadXsystem35(){await xe("xsystem35"),this.aldFiles=[]}addFile(e,t,n){var i;Rt(e,t,n),(i=this.aldFiles)==null||i.push(e)}createGr(){if(!this.aldFiles)return;let e={b:"BGM",d:"Data",g:"Graphics",m:"Midi",r:"Resource",s:"Scenario",w:"Wave"},t="",n=[];for(let i of this.aldFiles){if(i.toLowerCase()==="system39.ain"){n.push("Ain "+i);continue}if(!i.toLowerCase().endsWith(".ald"))continue;let a=i.charAt(i.length-6).toLowerCase(),s=i.charAt(i.length-5);if(t=i.slice(0,-6),!e[a]){console.log("Resource file of unknown type: "+i);continue}n.push(e[a]+s.toUpperCase()+" "+i),a=="m"&&(this.hasMidi=!0),a=="b"&&(this.hasBGM=!0)}for(let i=0;i<26;i++){let a=String.fromCharCode(65+i);n.push("Save"+a+" save/"+t+"s"+a.toLowerCase()+".asd")}n.push(`MsgSkip save/${t}.msgskip`),FS.writeFile("xsystem35.gr",n.join(`
`)+`
`)}},Be=class extends K{constructor(e,t,n){super();this.imageFile=e;this.metadataFile=t;this.patchFiles=n}async doLoad(){this.imageReader=await Tt(this.imageFile,this.metadataFile);let e=await H.create(this.imageReader),t=await this.findGameDir(e);if(!t)throw new $(u.no_gamedata_dir);let n=!!await e.getDirEnt("system3.exe",t);n?await this.loadSystem3(await this.saveDir(e)):await this.loadXsystem35();let i=M("ImageLoad","Image load",this.imageFile.name);for(let a of await e.readDir(t)){if(this.patchFiles.some(g=>g.name.toLowerCase()===a.name.toLowerCase()))continue;if(n){if(!a.name.toLowerCase().endsWith(".dat"))continue}else if(a.name.match(/^\.|\.(exe|dll|txt|ini)$/i))continue;let s=M(a.name),l=await e.readFile(a);s(),this.addFile(a.name,a.size,l)}for(let a of this.patchFiles){let s=await d(a);this.addFile(a.name,a.size,[new Uint8Array(s)])}i()}createCDDALoader(){return re()?new _e(this.imageReader):new L(this.imageReader)}async findGameDir(e){for(let t of await e.readDir(e.rootDir())){if(t.isDirectory&&(t.name.toLowerCase()==="gamedata"||await e.getDirEnt("adisk.dat",t)))return t;if(t.name.toLowerCase()==="adisk.dat")return e.rootDir()}return null}async saveDir(e){let t=e.volumeLabel();return t||(await e.getDirEnt("prog.bat",e.rootDir())?t="ProG":await e.getDirEnt("dps_all.bat",e.rootDir())?t="DPS_all":(t="untitled",ga("send","event","Loader","NoVolumeLabel"))),"/save/"+t}async walk(e,t,n){for(let i of await e.readDir(t))i.name!=="."&&i.name!==".."&&(console.log(n+i.name),i.isDirectory&&this.walk(e,i,n+i.name+"/"))}},Ue=class extends K{constructor(e){super();this.tracks=[];this.files=[];for(let t=0;t<e.length;t++)this.files.push(e[t])}async doLoad(){this.files.some(e=>e.name.toLowerCase()==="adisk.dat")?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let e of this.files){let t=/(\d+)\.(wav|mp3|ogg)$/.exec(e.name.toLowerCase());if(t){this.tracks[Number(t[1])]=e;continue}let n=await d(e);this.addFile(e.name,e.size,[new Uint8Array(n)])}}createCDDALoader(){return new L(this)}async extractTrack(e){if(!this.tracks[e])throw new Error("FileSource: Invalid track "+e);return this.tracks[e]}},Re=class extends K{constructor(e){super();this.zipFile=e;this.tracks=[]}async doLoad(){await w(_);let e=new JSZip;await e.loadAsync(await d(this.zipFile),ne());let t=e.file(/\.(ald|ain|dat|mda|ttf|otf|ini|xsys35rc)$/i);if(t.length===0)throw new $(u.no_ald_in_zip);e.file(/adisk.dat/i).length>0?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let n of t){let i=await e.files[n.name].async("arraybuffer"),a=n.name.split("/").pop();this.addFile(a,i.byteLength,[new Uint8Array(i)])}for(let n of e.file(/\d+\.(wav|mp3|ogg)$/i)){let i=Number(/(\d+)\.\w+$/.exec(n.name)[1]);this.tracks[i]=n}}createCDDALoader(){return new L(this)}async extractTrack(e){if(!this.tracks[e])throw new Error("ZipSource: Invalid track "+e);return this.tracks[e].async("blob")}},Ie=class extends K{constructor(e){super();this.file=e;this.tracks=[]}async doLoad(){let e=new Worker("worker/archiveworker.js");e.postMessage({file:this.file}),o("#loader").classList.add("module-loading");let t=await new Promise(i=>{e.addEventListener("message",a=>i(a))});if("error"in t.data)throw o("#loader").classList.remove("module-loading"),new Error(t.data.error);let{files:n}=t.data;n.some(i=>i.name.toLowerCase()==="adisk.dat")?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let i of n){let a=/(\d+)\.(wav|mp3|ogg)$/i.exec(i.name);if(a){this.tracks[Number(a[1])]=new Blob([i.content]);continue}this.addFile(i.name,i.content.byteLength,[i.content])}}createCDDALoader(){return new L(this)}async extractTrack(e){if(!this.tracks[e])throw new Error("SevenZipSource: Invalid track "+e);return this.tracks[e]}};var Ge={};ee(Ge,{fade:()=>Kt,getPosition:()=>Rr,play:()=>$t,setCDDALoader:()=>ze,stop:()=>Ur});var y=o("#volume-control-slider"),k,j,q=c.volume,B=!1;function Cr(){y.value=String(Math.round(q*100)),o("#volume-control-icon").addEventListener("click",zt),y.addEventListener("input",Pr),y.addEventListener("change",Tr),y.addEventListener("mouseup",()=>{y.blur()}),k=new AudioContext,Fr(),j=k.createGain(),j.connect(k.destination),Ne(_r),j.gain.value=U(),document.addEventListener("gamestart",()=>{document.addEventListener("keydown",Mr)})}function me(){return j}function Fr(){let r=()=>{let e=k.createBufferSource();e.buffer=k.createBuffer(1,1,22050),e.connect(k.destination),e.start(),console.log("AudioContext unlocked"),window.removeEventListener("touchend",r),window.removeEventListener("mouseup",r)};window.addEventListener("touchend",r),window.addEventListener("mouseup",r)}function U(){return B?0:parseInt(y.value,10)/100}function Ne(r){o("#volume-control").addEventListener("volumechange",r)}function Nt(){y.hidden=!0}function Ot(){k.suspend(),setTimeout(()=>k.resume(),0)}function zt(r){B=!B,B?(o("#volume-control-icon").classList.remove("fa-volume-up"),o("#volume-control-icon").classList.add("fa-volume-off"),y.value="0"):(o("#volume-control-icon").classList.remove("fa-volume-off"),o("#volume-control-icon").classList.add("fa-volume-up"),y.value=String(Math.round(q*100))),Gt()}function Pr(r){q=parseInt(y.value,10)/100,q>0&&B&&(B=!1,o("#volume-control-icon").classList.remove("fa-volume-off"),o("#volume-control-icon").classList.add("fa-volume-up")),Gt()}function Tr(r){c.volume=q,c.persist()}function Gt(){let r=new CustomEvent("volumechange",{detail:U()});o("#volume-control").dispatchEvent(r)}function _r(r){j.gain.value=r.detail}function Mr(r){r.keyCode===77&&zt(r)}Cr();var m=o("audio"),Wt,J=null,fe,Z=1,V,x=null,Ht=class{constructor(e,t){let n=performance.now(),i=Z;this.done=new we,this.timer=setInterval(()=>{let a=performance.now()-n;Z=a>=e?t:i+a/e*(t-i),m.volume=U()*Z,a>=e&&(clearInterval(this.timer),this.timer=void 0,this.done.resolve())},10)}cancel(){clearInterval(this.timer),this.timer=void 0,this.done.resolve()}wait(){return this.done.promise}};function Br(){fe=!re(),Ne(Nr),m.volume=U(),m.addEventListener("error",Or),jt(!0),fe||(Nt(),m.volume===0&&(x=()=>{}))}function ze(r){Wt=r}async function $t(r,e){if(J=r,x){x=()=>{$t(r,e)};return}m.currentTime=0;try{let t=await Wt.getCDDA(r);Ir(t,e)}catch(t){ga("send","event","CDDA","InvalidTrack")}}async function Ur(r){r&&await Kt(r,0),m.pause(),J=null,x&&(x=()=>{})}async function Kt(r,e){if(!!fe){if(V&&(V.cancel(),V=void 0),r<=0){Z=e,m.volume=U()*Z;return}return V=new Ht(r,e),V.wait()}}function Rr(){if(!J)return 0;let r=Math.round(m.currentTime*75);return(x||m.error)&&(r+=750),J|r<<8}function Ir(r,e){m.setAttribute("src",r),m.loop=e!==0,m.load(),m.play().catch(t=>{if(!(t.message.startsWith("The play() request was interrupted")||t.name==="AbortError"))if(t.name==="NotAllowedError"||t.message.indexOf("gesture")>=0)jt(!1),ga("send","event","CDDA","UnlockAgain");else{let{name:n,message:i}=t;p({type:"CDDA",name:n,message:i})}})}function Nr(r){if(fe){m.volume=r.detail;return}let e=r.detail===0;if(!!x!==e)if(e)m.pause(),x=()=>{m.play()};else{let t=x;x=null,t()}}function Or(r){if(m.error){let{code:e,message:t}=m.error;p({type:"Audio",code:e,message:t})}else p({type:"Audio",code:"unknown"})}function jt(r){let e=()=>{r?J||(m.load(),console.log("CDDA unlocked")):m.play(),window.removeEventListener("touchend",e),window.removeEventListener("mouseup",e)};window.addEventListener("touchend",e),window.addEventListener("mouseup",e)}Br();var he={};ee(he,{fadeStart:()=>jr,getPosition:()=>Hr,getVolume:()=>Kr,init:()=>He,isFading:()=>qr,pause:()=>Gr,play:()=>zr,resume:()=>Wr,setVolume:()=>$r,stop:()=>We});var f,S,pe=!1,qt=0,R=null;function He(r){Module.addRunDependency("timidity"),w("/timidity/timidity.js").then(()=>{S=r.context.createGain(),S.connect(r),f=new Timidity(S,"/timidity/"),f.on("playing",Vr),f.on("error",Zr),f.on("ended",Jr),Module.removeRunDependency("timidity")})}function zr(r,e,t){!f||(f.load(Module.HEAPU8.slice(e,e+t)),f.play(),pe=!0)}function We(){!f||(pe=!1,f.pause())}function Gr(){!f||f.pause()}function Wr(){!f||f.play()}function Hr(){return f?Math.round(f.currentTime*1e3):0}function $r(r){!f||(S.gain.value=r/100)}function Kr(){return f?S.gain.value*100:100}function jr(r,e,t){!f||(S.gain.cancelScheduledValues(S.context.currentTime),R!==null&&(clearTimeout(R),R=null),!(r===0&&e===100&&(R||!pe))&&(S.gain.linearRampToValueAtTime(e/100,S.context.currentTime+r/1e3),qt=performance.now()+r,t&&(r===0?We():R=setTimeout(()=>{We(),R=null},r))))}function qr(){return f&&performance.now()<qt?1:0}function Vr(r){!r||S.gain.setValueAtTime(1,r)}function Zr(r){console.warn(r),ga("send","event","MIDI",r.message)}function Jr(){pe&&f.play()}var X,ge,Vt=[],$e=!1;function Xr(){o("#fileselect").addEventListener("change",Yr,!1),document.body.ondragover=Qr,document.body.ondrop=en}function Yr(r){let e=r.target;Zt(e.files),e.value=""}function Qr(r){r.stopPropagation(),r.preventDefault(),r.dataTransfer.dropEffect="copy"}function en(r){r.stopPropagation(),r.preventDefault(),Zt(r.dataTransfer.files)}async function Zt(r){if($e||r.length===0)return;let e=!1,t=!1;for(let i of r)tn(i)?(X=i,o("#imgReady").classList.remove("notready"),o("#imgReady").textContent=i.name,t=!0):rn(i)?(ge=i,o("#cueReady").classList.remove("notready"),o("#cueReady").textContent=i.name,t=!0):(i.name.match(/\.(ald|ain)$/i)||i.name.toLowerCase()==="adisk.dat")&&(e=!0,Vt.push(i));let n=null;if(X&&(ge||X.name.toLowerCase().endsWith(".iso"))?n=new Be(X,ge,Vt):!X&&!ge&&(r.length==1&&r[0].name.toLowerCase().endsWith(".zip")?n=new Re(r[0]):r.length==1&&r[0].name.match(/\.(rar|7z)$/i)?n=new Ie(r[0]):r.length>2&&e&&(n=new Ue(r))),!n){t||v(`${r[0].name}: ${u.unrecognized_format}`,"warning");return}$e=!0;try{await n.startLoad(),ze(n.getCDDALoader()),nn(n.hasMidi)}catch(i){i instanceof $?(ga("send","event","Loader","NoGamedata",i.message),v(`${u.cannot_install}: ${i.message}`,"warning")):i instanceof Error&&(ga("send","event","Loader","LoadFailed",i.message),v(`${u.cannot_install}: ${u.unrecognized_format}`,"warning"))}$e=!1}function tn(r){let e=r.name.toLowerCase();return e.endsWith(".img")||e.endsWith(".mdf")||e.endsWith(".iso")}function rn(r){let e=r.name.toLowerCase();return e.endsWith(".cue")||e.endsWith(".ccd")||e.endsWith(".mds")}function nn(r){r&&He(me()),o("#xsystem35").hidden=!1,document.body.classList.add("game"),o("#toolbar").classList.remove("before-game-start"),window.onbeforeunload=an,setTimeout(()=>{Module.arguments.push(c.antialias?"-antialias":"-noantialias"),Module.arguments.push("-fm"),Module.removeRunDependency("gameFiles"),document.dispatchEvent(new Event("gamestart"))},0)}function an(r){c.unloadConfirmation&&(r.returnValue=u.unload_confirmation,Ot())}Xr();var C=o("#canvas"),je=o("#zoom"),Y=o("#pixelate"),Ke=!1;function on(){je.addEventListener("change",qe),je.value=c.zoom,CSS.supports("image-rendering","pixelated")||CSS.supports("image-rendering","-moz-crisp-edges")?(Y.addEventListener("change",Jt),c.pixelate&&(Y.checked=!0,Jt())):Y.setAttribute("disabled","true"),screen.orientation&&screen.orientation.addEventListener("change",()=>{screen.orientation.type.startsWith("landscape")?ln():cn()}),window.addEventListener("resize",sn)}function qe(){let r=je.value;c.zoom=r,c.persist();let e=o(".navbar").style;if(r==="fit")o("#xsystem35").classList.add("fit"),e.maxWidth="none",C.style.width="";else{o("#xsystem35").classList.remove("fit");let t=Number(r);e.maxWidth=C.style.width=C.width*t+"px"}}function sn(){Ke||(Ke=!0,window.requestAnimationFrame(()=>{Ve(),Ke=!1}))}function Ve(){let r=o(".contents"),e=o("#xsystem35"),t=r.offsetWidth/r.offsetHeight;if(!t)return;let n=C.width/C.height;t<n?(e.classList.add("letterbox"),e.classList.remove("pillarbox")):(e.classList.remove("letterbox"),e.classList.add("pillarbox"))}function Jt(){c.pixelate=Y.checked,c.persist(),Y.checked?C.classList.add("pixelated"):C.classList.remove("pixelated")}function ln(){let r=document.documentElement;r.requestFullscreen?r.requestFullscreen():r.webkitRequestFullScreen&&r.webkitRequestFullScreen()}function cn(){document.exitFullscreen?document.fullscreenElement&&document.exitFullscreen():document.webkitExitFullscreen&&document.webkitFullscreenElement&&document.webkitExitFullscreen()}on();var et={};ee(et,{enable_audio_hook:()=>An,pcm_fadeout:()=>vn,pcm_getpos:()=>bn,pcm_getwavelen:()=>yn,pcm_isplaying:()=>xn,pcm_load:()=>pn,pcm_load_mixlr:()=>hn,pcm_reset:()=>fn,pcm_setvol:()=>wn,pcm_start:()=>gn,pcm_stop:()=>Ye,pcm_unload:()=>Xt,pcm_waitend:()=>Sn});var h=[],b=[],D=me();function un(){document.addEventListener("visibilitychange",En)}async function Ze(r){let e=ie(2,r-1);if(!e)throw new Error("Failed to open wave "+r);D.context.resume();let t=await mn(e);return b[r]=t,t}async function mn(r){try{return await D.context.decodeAudioData(r)}catch(e){let t=new Uint8Array(r);if(t[0]===79&&t[1]===103&&t[2]===103&&t[3]===83){await w("lib/stbvorbis-0.2.2.js");let n=[],i=0;return new Promise((a,s)=>{stbvorbis.decode(r,l=>{if(l.error)s(l.error);else if(!l.eof)n.length===0&&(i=l.sampleRate),n.push(l.data);else{let g=n[0].length,P=n.reduce((A,z)=>A+z[0].length,0),E=D.context.createBuffer(g,P,i);for(let A=0;A<g;A++){let z=E.getChannelData(A),Q=0;for(let st of n)z.set(st[A],Q),Q+=st[A].length}a(E)}})})}throw e}}function fn(){for(let r=0;r<h.length;r++)Xt(r)}function pn(r,e){return Asyncify.handleSleep(t=>{if(Ye(r),b[e])return h[r]=new Je(D,b[e]),t(0);Ze(e).then(n=>{h[r]=new Je(D,n),t(0)},n=>{p({type:"PCM",err:n}),t(-1)})})}function hn(r,e,t){return Asyncify.handleSleep(n=>{if(Ye(r),b[e]&&b[t])return h[r]=new Xe(D,b[e],b[t]),n(0);let i=[b[e]?Promise.resolve(b[e]):Ze(e),b[t]?Promise.resolve(b[t]):Ze(t)];Promise.all(i).then(a=>{h[r]=new Xe(D,a[0],a[1]),n(0)}).catch(a=>{p({type:"PCM",err:a}),n(-1)})})}function Xt(r){let e=h[r];return e?(e.stop(),h[r]=null,0):-1}function gn(r,e){let t=h[r];return t?(t.start(e),0):(console.log("pcm_start: invalid slot",r),-1)}function Ye(r){let e=h[r];return e?(e.stop(),r===0&&(h[r]=null),0):-1}function vn(r,e){let t=h[r];return t?(t.fadeout(e),0):-1}function bn(r){let e=h[r];return e?e.getPosition()*1e3:0}function wn(r,e){let t=h[r];return t?(t.setGain(e/100),0):-1}function yn(r){let e=h[r];return e?e.duration*1e3:0}function xn(r){let e=h[r];return e?e.isPlaying()?1:0:0}function Sn(r){return Asyncify.handleSleep(e=>{let t=h[r];if(!t||!t.isPlaying())return e(0);t.end_callback=()=>e(0)})}function En(){document.hidden&&(b=[])}var Qe=class{constructor(e){this.dst=e;this.end_callback=null;this.startTime=null;this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e)}setGain(e){this.gain.gain.value=e}fadeout(e){this.gain.gain.linearRampToValueAtTime(0,this.context.currentTime+e/1e3)}getPosition(){return this.startTime===null?0:this.context.currentTime-this.startTime}isPlaying(){return this.startTime!==null}ended(){this.startTime=null,this.end_callback&&(this.end_callback(),this.end_callback=null)}},Je=class extends Qe{constructor(e,t){super(e);this.buf=t}start(e){this.node=this.context.createBufferSource(),this.node.buffer=this.buf,this.node.connect(this.gain),this.node.onended=this.onended.bind(this),e!==1&&(this.node.loop=!0),e<=1?this.node.start():this.node.start(0,0,this.buf.duration*e),this.startTime=this.context.currentTime}stop(){this.startTime!==null&&(this.node.stop(),this.startTime=null)}get duration(){return this.buf.duration}onended(){this.ended()}},Xe=class extends Qe{constructor(e,t,n){super(e);this.endCount=0;this.lsrc=this.context.createBufferSource(),this.rsrc=this.context.createBufferSource(),this.lsrc.buffer=t,this.rsrc.buffer=n;let i=this.context.createChannelMerger(2);i.connect(this.gain),this.lsrc.connect(i,0,0),this.rsrc.connect(i,0,1),this.lsrc.onended=this.rsrc.onended=this.onended.bind(this)}start(e){e!==1&&console.warn("PCMSoundMixLR: loop is not supported "+e),this.lsrc.start(),this.rsrc.start(),this.startTime=this.context.currentTime}stop(){this.startTime!==null&&(this.lsrc.stop(),this.rsrc.stop(),this.startTime=null)}get duration(){return Math.max(this.lsrc.buffer.duration,this.rsrc.buffer.duration)}onended(){this.endCount++,this.endCount===2&&this.ended()}},I;function An(){if(!I){I=D.context.createScriptProcessor(4096,0,2);let e=Module._malloc(4096*2*2);I.addEventListener("audioprocess",t=>{let n=t.outputBuffer.getChannelData(0),i=t.outputBuffer.getChannelData(1);if(_audio_callback(e,4096))for(let a=0;a<4096;a++)n[a]=Module.HEAP16[(e>>1)+a*2]/32768,i[a]=Module.HEAP16[(e>>1)+a*2+1]/32768;else for(let a=0;a<4096;a++)n[a]=i[a]=0}),I.connect(D)}return I.context.resume(),I.context.sampleRate}un();var ot={};ee(ot,{disableWheelEvent:()=>_n,keywait:()=>Fn,message:()=>Ln,newline:()=>it,nextpage:()=>Cn,setTitle:()=>at});var Dn=2e3,Yt=0,kn=[["ＲＡＮＣＥ",[2]],["ＲＡＮＣＥ２",[2]],["Ｒａｎｃｅ３",[1]],[/^(Ｒａｎｃｅ４　－教団の遺産－　Ｆｏｒ　Ｗｉｎ９５|Rance4 -Legacy of the Sect- For Win95)$/,[10,11,16,88,90]],["ランス 4.1 〜お薬工場を救え！〜",[6]],["ランス 4.2 〜エンジェル組〜",[7]],[/^(鬼畜王ランス|Kichikuou Rance)$/,[7,11,15,16,17,18,23,24,32,33,197]],["闘神都市",[1]],["闘神都市Ⅱ　ｆｏｒ　Ｗｉｎ９５",[4,5,6,7,8]],["あゆみちゃん物語",[6]],[/^グレイメルカ ver1\./,[1,2,5,6]]],F=o("#textlog-content");o("#textlog-button").addEventListener("click",nt);o("#textlog-close").addEventListener("click",ve);o("#textlog-overlay").addEventListener("click",ve);document.addEventListener("gamestart",()=>{document.addEventListener("keydown",r=>{r.keyCode===76?nt():r.keyCode===27&&ve()})});o("#canvas").addEventListener("wheel",r=>{performance.now()<Yt||r.deltaY<=0&&nt()});F.addEventListener("wheel",r=>{r.deltaY>0&&F.scrollTop+F.clientHeight>=F.scrollHeight&&ve()});function nt(){let r=o("#textlog-modal").classList;r.contains("active")||(Pn(F),r.add("active"),F.scrollTop=F.scrollHeight)}function ve(){o("#textlog-modal").classList.remove("active")}var tt=-1,N="",O=[],rt=[],Qt=T.get("consoleTextLog")==="1";function Ln(r,e){N===""&&(tt=e),N+=r}function it(){N!==""&&(Tn(tt)||(Qt&&console.log(tt+": "+N),er(N)),N="")}function Cn(){it(),O[O.length-1]!==""&&(Qt&&console.log(""),er(""))}function Fn(){it()}function Pn(r){r.textContent=O.join(`
`)}function at(r){for(let[e,t]of kn)if(e instanceof RegExp?e.test(r):e===r){rt=t;return}rt=[]}function er(r){O.push(r),O.length>Dn&&O.shift()}function Tn(r){return rt.includes(r)}function _n(r){Yt=performance.now()+r}var tr=class{constructor(){window.onerror=(e,t,n,i,a)=>{p({type:"onerror",message:e,url:t,line:n,column:i},!0),v("エラーが発生しました。","error"),window.onerror=null},window.addEventListener("unhandledrejection",e=>{let t=e.reason;if(console.log(t),t instanceof Error){let{name:n,message:i,stack:a}=t;p({type:"rejection",name:n,message:i,stack:a},!0)}else p({type:"rejection",name:t.constructor.name,reason:t},!0)})}windowSizeChanged(){qe(),Ve()}setWindowTitle(e){let t=e.indexOf(":");t!==-1&&(e=e.slice(t+1).trim(),at(e),o(".navbar-brand").textContent=e,ga("set","dimension1",e),ga("send","event","Game","GameStart",e))}inputString(e,t,n){e+=" ("+u.input_char_limit(n)+")";let i=window.prompt(e,t);return i&&(i=i.substring(0,n)),i}inputNumber(e,t,n,i){e+=` (${t}-${n})`;let a=window.prompt(e,i+"");if(a){let s=parseInt(a);if(t<=s&&s<=n)return s}return-1}setSkipButtonState(e,t){pt(e,t)}quit(){v(u.game_over),ga("send","event","Game","GameEnd"),window.onbeforeunload=null}syncfs(e=100){Se(e)}},Mn=new tr,Bn={Status:G,shell:Mn,cdPlayer:Ge,midiPlayer:he,audio:et,texthook:ot,load_mincho_font:Dt};window.xsystem35=Bn;typeof WebAssembly!="object"&&(document.getElementById("unsupported").hidden=!1);"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js")});window.addEventListener("beforeinstallprompt",r=>{r.userChoice.then(e=>{ga("send","event","App","InstallPrompt",e.outcome)})});
//# sourceMappingURL=shell.js.map
