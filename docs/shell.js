var tn=Object.defineProperty;var se=(n,e)=>{for(var t in e)tn(n,t,{get:e[t],enumerable:!0})};var s=document.querySelector.bind(document),P=new URLSearchParams(location.search.slice(1)),M="lib/jszip.3.1.3.min.js",ft=new Map;function v(n){let e=ft.get(n);if(!e){let t=document.createElement("script");t.src=n,e=new Promise((r,i)=>{t.addEventListener("load",r,{once:!0}),t.addEventListener("error",i,{once:!0})}),document.body.appendChild(t),ft.set(n,e)}return e}function ce(n,e){try{(e||FS).mkdir(n)}catch(t){}}function ue(n,e){let t=navigator.userAgent.match(/OS ([0-9_]+) like Mac OS X\)/);if(!t)return!1;let r=t[1].replace(/_/g,".");return(!n||n<=r)&&(!e||r<e)}function j(n,e){return new Blob([n],{type:nn(e)})}function nn(n){let e=n.toLowerCase();return e.endsWith(".wav")?"audio/wav":e.endsWith(".ogg")?"audio/ogg":e.endsWith(".mp3")?"audio/mpeg":""}function de(){let n={};return typeof TextDecoder!="undefined"&&(n={decodeFileName:e}),n;function e(t){try{return new TextDecoder("utf-8",{fatal:!0}).decode(t)}catch(r){return new TextDecoder("shift_jis",{fatal:!0}).decode(t)}}}function Z(n,e,t,r){let i=new ArrayBuffer(44),a=new DataView(i);return a.setUint32(0,1380533830,!1),a.setUint32(4,t+36,!0),a.setUint32(8,1463899717,!1),a.setUint32(12,1718449184,!1),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,e,!0),a.setUint32(24,n,!0),a.setUint32(28,n*e*2,!0),a.setUint16(32,e*2,!0),a.setUint16(34,16,!0),a.setUint32(36,1684108385,!1),a.setUint32(40,t,!0),r.unshift(i),new Blob(r,{type:"audio/wav"})}var le=class{constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}};function B(n){let e=n+"-start",t=n+"-end";return performance.mark(e),()=>{performance.mark(t),performance.measure(n,e,t)}}function b(n,e=!1){let t=JSON.stringify(n,(r,i)=>i instanceof DOMException?{DOMException:i.name,message:i.message}:i);gtag("event","exception",{description:t,fatal:e})}var K=(t=>(t[t.OK=0]="OK",t[t.NG=-1]="NG",t))(K||{});function me(n,e){let t=_ald_getdata(n,e);if(!t)return null;let r=Module.getValue(t+8,"*"),i=Module.getValue(t,"i32"),a=rn(Module.getValue(t+12,"*")),o=Module.HEAPU8.buffer.slice(r,r+i);return _ald_freedata(t),{name:a,data:o}}function rn(n){let e="";for(;;){let t=Module.HEAPU8[n++];if(!t)break;e+=String.fromCharCode(t)}return e}var Ue=class{constructor(){this.antialias=!0;this.pixelate=!1;this.unloadConfirmation=!0;this.volume=1;this.zoom="fit";this.messageSkipFlags=14;let e=localStorage.getItem("KichikuouWeb.Config");if(e){let t=JSON.parse(e);t.antialias!==void 0&&(this.antialias=t.antialias),t.pixelate!==void 0&&(this.pixelate=t.pixelate),t.unloadConfirmation!==void 0&&(this.unloadConfirmation=t.unloadConfirmation),t.volume!==void 0&&(this.volume=t.volume),t.zoom!==void 0&&(this.zoom=t.zoom),t.messageSkipFlags!=null&&(this.messageSkipFlags=t.messageSkipFlags)}}persist(){localStorage.setItem("KichikuouWeb.Config",JSON.stringify({antialias:this.antialias,pixelate:this.pixelate,unloadConfirmation:this.unloadConfirmation,volume:this.volume,zoom:this.zoom,messageSkipFlags:this.messageSkipFlags}))}},u=new Ue;function y(n,e){let t=s(".toast-container"),r=document.createElement("div");r.classList.add("toast"),e&&r.classList.add("toast-"+e),typeof n=="string"?r.innerText=n:r.appendChild(n);let i=document.createElement("button");i.setAttribute("class","btn btn-clear float-right");function a(){r.parentNode===t&&t.removeChild(r)}i.addEventListener("click",a);let o=e?{success:5e3,warning:1e4,error:null}[e]:5e3;return o&&setTimeout(a,o),r.insertBefore(i,r.firstChild),t.insertBefore(r,t.firstChild),r}function fe(){return new Promise(n=>{let e=document.createElement("input");e.type="file",e.addEventListener("change",t=>{document.body.removeChild(e),n(e.files[0])}),e.style.display="none",document.body.appendChild(e),e.click()})}function pe(n,e,t){let r=document.createElement("a");r.setAttribute("download",n),r.setAttribute("href",e),t&&r.setAttribute("target",t),document.body.appendChild(r),r.click(),setTimeout(()=>{document.body.removeChild(r)},5e3)}var ht={cannot_install:"Cannot install",error_occurred:"An error occurred.",game_over:"The game is over.",input_char_limit:n=>`Up to ${n} characters`,module_load_failed:n=>`Failed to load ${n}. Please reload the page.`,no_ald_in_zip:"No game files (*.ALD/*.DAT) in the zip file.",no_gamedata_dir:"No GAMEDATA folder in the image.",floppy_images_cant_be_used:"Floppy disk images cannot be loaded.",restart_confirmation:"Restart the game?",restore_success:"Save files has been restored successfully.",restore_failure:"Save files could not be restored.",unload_confirmation:"Unsaved data will be lost.",unrecognized_format:"Unrecognized format."},an={cannot_install:"インストールできません",error_occurred:"エラーが発生しました。",game_over:"ゲームは終了しました。",input_char_limit:n=>`全角${n}文字まで`,module_load_failed:n=>n+"の読み込みに失敗しました。リロードしてください。",no_ald_in_zip:"ZIP内にゲームデータ (*.ALD/*.DATファイル) が見つかりません。",no_gamedata_dir:"イメージ内にGAMEDATAフォルダが見つかりません。",floppy_images_cant_be_used:"フロッピーディスクイメージは読み込めません。Windows版のデータを使用してください。",restart_confirmation:"ゲームを再起動しますか？",restore_success:"セーブデータの復元に成功しました。",restore_failure:"セーブデータを復元できませんでした。",unload_confirmation:"セーブしていないデータは失われます。",unrecognized_format:"認識できない形式です。"},pt={en:ht,ja:an};function on(){let n=document.documentElement.getAttribute("lang");return n&&pt[n]?pt[n]:ht}var m=on();var he=s("#msgskip-button");function sn(){s("#restart-button").addEventListener("click",wt),s("#screenshot-button").addEventListener("click",xt),he.addEventListener("click",yt),document.addEventListener("gamestart",()=>{document.addEventListener("keydown",cn)})}function bt(){s("#toolbar-handler").addEventListener("click",ln),s("#toolbar-close-button").addEventListener("click",gt),s("#toolbar").classList.add("closeable"),gt()}function ln(){s("#toolbar").classList.remove("closed")}function gt(){s("#toolbar").classList.add("closed")}function cn(n){switch(n.keyCode){case 80:xt();break;case 82:wt();break;case 83:yt();break}}function vt(n,e){he.classList.toggle("disabled",!n),he.classList.toggle("activated",!!e)}function yt(){_msgskip_activate(he.classList.contains("activated")?0:1)}function wt(){window.confirm(m.restart_confirmation)&&(gtag("event","Restart",{event_category:"Toolbar"}),_sys_restart())}async function xt(){let n=_sdl_getDisplaySurface(),e=document.createElement("canvas");e.width=Module.canvas.width,e.height=Module.canvas.height;let t=e.getContext("2d"),r=t.createImageData(e.width,e.height),i=r.data,a=r.data.length;for(let l=0;l<a;l+=4)i[l]=Module.HEAPU8[n+2],i[l+1]=Module.HEAPU8[n+1],i[l+2]=Module.HEAPU8[n],i[l+3]=255,n+=4;t.putImageData(r,0,0);let o=await new Promise(l=>e.toBlob(l));o&&pe(un(),URL.createObjectURL(o),"_blank")}function un(){let n=new Date,e=("0"+(n.getMonth()+1)).slice(-2),t=("0"+n.getDate()).slice(-2),r=("0"+n.getHours()).slice(-2),i=("0"+n.getMinutes()).slice(-2),a=("0"+n.getSeconds()).slice(-2);return"Screenshot-"+n.getFullYear()+e+t+"-"+r+i+a+".png"}sn();var Et="MTLc3m.ttf",Lt="mincho.otf",Dt,dn=new Promise(n=>{Dt=n}),Ft,ge=new Promise(n=>{Ft=n});function mn(){window.Module={},Module.arguments=[];for(let[n,e]of P)n.startsWith("-")&&(Module.arguments.push(n),e&&Module.arguments.push(e));Module.print=Module.printErr=console.log.bind(console),Module.canvas=document.getElementById("canvas"),Module.preRun=[()=>{Module.addRunDependency("gameFiles")},Dt,function(){FS.mkdir("/fonts"),FS.createPreloadedFile("/fonts",Et,"fonts/"+Et,!0,!1)},function(){FS.mkdir("/save"),FS.mount(IDBFS,{},"/save"),Module.addRunDependency("syncfs"),FS.syncfs(!0,e=>{Module.removeRunDependency("syncfs"),Ft(FS)})},()=>{window.setWindowTitle=()=>{}}]}function Re(n){s("#loader").classList.add("module-loading");let e=n+".js",t=document.createElement("script");t.src=e,t.onerror=()=>{gtag("event","ModuleLoadFailed",{event_category:"Game",event_label:e}),y(m.module_load_failed(e),"error")},document.body.appendChild(t);let r=B("ModuleLoad");return dn.then(()=>{r(),s("#loader").hidden=!0,document.body.classList.add("bgblack-fade"),bt()})}var kt;function Ct(n){window.clearTimeout(kt),kt=window.setTimeout(()=>{FS.syncfs(!1,e=>{e&&console.log("FS.syncfs error: ",e)})},n),fn()}var _t=!1;async function fn(){if(_t||!(navigator.storage&&navigator.storage.persist)||(_t=!0,await navigator.storage.persisted()))return;let n=await navigator.storage.persist()}var At=!1;function Tt(){return At?Promise.resolve(0):(At=!0,new Promise(n=>{console.log("loading mincho font");let e=B("FontLoad");readAsync("fonts/"+Lt,t=>{e(),FS.writeFile("/fonts/"+Lt,new Uint8Array(t)),n(0)},()=>{n(-1)})}))}mn();var be=class{constructor(){window.FS&&(this.FSready=ge),this.FSready||(this.FSready=(async()=>(await v("fslib.js"),(await FSLib()).saveDirReady))()),v(M)}hasSaveData(){function e(t,r){if(!t.isDir(t.stat(r).mode))return!1;for(let i of t.readdir(r))if(i[0]!=="."&&(i.toLowerCase().endsWith(".asd")||i.toLowerCase().endsWith(".dat")||e(t,r+"/"+i)))return!0;return!1}return this.FSready.then(t=>e(t,"/save"))}async download(){await v(M);let e=new JSZip;Mt(await this.FSready,"/save",e.folder("save"));let t=await e.generateAsync({type:"blob",compression:"DEFLATE"});pe("savedata.zip",URL.createObjectURL(t)),gtag("event","Downloaded",{event_category:"Savedata"})}async extract(e){try{let t=await this.FSready;if(e.name.toLowerCase().endsWith(".asd"))Pt(t,"/save/"+e.name,await e.arrayBuffer());else{await v(M);let r=new JSZip;await r.loadAsync(await e.arrayBuffer(),de());let i=[];r.folder("save").forEach((a,o)=>{i.push(o)});for(let a of i)a.dir?ce("/"+a.name.slice(0,-1),t):Pt(t,"/"+a.name,await a.async("arraybuffer"))}await new Promise((r,i)=>{t.syncfs(!1,a=>{a?i(a):r(void 0)})}),y(m.restore_success,"success"),gtag("event","Restored",{event_category:"Savedata"})}catch(t){if(y(m.restore_failure,"error"),console.warn(t),t instanceof Error)gtag("event","RestoreFailed",{event_category:"Savedata",event_label:t.message});else throw t}}};function Mt(n,e,t){for(let r of n.readdir(e)){let i=e+"/"+r;if(r[0]!=="."){if(n.isDir(n.stat(i).mode))Mt(n,i,t.folder(r));else if(!r.toLowerCase().endsWith(".asd.")){let a=n.readFile(i,{encoding:"binary"});t.file(r,a)}}}}function Pt(n,e,t){n.writeFile(e,new Uint8Array(t))}var ze=s("#antialias"),Ne=s("#unload-confirmation"),ve={"#msgskip-skip-unseen":1,"#msgskip-stop-on-unseen":2,"#msgskip-stop-on-menu":4,"#msgskip-stop-on-click":8},q=null,We;function pn(){s("#settings-button").addEventListener("click",gn),s("#settings-close").addEventListener("click",Ie),We=n=>{n.keyCode===27&&Ie()},s("#settings-overlay").addEventListener("click",Ie),ze.addEventListener("change",bn),ze.checked=u.antialias,Ne.addEventListener("change",vn),Ne.checked=u.unloadConfirmation;for(let n in ve){let e=s(n);e.addEventListener("change",Bt),e.checked=!!(u.messageSkipFlags&ve[n])}s("#msgskip-stop-on-unseen").toggleAttribute("disabled",s("#msgskip-skip-unseen").checked),s("#downloadSaveData").addEventListener("click",yn),s("#uploadSaveData").addEventListener("click",wn),document.addEventListener("gamestart",hn)}function hn(){Bt()}function gn(){s("#settings-modal").classList.add("active"),document.addEventListener("keydown",We),q=new be,Ut()}function Ie(){s("#settings-modal").classList.remove("active"),document.removeEventListener("keydown",We),q=null}function bn(){u.antialias=ze.checked,u.persist(),s("#xsystem35").hidden||_ags_setAntialiasedStringMode(u.antialias?1:0)}function vn(){u.unloadConfirmation=Ne.checked,u.persist()}function Bt(){let n=0;for(let e in ve)s(e).checked&&(n|=ve[e]);s("#msgskip-stop-on-unseen").toggleAttribute("disabled",s("#msgskip-skip-unseen").checked),window._msgskip_setFlags&&_msgskip_setFlags(n,4294967295),u.messageSkipFlags=n,u.persist()}async function Ut(){s("#downloadSaveData").hasAttribute("disabled")&&await q.hasSaveData()&&s("#downloadSaveData").removeAttribute("disabled")}async function yn(){q.download()}function wn(){fe().then(n=>q.extract(n)).then(()=>Ut())}pn();var U=class{constructor(e,t){this.sectorReader=e;this.vd=t;this.decoder=new TextDecoder(t.encoding())}static async create(e){let t=null;for(let r=16;;r++){let i=new Ge(await e.readSector(r));switch(i.type){case 1:t||(t=i);break;case 2:i.encoding()&&(t=i);break;case 255:if(!t)throw new Error("PVD not found");return new U(e,t)}}}volumeLabel(){return this.vd.volumeLabel(this.decoder)}rootDir(){return this.vd.rootDirEnt(this.decoder)}async getDirEnt(e,t){e=e.toLowerCase();for(let r of await this.readDir(t))if(r.name.toLowerCase()===e)return r;return null}async readDir(e){let t=e.sector,r=0,i=e.size,a=[],o;for(;r<i;){r===0&&(o=await this.sectorReader.readSector(t));let l=new ye(o,r,this.decoder);if(l.length===0?r=2048:(a.push(l),r+=l.length),r>2048)throw new Error("dirent across sector boundary");r===2048&&(t++,r=0,i-=2048)}return a}readFile(e){return this.sectorReader.readSequentialSectors(e.sector,e.size)}};var Ge=class{constructor(e){this.buf=e;if(this.view=new DataView(e),$e(new Uint8Array(this.buf,1,5))!=="CD001")throw new Error("Not a valid CD image")}get type(){return this.view.getUint8(0)}volumeLabel(e){return e.decode(new DataView(this.buf,40,32)).trim()}encoding(){if(this.type===1)return"shift_jis";if(this.escapeSequence().match(/%\/[@CE]/))return"utf-16be"}escapeSequence(){return $e(new Uint8Array(this.buf,88,32)).trim()}rootDirEnt(e){return new ye(this.buf,156,e)}},ye=class{constructor(e,t,r){this.buf=e;this.offset=t;this.decoder=r;this.view=new DataView(e,t)}get length(){return this.view.getUint8(0)}get sector(){return this.view.getUint32(2,!0)}get size(){return this.view.getUint32(10,!0)}get isDirectory(){return(this.view.getUint8(25)&2)!==0}get name(){let e=this.view.getUint8(32),t=new DataView(this.buf,this.offset+33,e);if(e===1)switch(t.getUint8(0)){case 0:return".";case 1:return".."}return this.decoder.decode(t).split(";")[0]}};async function Rt(n,e){if(n.name.endsWith(".iso"))return new Oe(n);if(e)if(e.name.endsWith(".cue")){let t=new we(n);return await t.parseCue(e),t}else if(e.name.endsWith(".ccd")){let t=new we(n);return await t.parseCcd(e),t}else{let t=new He(n);return await t.parseMds(e),t}else throw new Error("No metadata file")}var J=class{constructor(e){this.image=e}async readSequential(e,t,r,i,a){let o=Math.ceil(t/i),c=await this.image.slice(e,e+o*r).arrayBuffer(),p=[];for(let S=0;S<o;S++)p.push(new Uint8Array(c,S*r+a,Math.min(t,i))),t-=i;return p}reloadImage(){return fe().then(e=>{this.image=e})}},Oe=class extends J{readSector(e){return this.image.slice(e*2048,(e+1)*2048).arrayBuffer()}async readSequentialSectors(e,t){let r=e*2048,i=await this.image.slice(r,r+t).arrayBuffer();return[new Uint8Array(i)]}maxTrack(){return 1}extractTrack(e){throw"not implemented"}},we=class extends J{constructor(t){super(t);this.tracks=[]}readSector(t){let r=t*2352+16,i=r+2048;return this.image.slice(r,i).arrayBuffer()}readSequentialSectors(t,r){return this.readSequential(t*2352,r,2352,2048,16)}async parseCue(t){let r=(await t.text()).split(`
`),i=null;for(let a of r){let o=a.trim().split(/\s+/);switch(o[0]){case"TRACK":i=Number(o[1]),this.tracks[i]={isAudio:o[2]==="AUDIO",index:[]};break;case"INDEX":i&&(this.tracks[i].index[Number(o[1])]=this.indexToSector(o[2]));break;default:}}}async parseCcd(t){let r=(await t.text()).split(`
`),i=null;for(let a of r){a=a.trim();let o=a.match(/\[TRACK ([0-9]+)\]/);if(o){i=Number(o[1]),this.tracks[i]={isAudio:!1,index:[]};continue}if(!i)continue;let l=a.split(/=/);switch(l[0]){case"MODE":this.tracks[i].isAudio=l[1]==="0";break;case"INDEX 0":this.tracks[i].index[0]=Number(l[1]);break;case"INDEX 1":this.tracks[i].index[1]=Number(l[1]);break;default:}}}maxTrack(){return this.tracks.length-1}async extractTrack(t){if(!this.tracks[t]||!this.tracks[t].isAudio)throw new Error("Invalid track "+t);let r=this.tracks[t].index[1]*2352,i;return this.tracks[t+1]?i=(this.tracks[t+1].index[0]||this.tracks[t+1].index[1])*2352:i=this.image.size,Z(44100,2,i-r,[this.image.slice(r,i)])}indexToSector(t){let r=t.split(":").map(Number);return r[0]*60*75+r[1]*75+r[2]}};var He=class extends J{constructor(t){super(t);this.tracks=[]}async parseMds(t){let r=await t.arrayBuffer();if($e(new Uint8Array(r,0,16))!=="MEDIA DESCRIPTOR")throw new Error(t.name+": not a mds file");let o=new DataView(r,0,112).getUint8(98);if(112+o*88>r.byteLength)throw new Error(t.name+": unknown format");for(let l=0;l<o;l++){let c=new DataView(r,112+l*80,80),p=new DataView(r,112+o*80+l*8,8),S=c.getUint8(0),g=c.getUint8(4),A=c.getUint16(16,!0),ae=c.getUint32(40,!0),oe=p.getUint32(4,!0);g<100&&(this.tracks[g]={mode:S,sectorSize:A,offset:ae,sectors:oe})}if(this.tracks[1].mode!==170)throw new Error("track 1 is not mode1")}readSector(t){let r=t*this.tracks[1].sectorSize+16,i=r+2048;return this.image.slice(r,i).arrayBuffer()}readSequentialSectors(t,r){let i=this.tracks[1];return this.readSequential(i.offset+t*i.sectorSize,r,i.sectorSize,2048,16)}maxTrack(){return this.tracks.length-1}async extractTrack(t){if(!this.tracks[t]||this.tracks[t].mode!==169)throw new Error("Invalid track "+t);let r=this.tracks[t].sectors*2352,i=await this.readSequential(this.tracks[t].offset,r,this.tracks[t].sectorSize,2352,0);return Z(44100,2,r,i)}};function $e(n){return String.fromCharCode.apply(null,n)}var E=class{constructor(e){this.source=e;this.cache=[],document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this)),ue()&&indexedDB.deleteDatabase("cdda")}async getCDDA(e,t){if(!this.cache[e]){let r=await this.source.extractTrack(e);r.type==="audio/ogg"&&!t.canPlayType("audio/ogg")&&(r=await Sn(r)),this.cache[e]=URL.createObjectURL(r)}return this.lastTrack=e,this.cache[e]}onVisibilityChange(){if(!document.hidden)return;for(let t=0;t<this.cache.length;t++)t!==this.lastTrack&&this.cache[t]&&URL.revokeObjectURL(this.cache[t]);let e=[];this.lastTrack&&(e[this.lastTrack]=this.cache[this.lastTrack]),this.cache=e}},R=class{constructor(e,t){this.type=e;this.base_no=t}async extractTrack(e){let t=me(this.type,e+this.base_no-1);if(!t)throw new Error("BGMLoader: Invalid track "+e);return j(t.data,t.name)}};async function Sn(n){await v("lib/stbvorbis-0.2.2.js");let e=await n.arrayBuffer(),t=[],r=0,i=0,a=0;return new Promise((o,l)=>{stbvorbis.decode(e,c=>{if(c.error)l(c.error);else if(c.eof)o(Z(r,i,a,t));else{t.length===0&&(r=c.sampleRate,i=c.data.length);let p=new Int16Array(c.data[0].length*i),S=0;for(let g=0;g<c.data[0].length;g++)for(let A=0;A<c.data.length;A++)p[S++]=c.data[A][g]*32767;t.push(p),a+=p.byteLength}})})}var En=240,Ln=0,kn=[[7272,84,71]],_n=[[2171,64,65],[7033,64,65],[93791,36,64],[93792,174,146],[93793,6,5]];function It(n,e,t){let r=null;switch(n.toUpperCase()){case"ぱすてるSA.ALD":r=kn;break;case"鬼畜王SA.ALD":P.get("tada")==="1"&&(r=_n);break}let i="/"+n;if(n.match(/\.(ald|ain|alk|kld)$/i)){let o=FS.makedev(En,Ln++),l=new Ve(e,t,r);FS.registerDevice(o,l),FS.mkdev(i,o)}else{var a=FS.open(i,"w");for(let o of t)FS.write(a,o,0,o.byteLength);FS.close(a)}}var Ve=class{constructor(e,t,r){this.size=e;this.patchTbl=r;this.chunks=t}read(e,t,r,i,a){if(t!==Module.HEAP8)throw new Error("Invalid argument");this.addr===void 0&&this.load();let o=this.addr+a;return i=Math.min(i,this.size-a),Module.HEAP8.set(Module.HEAPU8.subarray(o,o+i),r),i}llseek(e,t,r){let i=t;return r===1?i+=e.position:r===2&&(i+=this.size),i}mmap(){return this.addr===void 0&&this.load(),{ptr:this.addr,allocated:!1}}load(){let e=this.addr=Module._malloc(this.size);for(let t of this.chunks)Module.HEAPU8.set(t,e),e+=t.byteLength;this.chunks=null,this.patch()}patch(){if(this.patchTbl){for(let e of this.patchTbl)if(Module.HEAPU8[this.addr+e[0]]!==e[1]){console.log("Patch failed");return}for(let e of this.patchTbl)Module.HEAPU8[this.addr+e[0]]=e[2];console.log("Patch applied"),this.patchTbl=null}}};var I=class{constructor(e){this.message=e;this.name="NoGamedataError"}toString(){return this.name+": "+this.message}},z=class{constructor(){this.hasMidi=!1;this.hasBGM=!1;this.aldFiles=null}async startLoad(){await this.doLoad(),this.createGr()}getCDDALoader(){return this.hasBGM?new E(new R(6,0)):this.createCDDALoader()}async loadSystem3(e){await Re("system3"),Module.arguments.push("-savedir",e),ge.then(()=>{ce(e.replace(/\/@$/,""))})}async loadXsystem35(){await Re("xsystem35"),this.aldFiles=[]}addFile(e,t,r){var i;It(e,t,r),(i=this.aldFiles)==null||i.push(e)}createGr(){if(!this.aldFiles)return;let e={b:"BGM",d:"Data",g:"Graphics",m:"Midi",r:"Resource",s:"Scenario",w:"Wave"},t="",r=[];for(let i of this.aldFiles){if(i.toLowerCase()==="system39.ain"){r.push("Ain "+i);continue}if(!i.toLowerCase().endsWith(".ald"))continue;let a=i.charAt(i.length-6).toLowerCase(),o=i.charAt(i.length-5);if(t=i.slice(0,-6),!e[a]){console.log("Resource file of unknown type: "+i);continue}r.push(e[a]+o.toUpperCase()+" "+i),a=="m"&&(this.hasMidi=!0),a=="b"&&(this.hasBGM=!0)}for(let i=0;i<26;i++){let a=String.fromCharCode(65+i);r.push("Save"+a+" save/"+t+"s"+a.toLowerCase()+".asd")}r.push(`MsgSkip save/${t}.msgskip`),FS.writeFile("xsystem35.gr",r.join(`
`)+`
`)}},xe=class extends z{constructor(t,r,i){super();this.imageFile=t;this.metadataFile=r;this.patchFiles=i}async doLoad(){this.imageReader=await Rt(this.imageFile,this.metadataFile);let t=await U.create(this.imageReader),r=await this.findGameDir(t);if(!r)throw new I(m.no_gamedata_dir);let i=!!await t.getDirEnt("system3.exe",r);i?await this.loadSystem3(await this.saveDir(t)):await this.loadXsystem35();let a=B("ImageLoad");for(let o of await t.readDir(r)){if(this.patchFiles.some(p=>p.name.toLowerCase()===o.name.toLowerCase()))continue;if(i){if(!o.name.toLowerCase().endsWith(".dat"))continue}else if(o.name.match(/^\.|\.(exe|dll|txt|ini)$/i))continue;let l=B(o.name),c=await t.readFile(o);l(),this.addFile(o.name,o.size,c)}for(let o of this.patchFiles){let l=await o.arrayBuffer();this.addFile(o.name,o.size,[new Uint8Array(l)])}a()}createCDDALoader(){return new E(this.imageReader)}async findGameDir(t){for(let r of await t.readDir(t.rootDir())){if(r.isDirectory&&(r.name.toLowerCase()==="gamedata"||await t.getDirEnt("adisk.dat",r)))return r;if(r.name.toLowerCase()==="adisk.dat")return t.rootDir()}return null}async saveDir(t){let r=t.volumeLabel();return r||(await t.getDirEnt("prog.bat",t.rootDir())?r="ProG":await t.getDirEnt("dps_all.bat",t.rootDir())?r="DPS_all":(r="untitled",gtag("event","NoVolumeLabel",{event_category:"Loader",event_label:this.imageFile.name}))),"/save/"+r}async walk(t,r,i){for(let a of await t.readDir(r))a.name!=="."&&a.name!==".."&&(console.log(i+a.name),a.isDirectory&&this.walk(t,a,i+a.name+"/"))}},Se=class extends z{constructor(t){super();this.tracks=new X;this.files=[];for(let r=0;r<t.length;r++)this.files.push(t[r])}async doLoad(){this.files.some(r=>r.name.toLowerCase()==="adisk.dat")?await this.loadSystem3("/save/@"):await this.loadXsystem35();let t=this.files.find(r=>r.name.toLowerCase()==="playlist.txt");t&&this.tracks.load_playlist(await t.text());for(let r of this.files){if(this.tracks.add(r,r.name))continue;let i=await r.arrayBuffer();this.addFile(r.name,r.size,[new Uint8Array(i)])}}createCDDALoader(){return new E(this)}async extractTrack(t){return this.tracks.get(t)}},Ee=class extends z{constructor(t){super();this.zipFile=t;this.tracks=new X}async doLoad(){await v(M);let t=new JSZip;await t.loadAsync(await this.zipFile.arrayBuffer(),de());let r=t.file(/\.(ald|ain|dat|mda|ttf|otf|ini|xsys35rc)$/i);if(r.length===0){let a=t.file(/\.(d88|dsk|hdm|xdf)$/i).length>0?m.floppy_images_cant_be_used:m.no_ald_in_zip;throw new I(a)}t.file(/adisk.dat/i).length>0?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let a of r){let o=await t.files[a.name].async("arraybuffer"),l=a.name.split("/").pop();this.addFile(l,o.byteLength,[new Uint8Array(o)])}let i=t.file(/playlist.txt/i);i.length>0&&this.tracks.load_playlist(await i[0].async("text"));for(let a of t.file(/\.(wav|mp3|ogg)$/i))this.tracks.add(a,a.name)}createCDDALoader(){return new E(this)}async extractTrack(t){let r=this.tracks.get(t),i=await r.async("arraybuffer");return j(i,r.name)}},Le=class extends z{constructor(t){super();this.file=t;this.tracks=new X}async doLoad(){let t=new Worker("archiveworker.js",{type:"module"});t.postMessage({file:this.file}),s("#loader").classList.add("module-loading");let r=await new Promise(o=>{t.addEventListener("message",l=>o(l))});if("error"in r.data)throw s("#loader").classList.remove("module-loading"),new Error(r.data.error);let{files:i}=r.data;i.some(o=>o.name.toLowerCase()==="adisk.dat")?await this.loadSystem3("/save/@"):await this.loadXsystem35();let a=i.find(o=>o.name.toLowerCase()==="playlist.txt");a&&this.tracks.load_playlist(new TextDecoder().decode(a.content));for(let o of i)this.tracks.add(o,o.name)||this.addFile(o.name,o.content.byteLength,[o.content])}createCDDALoader(){return new E(this)}async extractTrack(t){let r=this.tracks.get(t);return j(r.content,r.name)}},X=class{constructor(){this.tracks=[]}normalize(e){return e.toLowerCase().trim().replace(/.*[\/\\]/,"")}load_playlist(e){var r;let t=e.split(`
`);this.playlist=new Map;for(let i=0;i<t.length;i++){let a=this.normalize(t[i]);a.length>0&&((r=this.playlist)==null||r.set(a,i+1))}}add(e,t){if(this.playlist){let r=this.playlist.get(this.normalize(t));if(r)return this.tracks[r]=e,!0}else{let r=/(\d+)\.(wav|mp3|ogg)$/i.exec(t.toLowerCase());if(r)return this.tracks[Number(r[1])]=e,!0}return!1}get(e){if(!this.tracks[e])throw new Error("Invalid track "+e);return this.tracks[e]}};var qe={};se(qe,{fade:()=>$t,getPosition:()=>In,play:()=>Ht,setBGMLoader:()=>Un,setCDDALoader:()=>Ae,stop:()=>Rn});var L=s("#volume-control-slider"),D,Y,Q=u.volume,N=!1;function Dn(){L.value=String(Math.round(Q*100)),s("#volume-control-icon").addEventListener("click",Wt),L.addEventListener("input",Cn),L.addEventListener("change",Tn),L.addEventListener("mouseup",()=>{L.blur()}),D=new AudioContext,Fn(),Y=D.createGain(),Y.connect(D.destination),je(Pn),Y.gain.value=W(),document.addEventListener("gamestart",()=>{document.addEventListener("keydown",Mn)})}function ke(){return Y}function Fn(){let n=()=>{let e=D.createBufferSource();e.buffer=D.createBuffer(1,1,22050),e.connect(D.destination),e.start(),console.log("AudioContext unlocked"),window.removeEventListener("touchend",n),window.removeEventListener("mouseup",n)};window.addEventListener("touchend",n),window.addEventListener("mouseup",n)}function W(){return N?0:parseInt(L.value,10)/100}function je(n){s("#volume-control").addEventListener("volumechange",n)}function zt(){L.hidden=!0}function Nt(){D.suspend(),setTimeout(()=>D.resume(),0)}function Wt(n){N=!N,N?(s("#volume-control-icon").classList.remove("fa-volume-up"),s("#volume-control-icon").classList.add("fa-volume-off"),L.value="0"):(s("#volume-control-icon").classList.remove("fa-volume-off"),s("#volume-control-icon").classList.add("fa-volume-up"),L.value=String(Math.round(Q*100))),Gt()}function Cn(n){Q=parseInt(L.value,10)/100,Q>0&&N&&(N=!1,s("#volume-control-icon").classList.remove("fa-volume-off"),s("#volume-control-icon").classList.add("fa-volume-up")),Gt()}function Tn(n){u.volume=Q,u.persist()}function Gt(){let n=new CustomEvent("volumechange",{detail:W()});s("#volume-control").dispatchEvent(n)}function Pn(n){Y.gain.value=n.detail}function Mn(n){n.keyCode===77&&Wt(n)}Dn();var d=s("audio"),Ot,G=null,_e,te=1,ee,w=null,Ke=class{constructor(e,t){let r=performance.now(),i=te;this.done=new le,this.timer=setInterval(()=>{let a=performance.now()-r;te=a>=e?t:i+a/e*(t-i),d.volume=W()*te,a>=e&&(clearInterval(this.timer),this.timer=void 0,this.done.resolve())},10)}cancel(){clearInterval(this.timer),this.timer=void 0,this.done.resolve()}wait(){return this.done.promise}};function Bn(){_e=!ue(),je(Nn),d.volume=W(),d.addEventListener("error",Gn),d.addEventListener("ended",Wn),Vt(!0),_e||(zt(),d.volume===0&&(w=()=>{}))}function Ae(n){Ot=n}function Un(n,e){Ae(new E(new R(n,e)))}function Ht(n,e){if(G=n,w){w=()=>{Ht(n,e)};return}d.currentTime=0,Ot.getCDDA(n,d).then(t=>zn(t,e),t=>gtag("event","InvalidTrack",{event_category:"CDDA"}))}async function Rn(n){n&&await $t(n,0),d.pause(),G=null,w&&(w=()=>{})}async function $t(n,e){if(_e){if(ee&&(ee.cancel(),ee=void 0),n<=0){te=e,d.volume=W()*te;return}return ee=new Ke(n,e),ee.wait()}}function In(){if(!G)return 0;let n=Math.round(d.currentTime*75);return(w||d.error)&&(n+=750),G|n<<8}function zn(n,e){d.setAttribute("src",n),d.loop=e!==0,d.load(),d.play().catch(t=>{if(!(t.message.startsWith("The play() request was interrupted")||t.name==="AbortError"))if(t.name==="NotAllowedError"||t.message.indexOf("gesture")>=0)Vt(!1),gtag("event","UnlockAgain",{event_category:"CDDA"});else{let{name:r,message:i}=t;b({type:"CDDA",name:r,message:i})}})}function Nn(n){if(_e){d.volume=n.detail;return}let e=n.detail===0;if(!!w!==e)if(e)d.pause(),w=()=>{d.play()};else{let t=w;w=null,t()}}function Wn(n){G=null,w&&(w=()=>{})}function Gn(n){if(d.error){let{code:e,message:t}=d.error;b({type:"Audio",code:e,message:t})}else b({type:"Audio",code:"unknown"})}function Vt(n){let e=()=>{n?G||(d.load(),console.log("CDDA unlocked")):d.play(),window.removeEventListener("touchend",e),window.removeEventListener("mouseup",e)};window.addEventListener("touchend",e),window.addEventListener("mouseup",e)}Bn();var Fe={};se(Fe,{fadeStart:()=>Kn,getPosition:()=>Vn,getVolume:()=>Zn,init:()=>Xe,isFading:()=>qn,pause:()=>Hn,play:()=>On,resume:()=>$n,setVolume:()=>jn,stop:()=>Je});var f,k,De=!1,jt=0,O=null;function Xe(n){Module.addRunDependency("timidity"),v("/timidity/timidity.js").then(()=>{k=n.context.createGain(),k.connect(n),f=new Timidity(k,"/timidity/"),f.on("playing",Jn),f.on("error",Xn),f.on("ended",Yn),Module.removeRunDependency("timidity")})}function On(n,e,t){f&&(f.load(Module.HEAPU8.slice(e,e+t)),f.play(),De=!0)}function Je(){f&&(De=!1,f.pause())}function Hn(){f&&f.pause()}function $n(){f&&f.play()}function Vn(){return f?Math.round(f.currentTime*1e3):0}function jn(n){f&&(k.gain.value=n/100)}function Zn(){return f?k.gain.value*100:100}function Kn(n,e,t){f&&(k.gain.cancelScheduledValues(k.context.currentTime),O!==null&&(clearTimeout(O),O=null),!(n===0&&e===100&&(O||!De))&&(k.gain.linearRampToValueAtTime(e/100,k.context.currentTime+n/1e3),jt=performance.now()+n,t&&(n===0?Je():O=setTimeout(()=>{Je(),O=null},n))))}function qn(){return f&&performance.now()<jt?1:0}function Jn(n){n&&k.gain.setValueAtTime(1,n)}function Xn(n){console.warn(n),b(n)}function Yn(){De&&f.play()}var ne,Ce,Zt=[],Ye=!1;function Qn(){s("#fileselect").addEventListener("change",er,!1),document.body.ondragover=tr,document.body.ondrop=nr}function er(n){let e=n.target;Qe(e.files),e.value=""}function tr(n){n.stopPropagation(),n.preventDefault(),n.dataTransfer.dropEffect="copy"}function nr(n){var t;n.stopPropagation(),n.preventDefault();let e=(t=n.dataTransfer)==null?void 0:t.items;if(e){if(e.length===1){let r=e[0].webkitGetAsEntry();if(r!=null&&r.isDirectory){rr(r);return}}Qe(n.dataTransfer.files)}}async function rr(n){let e=[];async function t(r,i){let a=await new Promise((o,l)=>r.createReader().readEntries(o,l));for(let o of a)if(o.isDirectory&&i>0)await t(o,i-1);else if(o.isFile){let l=await new Promise((c,p)=>o.file(c,p));e.push(l)}}await t(n,1),Qe(e)}async function Qe(n){if(Ye||n.length===0)return;let e=!1,t=!1;for(let i of n)ir(i)?(ne=i,s("#imgReady").classList.remove("notready"),s("#imgReady").textContent=i.name,t=!0):ar(i)?(Ce=i,s("#cueReady").classList.remove("notready"),s("#cueReady").textContent=i.name,t=!0):(i.name.match(/\.(ald|ain)$/i)||i.name.toLowerCase()==="adisk.dat")&&(e=!0,Zt.push(i));let r=null;if(ne&&(Ce||ne.name.toLowerCase().endsWith(".iso"))?r=new xe(ne,Ce,Zt):!ne&&!Ce&&(n.length==1&&n[0].name.toLowerCase().endsWith(".zip")?r=new Ee(n[0]):n.length==1&&n[0].name.match(/\.(rar|7z)$/i)?r=new Le(n[0]):n.length>2&&e&&(r=new Se(n))),!r){t||y(`${n[0].name}: ${m.unrecognized_format}`,"warning");return}Ye=!0;try{await r.startLoad(),Ae(r.getCDDALoader()),or(r.hasMidi)}catch(i){i instanceof I?(gtag("event","NoGamedata",{event_category:"Loader",event_label:i.message}),y(`${m.cannot_install}: ${i.message}`,"warning")):i instanceof Error&&(gtag("event","LoadFailed",{event_category:"Loader",event_label:i.message}),y(`${m.cannot_install}: ${m.unrecognized_format}`,"warning"))}Ye=!1}function ir(n){let e=n.name.toLowerCase();return e.endsWith(".img")||e.endsWith(".mdf")||e.endsWith(".iso")}function ar(n){let e=n.name.toLowerCase();return e.endsWith(".cue")||e.endsWith(".ccd")||e.endsWith(".mds")}function or(n){n&&Xe(ke()),s("#xsystem35").hidden=!1,document.body.classList.add("game"),s("#toolbar").classList.remove("before-game-start"),window.onbeforeunload=sr,setTimeout(()=>{Module.arguments.push(u.antialias?"-antialias":"-noantialias"),Module.arguments.push("-fm"),Module.removeRunDependency("gameFiles"),document.dispatchEvent(new Event("gamestart"))},0)}function sr(n){u.unloadConfirmation&&(n.returnValue=m.unload_confirmation,Nt())}Qn();var F=s("#canvas"),tt=s("#zoom"),re=s("#pixelate"),et=!1;function lr(){tt.addEventListener("change",nt),tt.value=u.zoom,CSS.supports("image-rendering","pixelated")||CSS.supports("image-rendering","-moz-crisp-edges")?(re.addEventListener("change",Kt),u.pixelate&&(re.checked=!0,Kt())):re.setAttribute("disabled","true"),screen.orientation&&screen.orientation.addEventListener("change",()=>{screen.orientation.type.startsWith("landscape")?ur():dr()}),window.addEventListener("resize",cr)}function nt(){let n=tt.value;u.zoom=n,u.persist();let e=s(".navbar").style;if(n==="fit")s("#xsystem35").classList.add("fit"),e.maxWidth="none",F.style.width="";else{s("#xsystem35").classList.remove("fit");let t=Number(n);e.maxWidth=F.style.width=F.width*t+"px"}}function cr(){et||(et=!0,window.requestAnimationFrame(()=>{rt(),et=!1}))}function rt(){let n=s(".contents"),e=s("#xsystem35"),t=n.offsetWidth/n.offsetHeight;if(!t)return;let r=F.width/F.height;t<r?(e.classList.add("letterbox"),e.classList.remove("pillarbox")):(e.classList.remove("letterbox"),e.classList.add("pillarbox"))}function Kt(){u.pixelate=re.checked,u.persist(),re.checked?F.classList.add("pixelated"):F.classList.remove("pixelated")}function ur(){let n=document.documentElement;n.requestFullscreen?n.requestFullscreen():n.webkitRequestFullScreen&&n.webkitRequestFullScreen()}function dr(){document.exitFullscreen?document.fullscreenElement&&document.exitFullscreen():document.webkitExitFullscreen&&document.webkitFullscreenElement&&document.webkitExitFullscreen()}lr();var at={};se(at,{enable_audio_hook:()=>Ar,pcm_fadeout:()=>wr,pcm_getpos:()=>xr,pcm_getwavelen:()=>Er,pcm_isplaying:()=>Lr,pcm_load:()=>gr,pcm_load_data:()=>br,pcm_load_mixlr:()=>vr,pcm_reset:()=>hr,pcm_setvol:()=>Sr,pcm_start:()=>yr,pcm_stop:()=>Me,pcm_unload:()=>Jt,pcm_waitend:()=>kr});var fr=1+128,h=[],C=new Array(fr).fill(1),x=[],_=ke();function pr(){document.addEventListener("visibilitychange",_r)}async function it(n){let e=me(2,n-1);if(!e)throw new Error("Failed to open wave "+n);_.context.resume();let t=await qt(e.data);return x[n]=t,t}async function qt(n){try{return await _.context.decodeAudioData(n)}catch(e){let t=new Uint8Array(n);if(t[0]===79&&t[1]===103&&t[2]===103&&t[3]===83){await v("lib/stbvorbis-0.2.2.js");let r=[],i=0;return new Promise((a,o)=>{stbvorbis.decode(n,l=>{if(l.error)o(l.error);else if(!l.eof)r.length===0&&(i=l.sampleRate),r.push(l.data);else{let c=r[0].length,p=r.reduce((g,A)=>g+A[0].length,0),S=_.context.createBuffer(c,p,i);for(let g=0;g<c;g++){let A=S.getChannelData(g),ae=0;for(let oe of r)A.set(oe[g],ae),ae+=oe[g].length}a(S)}})})}throw e}}function hr(){for(let n=0;n<h.length;n++)Jt(n)}function gr(n,e){return Asyncify.handleSleep(t=>{if(Me(n),x[e])return h[n]=new ie(_,x[e],C[n]),t(0);it(e).then(r=>{h[n]=new ie(_,r,C[n]),t(0)},r=>{b({type:"PCM",err:r}),t(-1)})})}function br(n,e,t){return Asyncify.handleSleep(r=>{Me(n),qt(Module.HEAPU8.slice(e,e+t).buffer).then(i=>{h[n]=new ie(_,i,C[n]),r(0)},i=>{b({type:"PCM",err:i}),r(-1)})})}function vr(n,e,t){return Asyncify.handleSleep(r=>{if(Me(n),x[e]&&x[t])return h[n]=new Pe(_,x[e],x[t],C[n]),r(0);let i=[x[e]?Promise.resolve(x[e]):it(e),x[t]?Promise.resolve(x[t]):it(t)];Promise.all(i).then(a=>{h[n]=new Pe(_,a[0],a[1],C[n]),r(0)}).catch(a=>{b({type:"PCM",err:a}),r(-1)})})}function Jt(n){let e=h[n];return e?(e.stop(),h[n]=null,0):-1}function yr(n,e){let t=h[n];return t?(t.start(e),0):(console.log("pcm_start: invalid slot",n),-1)}function Me(n){let e=h[n];return e?(e.stop(),n===0&&(h[n]=null),0):-1}function wr(n,e){let t=h[n];return t?(e===0?t.stop():t.fadeout(e),0):-1}function xr(n){let e=h[n];return e?e.getPosition()*1e3:0}function Sr(n,e){C[n]=e/100;let t=h[n];return t&&t.setGain(C[n]),0}function Er(n){let e=h[n];return e?e.duration*1e3:0}function Lr(n){let e=h[n];return e?e.isPlaying()?1:0:0}function kr(n){return Asyncify.handleSleep(e=>{let t=h[n];if(!t||!t.isPlaying())return e(0);t.end_callback=()=>e(0)})}function _r(){document.hidden&&(x=[])}var Te=class{constructor(e,t){this.dst=e;this.end_callback=null;this.startTime=null;this.context=e.context,this.gain=this.context.createGain(),this.setGain(t),this.gain.connect(e)}setGain(e){this.gain.gain.value=e}fadeout(e){this.gain.gain.linearRampToValueAtTime(0,this.context.currentTime+e/1e3),this.stop(e)}getPosition(){return this.startTime===null?0:this.context.currentTime-this.startTime}isPlaying(){return this.startTime!==null}ended(){this.startTime=null,this.end_callback&&(this.end_callback(),this.end_callback=null)}},ie=class extends Te{constructor(t,r,i){super(t,i);this.buf=r}start(t){this.node=this.context.createBufferSource(),this.node.buffer=this.buf,this.node.connect(this.gain),this.node.onended=this.onended.bind(this),t!==1&&(this.node.loop=!0),t<=1?this.node.start():this.node.start(0,0,this.buf.duration*t),this.startTime=this.context.currentTime}stop(t){this.startTime!==null&&this.node.stop(t?this.context.currentTime+t/1e3:void 0)}get duration(){return this.buf.duration}onended(){this.ended()}},Pe=class extends Te{constructor(t,r,i,a){super(t,a);this.endCount=0;this.lsrc=this.context.createBufferSource(),this.rsrc=this.context.createBufferSource(),this.lsrc.buffer=r,this.rsrc.buffer=i;let o=this.context.createChannelMerger(2);o.connect(this.gain),this.lsrc.connect(o,0,0),this.rsrc.connect(o,0,1),this.lsrc.onended=this.rsrc.onended=this.onended.bind(this)}start(t){t!==1&&console.warn("PCMSoundMixLR: loop is not supported "+t),this.lsrc.start(),this.rsrc.start(),this.startTime=this.context.currentTime}stop(t){if(this.startTime!==null){let r=t?this.context.currentTime+t/1e3:void 0;this.lsrc.stop(r),this.rsrc.stop(r)}}get duration(){return Math.max(this.lsrc.buffer.duration,this.rsrc.buffer.duration)}onended(){this.endCount++,this.endCount===2&&this.ended()}},H;function Ar(){if(!H){H=_.context.createScriptProcessor(4096,0,2);let e=Module._malloc(4096*2*2);H.addEventListener("audioprocess",t=>{let r=t.outputBuffer.getChannelData(0),i=t.outputBuffer.getChannelData(1);if(_audio_callback(e,4096))for(let a=0;a<4096;a++)r[a]=Module.HEAP16[(e>>1)+a*2]/32768,i[a]=Module.HEAP16[(e>>1)+a*2+1]/32768;else for(let a=0;a<4096;a++)r[a]=i[a]=0}),H.connect(_)}return H.context.resume(),H.context.sampleRate}pr();var dt={};se(dt,{disableWheelEvent:()=>Ur,keywait:()=>Pr,message:()=>Cr,newline:()=>ct,nextpage:()=>Tr,setTitle:()=>ut});var Dr=2e3,Xt=0,Fr=[["ＲＡＮＣＥ",[2]],["ＲＡＮＣＥ２",[2]],["Ｒａｎｃｅ３",[1]],[/^(Ｒａｎｃｅ４　－教団の遺産－　Ｆｏｒ　Ｗｉｎ９５|Rance4 -Legacy of the Sect- For Win95|RanceⅣ　－教団の遺産－　for Windows|Rance4 -Legacy of the Sect- for Windows)$/,[10,11,16,88,90,98]],["ランス 4.1 〜お薬工場を救え！〜",[6]],["ランス 4.2 〜エンジェル組〜",[7]],["Rance4.1 for System3.9",[2,7]],["Rance4.2 for System3.9",[2,8]],[/^(鬼畜王ランス|Kichikuou Rance)$/,[7,11,15,16,17,18,23,24,32,33,197]],["闘神都市",[1]],["闘神都市Ⅱ　ｆｏｒ　Ｗｉｎ９５",[4,5,6,7,8]],["あゆみちゃん物語",[6]],[/^グレイメルカ ver1\./,[1,2,5,6]]],T=s("#textlog-content");s("#textlog-button").addEventListener("click",lt);s("#textlog-close").addEventListener("click",Be);s("#textlog-overlay").addEventListener("click",Be);document.addEventListener("gamestart",()=>{document.addEventListener("keydown",n=>{n.keyCode===76?lt():n.keyCode===27&&Be()})});s("#canvas").addEventListener("wheel",n=>{performance.now()<Xt||n.deltaY<=0&&lt()});T.addEventListener("wheel",n=>{n.deltaY>0&&T.scrollTop+T.clientHeight>=T.scrollHeight&&Be()});function lt(){let n=s("#textlog-modal").classList;n.contains("active")||(Mr(T),n.add("active"),T.scrollTop=T.scrollHeight)}function Be(){s("#textlog-modal").classList.remove("active")}var ot=-1,$="",V=[],st=[],Yt=P.get("consoleTextLog")==="1";function Cr(n,e){$===""&&(ot=e),$+=n}function ct(){$!==""&&(Br(ot)||(Yt&&console.log(ot+": "+$),Qt($)),$="")}function Tr(){ct(),V[V.length-1]!==""&&(Yt&&console.log(""),Qt(""))}function Pr(){ct()}function Mr(n){n.textContent=V.join(`
`)}function ut(n){for(let[e,t]of Fr)if(e instanceof RegExp?e.test(n):e===n){st=t;return}st=[]}function Qt(n){V.push(n),V.length>Dr&&V.shift()}function Br(n){return st.includes(n)}function Ur(n){Xt=performance.now()+n}var mt=class{constructor(){let e=m;window.onerror=(t,r,i,a,o)=>{let l=en();b({type:"onerror",message:t,url:r,line:i,column:a,address:l},!0),y(e.error_occurred,"error"),window.onerror=null},window.addEventListener("unhandledrejection",t=>{let r=t.reason,i=en();if(console.log(i,r),r instanceof Error){let{name:a,message:o,stack:l}=r;b({type:"rejection",name:a,message:o,stack:l,address:i},!0),a==="RuntimeError"&&y(e.error_occurred,"error")}else b({type:"rejection",name:r.constructor.name,reason:r,address:i},!0)})}windowSizeChanged(){nt(),rt()}setWindowTitle(e){let t=e.indexOf(":");t!==-1&&(e=e.slice(t+1).trim(),ut(e),s(".navbar-brand").textContent=e,gtag("event","GameStart",{GameTitle:e,event_category:"Game",event_label:e}))}showMouseMoveEffect(e,t){let r=s("#canvas"),i=r.getBoundingClientRect(),a=32,o=i.left+e*i.width/r.width-a/2,l=i.top+t*i.height/r.height-a/2,c=document.createElement("div");c.classList.add("ripple"),c.style.width=`${a}px`,c.style.height=`${a}px`,c.style.left=`${o}px`,c.style.top=`${l}px`,document.body.appendChild(c),c.addEventListener("animationend",function(){var p;(p=c.parentElement)==null||p.removeChild(c)})}inputString(e,t,r){e+=" ("+m.input_char_limit(r)+")";let i=window.prompt(e,t);return i&&(i=i.substring(0,r)),i}inputNumber(e,t,r,i){e+=` (${t}-${r})`;let a=window.prompt(e,i+"");if(a){let o=parseInt(a);if(t<=o&&o<=r)return o}return-1}setSkipButtonState(e,t){vt(e,t)}quit(){y(m.game_over),gtag("event","GameEnd",{event_category:"Game"}),window.onbeforeunload=null}syncfs(e=100){Ct(e)}};function en(){if(window._nact_current_page)return _nact_current_page()+":"+_nact_current_addr().toString(16)}var Rr=new mt,Ir={Status:K,shell:Rr,cdPlayer:qe,midiPlayer:Fe,audio:at,texthook:dt,load_mincho_font:Tt};window.xsystem35=Ir;typeof WebAssembly!="object"&&(document.getElementById("unsupported").hidden=!1);document.addEventListener("gamestart",()=>{let n=s("#xsystem35");n.addEventListener("touchstart",e=>{e.target===n&&_simulate_right_button(1)}),n.addEventListener("touchend",e=>{e.target===n&&_simulate_right_button(0)})});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js")});window.addEventListener("beforeinstallprompt",n=>{n.userChoice.then(e=>{gtag("event","InstallPrompt",{event_category:"App",event_label:e.outcome})})});
//# sourceMappingURL=shell.js.map
