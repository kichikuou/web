var tr=Object.defineProperty;var ne=(t,e)=>{for(var r in e)tr(t,r,{get:e[r],enumerable:!0})};var o=document.querySelector.bind(document),M=new URLSearchParams(location.search.slice(1)),T="lib/jszip.3.1.3.min.js",ot=new Map;function b(t){let e=ot.get(t);if(!e){let r=document.createElement("script");r.src=t,e=new Promise((n,i)=>{r.addEventListener("load",n,{once:!0}),r.addEventListener("error",i,{once:!0})}),document.body.appendChild(r),ot.set(t,e)}return e}function ie(t,e){try{(e||FS).mkdir(t)}catch(r){}}function ae(t,e){let r=navigator.userAgent.match(/OS ([0-9_]+) like Mac OS X\)/);if(!r)return!1;let n=r[1].replace(/_/g,".");return(!t||t<=n)&&(!e||n<e)}function O(t,e){return new Blob([t],{type:rr(e)})}function rr(t){let e=t.toLowerCase();return e.endsWith(".wav")?"audio/wav":e.endsWith(".ogg")?"audio/ogg":e.endsWith(".mp3")?"audio/mpeg":""}function oe(){let t={};return typeof TextDecoder!="undefined"&&(t={decodeFileName:e}),t;function e(r){try{return new TextDecoder("utf-8",{fatal:!0}).decode(r)}catch(n){return new TextDecoder("shift_jis",{fatal:!0}).decode(r)}}}function H(t,e,r,n){let i=new ArrayBuffer(44),a=new DataView(i);return a.setUint32(0,1380533830,!1),a.setUint32(4,r+36,!0),a.setUint32(8,1463899717,!1),a.setUint32(12,1718449184,!1),a.setUint32(16,16,!0),a.setUint16(20,1,!0),a.setUint16(22,e,!0),a.setUint32(24,t,!0),a.setUint32(28,t*e*2,!0),a.setUint16(32,e*2,!0),a.setUint16(34,16,!0),a.setUint32(36,1684108385,!1),a.setUint32(40,r,!0),n.unshift(i),new Blob(n,{type:"audio/wav"})}var Le=class{constructor(){this.promise=new Promise((e,r)=>{this._resolve=e,this._reject=r})}resolve(e){this._resolve(e)}reject(e){this._reject(e)}};function B(t){let e=t+"-start",r=t+"-end";return performance.mark(e),()=>{performance.mark(r),performance.measure(t,e,r)}}function h(t,e=!1){let r=JSON.stringify(t,(n,i)=>i instanceof DOMException?{DOMException:i.name,message:i.message}:i);gtag("event","exception",{description:r,fatal:e})}var $=(r=>(r[r.OK=0]="OK",r[r.NG=-1]="NG",r))($||{});function se(t,e){let r=_ald_getdata(t,e);if(!r)return null;let n=Module.getValue(r+8,"*"),i=Module.getValue(r,"i32"),a=nr(Module.getValue(r+12,"*")),s=Module.HEAPU8.buffer.slice(n,n+i);return _ald_freedata(r),{name:a,data:s}}function nr(t){let e="";for(;;){let r=Module.HEAPU8[t++];if(!r)break;e+=String.fromCharCode(r)}return e}var st=class{constructor(){this.antialias=!0;this.pixelate=!1;this.unloadConfirmation=!0;this.volume=1;this.zoom="fit";this.messageSkipFlags=14;let e=localStorage.getItem("KichikuouWeb.Config");if(e){let r=JSON.parse(e);r.antialias!==void 0&&(this.antialias=r.antialias),r.pixelate!==void 0&&(this.pixelate=r.pixelate),r.unloadConfirmation!==void 0&&(this.unloadConfirmation=r.unloadConfirmation),r.volume!==void 0&&(this.volume=r.volume),r.zoom!==void 0&&(this.zoom=r.zoom),r.messageSkipFlags!=null&&(this.messageSkipFlags=r.messageSkipFlags)}}persist(){localStorage.setItem("KichikuouWeb.Config",JSON.stringify({antialias:this.antialias,pixelate:this.pixelate,unloadConfirmation:this.unloadConfirmation,volume:this.volume,zoom:this.zoom,messageSkipFlags:this.messageSkipFlags}))}},c=new st;function v(t,e){let r=o(".toast-container"),n=document.createElement("div");n.classList.add("toast"),e&&n.classList.add("toast-"+e),typeof t=="string"?n.innerText=t:n.appendChild(t);let i=document.createElement("button");i.setAttribute("class","btn btn-clear float-right");function a(){n.parentNode===r&&r.removeChild(n)}i.addEventListener("click",a);let s=e?{success:5e3,warning:1e4,error:null}[e]:5e3;return s&&setTimeout(a,s),n.insertBefore(i,n.firstChild),r.insertBefore(n,r.firstChild),n}function le(){return new Promise(t=>{let e=document.createElement("input");e.type="file",e.addEventListener("change",r=>{document.body.removeChild(e),t(e.files[0])}),e.style.display="none",document.body.appendChild(e),e.click()})}function ce(t,e,r){let n=document.createElement("a");n.setAttribute("download",t),n.setAttribute("href",e),r&&n.setAttribute("target",r),document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n)},5e3)}var ct={cannot_install:"Cannot install",error_occurred:"An error occurred.",game_over:"The game is over.",input_char_limit:t=>`Up to ${t} characters`,module_load_failed:t=>`Failed to load ${t}. Please reload the page.`,no_ald_in_zip:"No game files (*.ALD/*.DAT) in the zip file.",no_gamedata_dir:"No GAMEDATA folder in the image.",floppy_images_cant_be_used:"Floppy disk images cannot be loaded.",restart_confirmation:"Restart the game?",restore_success:"Save files has been restored successfully.",restore_failure:"Save files could not be restored.",unload_confirmation:"Unsaved data will be lost.",unrecognized_format:"Unrecognized format."},ir={cannot_install:"インストールできません",error_occurred:"エラーが発生しました。",game_over:"ゲームは終了しました。",input_char_limit:t=>`全角${t}文字まで`,module_load_failed:t=>t+"の読み込みに失敗しました。リロードしてください。",no_ald_in_zip:"ZIP内にゲームデータ (*.ALD/*.DATファイル) が見つかりません。",no_gamedata_dir:"イメージ内にGAMEDATAフォルダが見つかりません。",floppy_images_cant_be_used:"フロッピーディスクイメージは読み込めません。Windows版のデータを使用してください。",restart_confirmation:"ゲームを再起動しますか？",restore_success:"セーブデータの復元に成功しました。",restore_failure:"セーブデータを復元できませんでした。",unload_confirmation:"セーブしていないデータは失われます。",unrecognized_format:"認識できない形式です。"},lt={en:ct,ja:ir};function ar(){let t=document.documentElement.getAttribute("lang");return t&&lt[t]?lt[t]:ct}var d=ar();var ue=o("#msgskip-button");function or(){o("#restart-button").addEventListener("click",pt),o("#screenshot-button").addEventListener("click",ht),ue.addEventListener("click",ft),document.addEventListener("gamestart",()=>{document.addEventListener("keydown",lr)})}function dt(){o("#toolbar-handler").addEventListener("click",sr),o("#toolbar-close-button").addEventListener("click",ut),o("#toolbar").classList.add("closeable"),ut()}function sr(){o("#toolbar").classList.remove("closed")}function ut(){o("#toolbar").classList.add("closed")}function lr(t){switch(t.keyCode){case 80:ht();break;case 82:pt();break;case 83:ft();break}}function mt(t,e){ue.classList.toggle("disabled",!t),ue.classList.toggle("activated",!!e)}function ft(){_msgskip_activate(ue.classList.contains("activated")?0:1)}function pt(){window.confirm(d.restart_confirmation)&&(gtag("event","Restart",{event_category:"Toolbar"}),_sys_restart())}async function ht(){let t=_sdl_getDisplaySurface(),e=document.createElement("canvas");e.width=Module.canvas.width,e.height=Module.canvas.height;let r=e.getContext("2d"),n=r.createImageData(e.width,e.height),i=n.data,a=n.data.length;for(let l=0;l<a;l+=4)i[l]=Module.HEAPU8[t+2],i[l+1]=Module.HEAPU8[t+1],i[l+2]=Module.HEAPU8[t],i[l+3]=255,t+=4;r.putImageData(n,0,0);let s=await new Promise(l=>e.toBlob(l));!s||ce(cr(),URL.createObjectURL(s),"_blank")}function cr(){let t=new Date,e=("0"+(t.getMonth()+1)).slice(-2),r=("0"+t.getDate()).slice(-2),n=("0"+t.getHours()).slice(-2),i=("0"+t.getMinutes()).slice(-2),a=("0"+t.getSeconds()).slice(-2);return"Screenshot-"+t.getFullYear()+e+r+"-"+n+i+a+".png"}or();var bt="MTLc3m.ttf",vt="mincho.otf",St,ur=new Promise(t=>{St=t}),Et,de=new Promise(t=>{Et=t});function dr(){window.Module={},Module.arguments=[];for(let[t,e]of M)t.startsWith("-")&&(Module.arguments.push(t),e&&Module.arguments.push(e));Module.print=Module.printErr=console.log.bind(console),Module.canvas=document.getElementById("canvas"),Module.preRun=[()=>{Module.addRunDependency("gameFiles")},St,function(){FS.mkdir("/fonts"),FS.createPreloadedFile("/fonts",bt,"fonts/"+bt,!0,!1)},function(){FS.mkdir("/save"),FS.mount(IDBFS,{},"/save"),Module.addRunDependency("syncfs"),FS.syncfs(!0,e=>{Module.removeRunDependency("syncfs"),Et(FS)})},()=>{window.setWindowTitle=()=>{}}]}function ke(t){o("#loader").classList.add("module-loading");let e=t+".js",r=document.createElement("script");r.src=e,r.onerror=()=>{gtag("event","ModuleLoadFailed",{event_category:"Game",event_label:e}),v(d.module_load_failed(e),"error")},document.body.appendChild(r);let n=B("ModuleLoad");return ur.then(()=>{n(),o("#loader").hidden=!0,document.body.classList.add("bgblack-fade"),dt()})}var yt;function Lt(t){window.clearTimeout(yt),yt=window.setTimeout(()=>{FS.syncfs(!1,e=>{e&&console.log("FS.syncfs error: ",e)})},t),mr()}var wt=!1;async function mr(){if(wt||!(navigator.storage&&navigator.storage.persist)||(wt=!0,await navigator.storage.persisted()))return;let t=await navigator.storage.persist()}var xt=!1;function kt(){return xt?Promise.resolve(0):(xt=!0,new Promise(t=>{console.log("loading mincho font");let e=B("FontLoad");readAsync("fonts/"+vt,r=>{e(),FS.writeFile("/fonts/"+vt,new Uint8Array(r)),t(0)},()=>{t(-1)})}))}dr();var Ae=class{constructor(){window.FS&&(this.FSready=de),this.FSready||(this.FSready=(async()=>(await b("fslib.js"),(await FSLib()).saveDirReady))()),b(T)}hasSaveData(){function e(r,n){if(!r.isDir(r.stat(n).mode))return!1;for(let i of r.readdir(n))if(i[0]!=="."&&(i.toLowerCase().endsWith(".asd")||i.toLowerCase().endsWith(".dat")||e(r,n+"/"+i)))return!0;return!1}return this.FSready.then(r=>e(r,"/save"))}async download(){await b(T);let e=new JSZip;Dt(await this.FSready,"/save",e.folder("save"));let r=await e.generateAsync({type:"blob",compression:"DEFLATE"});ce("savedata.zip",URL.createObjectURL(r)),gtag("event","Downloaded",{event_category:"Savedata"})}async extract(e){try{let r=await this.FSready;if(e.name.toLowerCase().endsWith(".asd"))At(r,"/save/"+e.name,await e.arrayBuffer());else{await b(T);let n=new JSZip;await n.loadAsync(await e.arrayBuffer(),oe());let i=[];n.folder("save").forEach((a,s)=>{i.push(s)});for(let a of i)a.dir?ie("/"+a.name.slice(0,-1),r):At(r,"/"+a.name,await a.async("arraybuffer"))}await new Promise((n,i)=>{r.syncfs(!1,a=>{a?i(a):n(void 0)})}),v(d.restore_success,"success"),gtag("event","Restored",{event_category:"Savedata"})}catch(r){if(v(d.restore_failure,"error"),console.warn(r),r instanceof Error)gtag("event","RestoreFailed",{event_category:"Savedata",event_label:r.message});else throw r}}};function Dt(t,e,r){for(let n of t.readdir(e)){let i=e+"/"+n;if(n[0]!=="."){if(t.isDir(t.stat(i).mode))Dt(t,i,r.folder(n));else if(!n.toLowerCase().endsWith(".asd.")){let a=t.readFile(i,{encoding:"binary"});r.file(n,a)}}}}function At(t,e,r){t.writeFile(e,new Uint8Array(r))}var _e=o("#antialias"),Fe=o("#unload-confirmation"),me={"#msgskip-skip-unseen":1,"#msgskip-stop-on-unseen":2,"#msgskip-stop-on-menu":4,"#msgskip-stop-on-click":8},j=null,Ce;function fr(){o("#settings-button").addEventListener("click",hr),o("#settings-close").addEventListener("click",De),Ce=t=>{t.keyCode===27&&De()},o("#settings-overlay").addEventListener("click",De),_e.addEventListener("change",gr),_e.checked=c.antialias,Fe.addEventListener("change",br),Fe.checked=c.unloadConfirmation;for(let t in me){let e=o(t);e.addEventListener("change",_t),e.checked=!!(c.messageSkipFlags&me[t])}o("#msgskip-stop-on-unseen").toggleAttribute("disabled",o("#msgskip-skip-unseen").checked),o("#downloadSaveData").addEventListener("click",vr),o("#uploadSaveData").addEventListener("click",yr),document.addEventListener("gamestart",pr)}function pr(){_t()}function hr(){o("#settings-modal").classList.add("active"),document.addEventListener("keydown",Ce),j=new Ae,Ft()}function De(){o("#settings-modal").classList.remove("active"),document.removeEventListener("keydown",Ce),j=null}function gr(){c.antialias=_e.checked,c.persist(),o("#xsystem35").hidden||_ags_setAntialiasedStringMode(c.antialias?1:0)}function br(){c.unloadConfirmation=Fe.checked,c.persist()}function _t(){let t=0;for(let e in me)o(e).checked&&(t|=me[e]);o("#msgskip-stop-on-unseen").toggleAttribute("disabled",o("#msgskip-skip-unseen").checked),window._msgskip_setFlags&&_msgskip_setFlags(t,4294967295),c.messageSkipFlags=t,c.persist()}async function Ft(){o("#downloadSaveData").hasAttribute("disabled")&&await j.hasSaveData()&&o("#downloadSaveData").removeAttribute("disabled")}async function vr(){j.download()}function yr(){le().then(t=>j.extract(t)).then(()=>Ft())}fr();var V=class{constructor(e,r){this.sectorReader=e;this.vd=r;this.decoder=new TextDecoder(r.encoding())}static async create(e){let r=null;for(let n=16;;n++){let i=new Ct(await e.readSector(n));switch(i.type){case fe.Primary:r||(r=i);break;case fe.Supplementary:i.encoding()&&(r=i);break;case fe.Terminator:if(!r)throw new Error("PVD not found");return new V(e,r)}}}volumeLabel(){return this.vd.volumeLabel(this.decoder)}rootDir(){return this.vd.rootDirEnt(this.decoder)}async getDirEnt(e,r){e=e.toLowerCase();for(let n of await this.readDir(r))if(n.name.toLowerCase()===e)return n;return null}async readDir(e){let r=e.sector,n=0,i=e.size,a=[],s;for(;n<i;){n===0&&(s=await this.sectorReader.readSector(r));let l=new Te(s,n,this.decoder);if(l.length===0?n=2048:(a.push(l),n+=l.length),n>2048)throw new Error("dirent across sector boundary");n===2048&&(r++,n=0,i-=2048)}return a}readFile(e){return this.sectorReader.readSequentialSectors(e.sector,e.size)}},fe=(n=>(n[n.Primary=1]="Primary",n[n.Supplementary=2]="Supplementary",n[n.Terminator=255]="Terminator",n))(fe||{}),Ct=class{constructor(e){this.buf=e;if(this.view=new DataView(e),Me(new Uint8Array(this.buf,1,5))!=="CD001")throw new Error("Not a valid CD image")}get type(){return this.view.getUint8(0)}volumeLabel(e){return e.decode(new DataView(this.buf,40,32)).trim()}encoding(){if(this.type===1)return"shift_jis";if(this.escapeSequence().match(/%\/[@CE]/))return"utf-16be"}escapeSequence(){return Me(new Uint8Array(this.buf,88,32)).trim()}rootDirEnt(e){return new Te(this.buf,156,e)}},Te=class{constructor(e,r,n){this.buf=e;this.offset=r;this.decoder=n;this.view=new DataView(e,r)}get length(){return this.view.getUint8(0)}get sector(){return this.view.getUint32(2,!0)}get size(){return this.view.getUint32(10,!0)}get isDirectory(){return(this.view.getUint8(25)&2)!==0}get name(){let e=this.view.getUint8(32),r=new DataView(this.buf,this.offset+33,e);if(e===1)switch(r.getUint8(0)){case 0:return".";case 1:return".."}return this.decoder.decode(r).split(";")[0]}};async function Pt(t,e){if(t.name.endsWith(".iso"))return new Mt(t);if(e)if(e.name.endsWith(".cue")){let r=new Pe(t);return await r.parseCue(e),r}else if(e.name.endsWith(".ccd")){let r=new Pe(t);return await r.parseCcd(e),r}else{let r=new Tt(t);return await r.parseMds(e),r}else throw new Error("No metadata file")}var pe=class{constructor(e){this.image=e}async readSequential(e,r,n,i,a){let s=Math.ceil(r/i),m=await this.image.slice(e,e+s*n).arrayBuffer(),y=[];for(let S=0;S<s;S++)y.push(new Uint8Array(m,S*n+a,Math.min(r,i))),r-=i;return y}reloadImage(){return le().then(e=>{this.image=e})}},Mt=class extends pe{readSector(e){return this.image.slice(e*2048,(e+1)*2048).arrayBuffer()}async readSequentialSectors(e,r){let n=e*2048,i=await this.image.slice(n,n+r).arrayBuffer();return[new Uint8Array(i)]}maxTrack(){return 1}extractTrack(e){throw"not implemented"}},Pe=class extends pe{constructor(e){super(e);this.tracks=[]}readSector(e){let r=e*2352+16,n=r+2048;return this.image.slice(r,n).arrayBuffer()}readSequentialSectors(e,r){return this.readSequential(e*2352,r,2352,2048,16)}async parseCue(e){let r=(await e.text()).split(`
`),n=null;for(let i of r){let a=i.trim().split(/\s+/);switch(a[0]){case"TRACK":n=Number(a[1]),this.tracks[n]={isAudio:a[2]==="AUDIO",index:[]};break;case"INDEX":n&&(this.tracks[n].index[Number(a[1])]=this.indexToSector(a[2]));break;default:}}}async parseCcd(e){let r=(await e.text()).split(`
`),n=null;for(let i of r){i=i.trim();let a=i.match(/\[TRACK ([0-9]+)\]/);if(a){n=Number(a[1]),this.tracks[n]={isAudio:!1,index:[]};continue}if(!n)continue;let s=i.split(/=/);switch(s[0]){case"MODE":this.tracks[n].isAudio=s[1]==="0";break;case"INDEX 0":this.tracks[n].index[0]=Number(s[1]);break;case"INDEX 1":this.tracks[n].index[1]=Number(s[1]);break;default:}}}maxTrack(){return this.tracks.length-1}async extractTrack(e){if(!this.tracks[e]||!this.tracks[e].isAudio)throw new Error("Invalid track "+e);let r=this.tracks[e].index[1]*2352,n;return this.tracks[e+1]?n=(this.tracks[e+1].index[0]||this.tracks[e+1].index[1])*2352:n=this.image.size,H(44100,2,n-r,[this.image.slice(r,n)])}indexToSector(e){let r=e.split(":").map(Number);return r[0]*60*75+r[1]*75+r[2]}};var Tt=class extends pe{constructor(e){super(e);this.tracks=[]}async parseMds(e){let r=await e.arrayBuffer();if(Me(new Uint8Array(r,0,16))!=="MEDIA DESCRIPTOR")throw new Error(e.name+": not a mds file");let a=new DataView(r,0,112).getUint8(98);if(112+a*88>r.byteLength)throw new Error(e.name+": unknown format");for(let s=0;s<a;s++){let l=new DataView(r,112+s*80,80),m=new DataView(r,112+a*80+s*8,8),y=l.getUint8(0),S=l.getUint8(4),g=l.getUint16(16,!0),A=l.getUint32(40,!0),re=m.getUint32(4,!0);S<100&&(this.tracks[S]={mode:y,sectorSize:g,offset:A,sectors:re})}if(this.tracks[1].mode!==170)throw new Error("track 1 is not mode1")}readSector(e){let r=e*this.tracks[1].sectorSize+16,n=r+2048;return this.image.slice(r,n).arrayBuffer()}readSequentialSectors(e,r){let n=this.tracks[1];return this.readSequential(n.offset+e*n.sectorSize,r,n.sectorSize,2048,16)}maxTrack(){return this.tracks.length-1}async extractTrack(e){if(!this.tracks[e]||this.tracks[e].mode!==169)throw new Error("Invalid track "+e);let r=this.tracks[e].sectors*2352,n=await this.readSequential(this.tracks[e].offset,r,this.tracks[e].sectorSize,2352,0);return H(44100,2,r,n)}};function Me(t){return String.fromCharCode.apply(null,t)}var D=class{constructor(e){this.source=e;this.cache=[],document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this)),ae()&&indexedDB.deleteDatabase("cdda")}async getCDDA(e,r){if(!this.cache[e]){let n=await this.source.extractTrack(e);n.type==="audio/ogg"&&!r.canPlayType("audio/ogg")&&(n=await xr(n)),this.cache[e]=URL.createObjectURL(n)}return this.lastTrack=e,this.cache[e]}onVisibilityChange(){if(!document.hidden)return;for(let r=0;r<this.cache.length;r++)r!==this.lastTrack&&this.cache[r]&&URL.revokeObjectURL(this.cache[r]);let e=[];this.lastTrack&&(e[this.lastTrack]=this.cache[this.lastTrack]),this.cache=e}},Z=class{constructor(e,r){this.type=e;this.base_no=r}async extractTrack(e){let r=se(this.type,e+this.base_no-1);if(!r)throw new Error("BGMLoader: Invalid track "+e);return O(r.data,r.name)}};async function xr(t){await b("lib/stbvorbis-0.2.2.js");let e=await t.arrayBuffer(),r=[],n=0,i=0,a=0;return new Promise((s,l)=>{stbvorbis.decode(e,m=>{if(m.error)l(m.error);else if(m.eof)s(H(n,i,a,r));else{r.length===0&&(n=m.sampleRate,i=m.data.length);let y=new Int16Array(m.data[0].length*i),S=0;for(let g=0;g<m.data[0].length;g++)for(let A=0;A<m.data.length;A++)y[S++]=m.data[A][g]*32767;r.push(y),a+=y.byteLength}})})}var Sr=240,Er=0,Lr=[[7272,84,71]],kr=[[2171,64,65],[7033,64,65],[93791,36,64],[93792,174,146],[93793,6,5]];function Bt(t,e,r){let n=null;switch(t.toUpperCase()){case"ぱすてるSA.ALD":n=Lr;break;case"鬼畜王SA.ALD":M.get("tada")==="1"&&(n=kr);break}let i="/"+t;if(t.match(/\.(ald|ain|alk|kld)$/i)){let s=FS.makedev(Sr,Er++),l=new Ut(e,r,n);FS.registerDevice(s,l),FS.mkdev(i,s)}else{var a=FS.open(i,"w");for(let s of r)FS.write(a,s,0,s.byteLength);FS.close(a)}}var Ut=class{constructor(e,r,n){this.size=e;this.patchTbl=n;this.chunks=r}read(e,r,n,i,a){if(r!==Module.HEAP8)throw new Error("Invalid argument");this.addr===void 0&&this.load();let s=this.addr+a;return i=Math.min(i,this.size-a),Module.HEAP8.set(Module.HEAPU8.subarray(s,s+i),n),i}llseek(e,r,n){let i=r;return n===1?i+=e.position:n===2&&(i+=this.size),i}mmap(){return this.addr===void 0&&this.load(),{ptr:this.addr,allocated:!1}}load(){let e=this.addr=Module._malloc(this.size);for(let r of this.chunks)Module.HEAPU8.set(r,e),e+=r.byteLength;this.chunks=null,this.patch()}patch(){if(!!this.patchTbl){for(let e of this.patchTbl)if(Module.HEAPU8[this.addr+e[0]]!==e[1]){console.log("Patch failed");return}for(let e of this.patchTbl)Module.HEAPU8[this.addr+e[0]]=e[2];console.log("Patch applied"),this.patchTbl=null}}};var K=class{constructor(e){this.message=e;this.name="NoGamedataError"}toString(){return this.name+": "+this.message}},q=class{constructor(){this.hasMidi=!1;this.hasBGM=!1;this.aldFiles=null}async startLoad(){await this.doLoad(),this.createGr()}getCDDALoader(){return this.hasBGM?new D(new Z(6,0)):this.createCDDALoader()}async loadSystem3(e){await ke("system3"),Module.arguments.push("-savedir",e),de.then(()=>{ie(e.replace(/\/@$/,""))})}async loadXsystem35(){await ke("xsystem35"),this.aldFiles=[]}addFile(e,r,n){var i;Bt(e,r,n),(i=this.aldFiles)==null||i.push(e)}createGr(){if(!this.aldFiles)return;let e={b:"BGM",d:"Data",g:"Graphics",m:"Midi",r:"Resource",s:"Scenario",w:"Wave"},r="",n=[];for(let i of this.aldFiles){if(i.toLowerCase()==="system39.ain"){n.push("Ain "+i);continue}if(!i.toLowerCase().endsWith(".ald"))continue;let a=i.charAt(i.length-6).toLowerCase(),s=i.charAt(i.length-5);if(r=i.slice(0,-6),!e[a]){console.log("Resource file of unknown type: "+i);continue}n.push(e[a]+s.toUpperCase()+" "+i),a=="m"&&(this.hasMidi=!0),a=="b"&&(this.hasBGM=!0)}for(let i=0;i<26;i++){let a=String.fromCharCode(65+i);n.push("Save"+a+" save/"+r+"s"+a.toLowerCase()+".asd")}n.push(`MsgSkip save/${r}.msgskip`),FS.writeFile("xsystem35.gr",n.join(`
`)+`
`)}},Be=class extends q{constructor(e,r,n){super();this.imageFile=e;this.metadataFile=r;this.patchFiles=n}async doLoad(){this.imageReader=await Pt(this.imageFile,this.metadataFile);let e=await V.create(this.imageReader),r=await this.findGameDir(e);if(!r)throw new K(d.no_gamedata_dir);let n=!!await e.getDirEnt("system3.exe",r);n?await this.loadSystem3(await this.saveDir(e)):await this.loadXsystem35();let i=B("ImageLoad");for(let a of await e.readDir(r)){if(this.patchFiles.some(m=>m.name.toLowerCase()===a.name.toLowerCase()))continue;if(n){if(!a.name.toLowerCase().endsWith(".dat"))continue}else if(a.name.match(/^\.|\.(exe|dll|txt|ini)$/i))continue;let s=B(a.name),l=await e.readFile(a);s(),this.addFile(a.name,a.size,l)}for(let a of this.patchFiles){let s=await a.arrayBuffer();this.addFile(a.name,a.size,[new Uint8Array(s)])}i()}createCDDALoader(){return new D(this.imageReader)}async findGameDir(e){for(let r of await e.readDir(e.rootDir())){if(r.isDirectory&&(r.name.toLowerCase()==="gamedata"||await e.getDirEnt("adisk.dat",r)))return r;if(r.name.toLowerCase()==="adisk.dat")return e.rootDir()}return null}async saveDir(e){let r=e.volumeLabel();return r||(await e.getDirEnt("prog.bat",e.rootDir())?r="ProG":await e.getDirEnt("dps_all.bat",e.rootDir())?r="DPS_all":(r="untitled",gtag("event","NoVolumeLabel",{event_category:"Loader",event_label:this.imageFile.name}))),"/save/"+r}async walk(e,r,n){for(let i of await e.readDir(r))i.name!=="."&&i.name!==".."&&(console.log(n+i.name),i.isDirectory&&this.walk(e,i,n+i.name+"/"))}},Ue=class extends q{constructor(e){super();this.tracks=[];this.files=[];for(let r=0;r<e.length;r++)this.files.push(e[r])}async doLoad(){this.files.some(e=>e.name.toLowerCase()==="adisk.dat")?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let e of this.files){let r=/(\d+)\.(wav|mp3|ogg)$/.exec(e.name.toLowerCase());if(r){this.tracks[Number(r[1])]=e;continue}let n=await e.arrayBuffer();this.addFile(e.name,e.size,[new Uint8Array(n)])}}createCDDALoader(){return new D(this)}async extractTrack(e){if(!this.tracks[e])throw new Error("FileSource: Invalid track "+e);return this.tracks[e]}},Re=class extends q{constructor(e){super();this.zipFile=e;this.tracks=[]}async doLoad(){await b(T);let e=new JSZip;await e.loadAsync(await this.zipFile.arrayBuffer(),oe());let r=e.file(/\.(ald|ain|dat|mda|ttf|otf|ini|xsys35rc)$/i);if(r.length===0){let n=e.file(/\.(d88|dsk|hdm|xdf)$/i).length>0?d.floppy_images_cant_be_used:d.no_ald_in_zip;throw new K(n)}e.file(/adisk.dat/i).length>0?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let n of r){let i=await e.files[n.name].async("arraybuffer"),a=n.name.split("/").pop();this.addFile(a,i.byteLength,[new Uint8Array(i)])}for(let n of e.file(/\d+\.(wav|mp3|ogg)$/i)){let i=Number(/(\d+)\.\w+$/.exec(n.name)[1]);this.tracks[i]=n}}createCDDALoader(){return new D(this)}async extractTrack(e){let r=this.tracks[e];if(!r)throw new Error("ZipSource: Invalid track "+e);let n=await r.async("arraybuffer");return O(n,r.name)}},Ie=class extends q{constructor(e){super();this.file=e;this.tracks=[]}async doLoad(){let e=new Worker("worker/archiveworker.js");e.postMessage({file:this.file}),o("#loader").classList.add("module-loading");let r=await new Promise(i=>{e.addEventListener("message",a=>i(a))});if("error"in r.data)throw o("#loader").classList.remove("module-loading"),new Error(r.data.error);let{files:n}=r.data;n.some(i=>i.name.toLowerCase()==="adisk.dat")?await this.loadSystem3("/save/@"):await this.loadXsystem35();for(let i of n){let a=/(\d+)\.(wav|mp3|ogg)$/i.exec(i.name);if(a){this.tracks[Number(a[1])]=O(i.content,i.name);continue}this.addFile(i.name,i.content.byteLength,[i.content])}}createCDDALoader(){return new D(this)}async extractTrack(e){if(!this.tracks[e])throw new Error("SevenZipSource: Invalid track "+e);return this.tracks[e]}};var Ge={};ne(Ge,{fade:()=>Ht,getPosition:()=>Rr,play:()=>Ot,setBGMLoader:()=>Br,setCDDALoader:()=>be,stop:()=>Ur});var E=o("#volume-control-slider"),_,J,X=c.volume,U=!1;function Dr(){E.value=String(Math.round(X*100)),o("#volume-control-icon").addEventListener("click",Nt),E.addEventListener("input",Fr),E.addEventListener("change",Cr),E.addEventListener("mouseup",()=>{E.blur()}),_=new AudioContext,_r(),J=_.createGain(),J.connect(_.destination),Ne(Pr),J.gain.value=R(),document.addEventListener("gamestart",()=>{document.addEventListener("keydown",Mr)})}function he(){return J}function _r(){let t=()=>{let e=_.createBufferSource();e.buffer=_.createBuffer(1,1,22050),e.connect(_.destination),e.start(),console.log("AudioContext unlocked"),window.removeEventListener("touchend",t),window.removeEventListener("mouseup",t)};window.addEventListener("touchend",t),window.addEventListener("mouseup",t)}function R(){return U?0:parseInt(E.value,10)/100}function Ne(t){o("#volume-control").addEventListener("volumechange",t)}function Rt(){E.hidden=!0}function It(){_.suspend(),setTimeout(()=>_.resume(),0)}function Nt(t){U=!U,U?(o("#volume-control-icon").classList.remove("fa-volume-up"),o("#volume-control-icon").classList.add("fa-volume-off"),E.value="0"):(o("#volume-control-icon").classList.remove("fa-volume-off"),o("#volume-control-icon").classList.add("fa-volume-up"),E.value=String(Math.round(X*100))),zt()}function Fr(t){X=parseInt(E.value,10)/100,X>0&&U&&(U=!1,o("#volume-control-icon").classList.remove("fa-volume-off"),o("#volume-control-icon").classList.add("fa-volume-up")),zt()}function Cr(t){c.volume=X,c.persist()}function zt(){let t=new CustomEvent("volumechange",{detail:R()});o("#volume-control").dispatchEvent(t)}function Pr(t){J.gain.value=t.detail}function Mr(t){t.keyCode===77&&Nt(t)}Dr();var u=o("audio"),Gt,I=null,ge,Q=1,Y,w=null,Wt=class{constructor(e,r){let n=performance.now(),i=Q;this.done=new Le,this.timer=setInterval(()=>{let a=performance.now()-n;Q=a>=e?r:i+a/e*(r-i),u.volume=R()*Q,a>=e&&(clearInterval(this.timer),this.timer=void 0,this.done.resolve())},10)}cancel(){clearInterval(this.timer),this.timer=void 0,this.done.resolve()}wait(){return this.done.promise}};function Tr(){ge=!ae(),Ne(Nr),u.volume=R(),u.addEventListener("error",Gr),u.addEventListener("ended",zr),$t(!0),ge||(Rt(),u.volume===0&&(w=()=>{}))}function be(t){Gt=t}function Br(t,e){be(new D(new Z(t,e)))}function Ot(t,e){if(I=t,w){w=()=>{Ot(t,e)};return}u.currentTime=0,Gt.getCDDA(t,u).then(r=>Ir(r,e),r=>gtag("event","InvalidTrack",{event_category:"CDDA"}))}async function Ur(t){t&&await Ht(t,0),u.pause(),I=null,w&&(w=()=>{})}async function Ht(t,e){if(!!ge){if(Y&&(Y.cancel(),Y=void 0),t<=0){Q=e,u.volume=R()*Q;return}return Y=new Wt(t,e),Y.wait()}}function Rr(){if(!I)return 0;let t=Math.round(u.currentTime*75);return(w||u.error)&&(t+=750),I|t<<8}function Ir(t,e){u.setAttribute("src",t),u.loop=e!==0,u.load(),u.play().catch(r=>{if(!(r.message.startsWith("The play() request was interrupted")||r.name==="AbortError"))if(r.name==="NotAllowedError"||r.message.indexOf("gesture")>=0)$t(!1),gtag("event","UnlockAgain",{event_category:"CDDA"});else{let{name:n,message:i}=r;h({type:"CDDA",name:n,message:i})}})}function Nr(t){if(ge){u.volume=t.detail;return}let e=t.detail===0;if(!!w!==e)if(e)u.pause(),w=()=>{u.play()};else{let r=w;w=null,r()}}function zr(t){I=null,w&&(w=()=>{})}function Gr(t){if(u.error){let{code:e,message:r}=u.error;h({type:"Audio",code:e,message:r})}else h({type:"Audio",code:"unknown"})}function $t(t){let e=()=>{t?I||(u.load(),console.log("CDDA unlocked")):u.play(),window.removeEventListener("touchend",e),window.removeEventListener("mouseup",e)};window.addEventListener("touchend",e),window.addEventListener("mouseup",e)}Tr();var ye={};ne(ye,{fadeStart:()=>Zr,getPosition:()=>$r,getVolume:()=>Vr,init:()=>Oe,isFading:()=>Kr,pause:()=>Or,play:()=>Wr,resume:()=>Hr,setVolume:()=>jr,stop:()=>We});var f,L,ve=!1,jt=0,N=null;function Oe(t){Module.addRunDependency("timidity"),b("/timidity/timidity.js").then(()=>{L=t.context.createGain(),L.connect(t),f=new Timidity(L,"/timidity/"),f.on("playing",qr),f.on("error",Jr),f.on("ended",Xr),Module.removeRunDependency("timidity")})}function Wr(t,e,r){!f||(f.load(Module.HEAPU8.slice(e,e+r)),f.play(),ve=!0)}function We(){!f||(ve=!1,f.pause())}function Or(){!f||f.pause()}function Hr(){!f||f.play()}function $r(){return f?Math.round(f.currentTime*1e3):0}function jr(t){!f||(L.gain.value=t/100)}function Vr(){return f?L.gain.value*100:100}function Zr(t,e,r){!f||(L.gain.cancelScheduledValues(L.context.currentTime),N!==null&&(clearTimeout(N),N=null),!(t===0&&e===100&&(N||!ve))&&(L.gain.linearRampToValueAtTime(e/100,L.context.currentTime+t/1e3),jt=performance.now()+t,r&&(t===0?We():N=setTimeout(()=>{We(),N=null},t))))}function Kr(){return f&&performance.now()<jt?1:0}function qr(t){!t||L.gain.setValueAtTime(1,t)}function Jr(t){console.warn(t),h(t)}function Xr(){ve&&f.play()}var ee,we,Vt=[],He=!1;function Yr(){o("#fileselect").addEventListener("change",Qr,!1),document.body.ondragover=en,document.body.ondrop=tn}function Qr(t){let e=t.target;$e(e.files),e.value=""}function en(t){t.stopPropagation(),t.preventDefault(),t.dataTransfer.dropEffect="copy"}function tn(t){var r;t.stopPropagation(),t.preventDefault();let e=(r=t.dataTransfer)==null?void 0:r.items;if(!!e){if(e.length===1){let n=e[0].webkitGetAsEntry();if(n==null?void 0:n.isDirectory){rn(n);return}}$e(t.dataTransfer.files)}}async function rn(t){let e=[];async function r(n,i){let a=await new Promise((s,l)=>n.createReader().readEntries(s,l));for(let s of a)if(s.isDirectory&&i>0)await r(s,i-1);else if(s.isFile){let l=await new Promise((m,y)=>s.file(m,y));e.push(l)}}await r(t,1),$e(e)}async function $e(t){if(He||t.length===0)return;let e=!1,r=!1;for(let i of t)nn(i)?(ee=i,o("#imgReady").classList.remove("notready"),o("#imgReady").textContent=i.name,r=!0):an(i)?(we=i,o("#cueReady").classList.remove("notready"),o("#cueReady").textContent=i.name,r=!0):(i.name.match(/\.(ald|ain)$/i)||i.name.toLowerCase()==="adisk.dat")&&(e=!0,Vt.push(i));let n=null;if(ee&&(we||ee.name.toLowerCase().endsWith(".iso"))?n=new Be(ee,we,Vt):!ee&&!we&&(t.length==1&&t[0].name.toLowerCase().endsWith(".zip")?n=new Re(t[0]):t.length==1&&t[0].name.match(/\.(rar|7z)$/i)?n=new Ie(t[0]):t.length>2&&e&&(n=new Ue(t))),!n){r||v(`${t[0].name}: ${d.unrecognized_format}`,"warning");return}He=!0;try{await n.startLoad(),be(n.getCDDALoader()),on(n.hasMidi)}catch(i){i instanceof K?(gtag("event","NoGamedata",{event_category:"Loader",event_label:i.message}),v(`${d.cannot_install}: ${i.message}`,"warning")):i instanceof Error&&(gtag("event","LoadFailed",{event_category:"Loader",event_label:i.message}),v(`${d.cannot_install}: ${d.unrecognized_format}`,"warning"))}He=!1}function nn(t){let e=t.name.toLowerCase();return e.endsWith(".img")||e.endsWith(".mdf")||e.endsWith(".iso")}function an(t){let e=t.name.toLowerCase();return e.endsWith(".cue")||e.endsWith(".ccd")||e.endsWith(".mds")}function on(t){t&&Oe(he()),o("#xsystem35").hidden=!1,document.body.classList.add("game"),o("#toolbar").classList.remove("before-game-start"),window.onbeforeunload=sn,setTimeout(()=>{Module.arguments.push(c.antialias?"-antialias":"-noantialias"),Module.arguments.push("-fm"),Module.removeRunDependency("gameFiles"),document.dispatchEvent(new Event("gamestart"))},0)}function sn(t){c.unloadConfirmation&&(t.returnValue=d.unload_confirmation,It())}Yr();var F=o("#canvas"),Ve=o("#zoom"),te=o("#pixelate"),je=!1;function ln(){Ve.addEventListener("change",Ze),Ve.value=c.zoom,CSS.supports("image-rendering","pixelated")||CSS.supports("image-rendering","-moz-crisp-edges")?(te.addEventListener("change",Zt),c.pixelate&&(te.checked=!0,Zt())):te.setAttribute("disabled","true"),screen.orientation&&screen.orientation.addEventListener("change",()=>{screen.orientation.type.startsWith("landscape")?un():dn()}),window.addEventListener("resize",cn)}function Ze(){let t=Ve.value;c.zoom=t,c.persist();let e=o(".navbar").style;if(t==="fit")o("#xsystem35").classList.add("fit"),e.maxWidth="none",F.style.width="";else{o("#xsystem35").classList.remove("fit");let r=Number(t);e.maxWidth=F.style.width=F.width*r+"px"}}function cn(){je||(je=!0,window.requestAnimationFrame(()=>{Ke(),je=!1}))}function Ke(){let t=o(".contents"),e=o("#xsystem35"),r=t.offsetWidth/t.offsetHeight;if(!r)return;let n=F.width/F.height;r<n?(e.classList.add("letterbox"),e.classList.remove("pillarbox")):(e.classList.remove("letterbox"),e.classList.add("pillarbox"))}function Zt(){c.pixelate=te.checked,c.persist(),te.checked?F.classList.add("pixelated"):F.classList.remove("pixelated")}function un(){let t=document.documentElement;t.requestFullscreen?t.requestFullscreen():t.webkitRequestFullScreen&&t.webkitRequestFullScreen()}function dn(){document.exitFullscreen?document.fullscreenElement&&document.exitFullscreen():document.webkitExitFullscreen&&document.webkitFullscreenElement&&document.webkitExitFullscreen()}ln();var Ye={};ne(Ye,{enable_audio_hook:()=>Dn,pcm_fadeout:()=>wn,pcm_getpos:()=>xn,pcm_getwavelen:()=>En,pcm_isplaying:()=>Ln,pcm_load:()=>gn,pcm_load_data:()=>bn,pcm_load_mixlr:()=>vn,pcm_reset:()=>hn,pcm_setvol:()=>Sn,pcm_start:()=>yn,pcm_stop:()=>Se,pcm_unload:()=>qt,pcm_waitend:()=>kn});var fn=1+128,p=[],C=new Array(fn).fill(1),x=[],k=he();function pn(){document.addEventListener("visibilitychange",An)}async function qe(t){let e=se(2,t-1);if(!e)throw new Error("Failed to open wave "+t);k.context.resume();let r=await Kt(e.data);return x[t]=r,r}async function Kt(t){try{return await k.context.decodeAudioData(t)}catch(e){let r=new Uint8Array(t);if(r[0]===79&&r[1]===103&&r[2]===103&&r[3]===83){await b("lib/stbvorbis-0.2.2.js");let n=[],i=0;return new Promise((a,s)=>{stbvorbis.decode(t,l=>{if(l.error)s(l.error);else if(!l.eof)n.length===0&&(i=l.sampleRate),n.push(l.data);else{let m=n[0].length,y=n.reduce((g,A)=>g+A[0].length,0),S=k.context.createBuffer(m,y,i);for(let g=0;g<m;g++){let A=S.getChannelData(g),re=0;for(let at of n)A.set(at[g],re),re+=at[g].length}a(S)}})})}throw e}}function hn(){for(let t=0;t<p.length;t++)qt(t)}function gn(t,e){return Asyncify.handleSleep(r=>{if(Se(t),x[e])return p[t]=new xe(k,x[e],C[t]),r(0);qe(e).then(n=>{p[t]=new xe(k,n,C[t]),r(0)},n=>{h({type:"PCM",err:n}),r(-1)})})}function bn(t,e,r){return Asyncify.handleSleep(n=>{Se(t),Kt(Module.HEAPU8.slice(e,e+r).buffer).then(i=>{p[t]=new xe(k,i,C[t]),n(0)},i=>{h({type:"PCM",err:i}),n(-1)})})}function vn(t,e,r){return Asyncify.handleSleep(n=>{if(Se(t),x[e]&&x[r])return p[t]=new Je(k,x[e],x[r],C[t]),n(0);let i=[x[e]?Promise.resolve(x[e]):qe(e),x[r]?Promise.resolve(x[r]):qe(r)];Promise.all(i).then(a=>{p[t]=new Je(k,a[0],a[1],C[t]),n(0)}).catch(a=>{h({type:"PCM",err:a}),n(-1)})})}function qt(t){let e=p[t];return e?(e.stop(),p[t]=null,0):-1}function yn(t,e){let r=p[t];return r?(r.start(e),0):(console.log("pcm_start: invalid slot",t),-1)}function Se(t){let e=p[t];return e?(e.stop(),t===0&&(p[t]=null),0):-1}function wn(t,e){let r=p[t];return r?(e===0?r.stop():r.fadeout(e),0):-1}function xn(t){let e=p[t];return e?e.getPosition()*1e3:0}function Sn(t,e){C[t]=e/100;let r=p[t];return r&&r.setGain(C[t]),0}function En(t){let e=p[t];return e?e.duration*1e3:0}function Ln(t){let e=p[t];return e?e.isPlaying()?1:0:0}function kn(t){return Asyncify.handleSleep(e=>{let r=p[t];if(!r||!r.isPlaying())return e(0);r.end_callback=()=>e(0)})}function An(){document.hidden&&(x=[])}var Xe=class{constructor(e,r){this.dst=e;this.end_callback=null;this.startTime=null;this.context=e.context,this.gain=this.context.createGain(),this.setGain(r),this.gain.connect(e)}setGain(e){this.gain.gain.value=e}fadeout(e){this.gain.gain.linearRampToValueAtTime(0,this.context.currentTime+e/1e3),this.stop(e)}getPosition(){return this.startTime===null?0:this.context.currentTime-this.startTime}isPlaying(){return this.startTime!==null}ended(){this.startTime=null,this.end_callback&&(this.end_callback(),this.end_callback=null)}},xe=class extends Xe{constructor(e,r,n){super(e,n);this.buf=r}start(e){this.node=this.context.createBufferSource(),this.node.buffer=this.buf,this.node.connect(this.gain),this.node.onended=this.onended.bind(this),e!==1&&(this.node.loop=!0),e<=1?this.node.start():this.node.start(0,0,this.buf.duration*e),this.startTime=this.context.currentTime}stop(e){this.startTime!==null&&this.node.stop(e?this.context.currentTime+e/1e3:void 0)}get duration(){return this.buf.duration}onended(){this.ended()}},Je=class extends Xe{constructor(e,r,n,i){super(e,i);this.endCount=0;this.lsrc=this.context.createBufferSource(),this.rsrc=this.context.createBufferSource(),this.lsrc.buffer=r,this.rsrc.buffer=n;let a=this.context.createChannelMerger(2);a.connect(this.gain),this.lsrc.connect(a,0,0),this.rsrc.connect(a,0,1),this.lsrc.onended=this.rsrc.onended=this.onended.bind(this)}start(e){e!==1&&console.warn("PCMSoundMixLR: loop is not supported "+e),this.lsrc.start(),this.rsrc.start(),this.startTime=this.context.currentTime}stop(e){if(this.startTime!==null){let r=e?this.context.currentTime+e/1e3:void 0;this.lsrc.stop(r),this.rsrc.stop(r)}}get duration(){return Math.max(this.lsrc.buffer.duration,this.rsrc.buffer.duration)}onended(){this.endCount++,this.endCount===2&&this.ended()}},z;function Dn(){if(!z){z=k.context.createScriptProcessor(4096,0,2);let e=Module._malloc(4096*2*2);z.addEventListener("audioprocess",r=>{let n=r.outputBuffer.getChannelData(0),i=r.outputBuffer.getChannelData(1);if(_audio_callback(e,4096))for(let a=0;a<4096;a++)n[a]=Module.HEAP16[(e>>1)+a*2]/32768,i[a]=Module.HEAP16[(e>>1)+a*2+1]/32768;else for(let a=0;a<4096;a++)n[a]=i[a]=0}),z.connect(k)}return z.context.resume(),z.context.sampleRate}pn();var it={};ne(it,{disableWheelEvent:()=>Un,keywait:()=>Mn,message:()=>Cn,newline:()=>rt,nextpage:()=>Pn,setTitle:()=>nt});var _n=2e3,Jt=0,Fn=[["ＲＡＮＣＥ",[2]],["ＲＡＮＣＥ２",[2]],["Ｒａｎｃｅ３",[1]],[/^(Ｒａｎｃｅ４　－教団の遺産－　Ｆｏｒ　Ｗｉｎ９５|Rance4 -Legacy of the Sect- For Win95|RanceⅣ　－教団の遺産－　for Windows|Rance4 -Legacy of the Sect- for Windows)$/,[10,11,16,88,90,98]],["ランス 4.1 〜お薬工場を救え！〜",[6]],["ランス 4.2 〜エンジェル組〜",[7]],["Rance4.1 for System3.9",[2,7]],["Rance4.2 for System3.9",[2,8]],[/^(鬼畜王ランス|Kichikuou Rance)$/,[7,11,15,16,17,18,23,24,32,33,197]],["闘神都市",[1]],["闘神都市Ⅱ　ｆｏｒ　Ｗｉｎ９５",[4,5,6,7,8]],["あゆみちゃん物語",[6]],[/^グレイメルカ ver1\./,[1,2,5,6]]],P=o("#textlog-content");o("#textlog-button").addEventListener("click",tt);o("#textlog-close").addEventListener("click",Ee);o("#textlog-overlay").addEventListener("click",Ee);document.addEventListener("gamestart",()=>{document.addEventListener("keydown",t=>{t.keyCode===76?tt():t.keyCode===27&&Ee()})});o("#canvas").addEventListener("wheel",t=>{performance.now()<Jt||t.deltaY<=0&&tt()});P.addEventListener("wheel",t=>{t.deltaY>0&&P.scrollTop+P.clientHeight>=P.scrollHeight&&Ee()});function tt(){let t=o("#textlog-modal").classList;t.contains("active")||(Tn(P),t.add("active"),P.scrollTop=P.scrollHeight)}function Ee(){o("#textlog-modal").classList.remove("active")}var Qe=-1,G="",W=[],et=[],Xt=M.get("consoleTextLog")==="1";function Cn(t,e){G===""&&(Qe=e),G+=t}function rt(){G!==""&&(Bn(Qe)||(Xt&&console.log(Qe+": "+G),Yt(G)),G="")}function Pn(){rt(),W[W.length-1]!==""&&(Xt&&console.log(""),Yt(""))}function Mn(){rt()}function Tn(t){t.textContent=W.join(`
`)}function nt(t){for(let[e,r]of Fn)if(e instanceof RegExp?e.test(t):e===t){et=r;return}et=[]}function Yt(t){W.push(t),W.length>_n&&W.shift()}function Bn(t){return et.includes(t)}function Un(t){Jt=performance.now()+t}var er=class{constructor(){let e=d;window.onerror=(r,n,i,a,s)=>{let l=Qt();h({type:"onerror",message:r,url:n,line:i,column:a,address:l},!0),v(e.error_occurred,"error"),window.onerror=null},window.addEventListener("unhandledrejection",r=>{let n=r.reason,i=Qt();if(console.log(i,n),n instanceof Error){let{name:a,message:s,stack:l}=n;h({type:"rejection",name:a,message:s,stack:l,address:i},!0),a==="RuntimeError"&&v(e.error_occurred,"error")}else h({type:"rejection",name:n.constructor.name,reason:n,address:i},!0)})}windowSizeChanged(){Ze(),Ke()}setWindowTitle(e){let r=e.indexOf(":");r!==-1&&(e=e.slice(r+1).trim(),nt(e),o(".navbar-brand").textContent=e,gtag("event","GameStart",{GameTitle:e,event_category:"Game",event_label:e}))}inputString(e,r,n){e+=" ("+d.input_char_limit(n)+")";let i=window.prompt(e,r);return i&&(i=i.substring(0,n)),i}inputNumber(e,r,n,i){e+=` (${r}-${n})`;let a=window.prompt(e,i+"");if(a){let s=parseInt(a);if(r<=s&&s<=n)return s}return-1}setSkipButtonState(e,r){mt(e,r)}quit(){v(d.game_over),gtag("event","GameEnd",{event_category:"Game"}),window.onbeforeunload=null}syncfs(e=100){Lt(e)}};function Qt(){if(!!window._nact_current_page)return _nact_current_page()+":"+_nact_current_addr().toString(16)}var Rn=new er,In={Status:$,shell:Rn,cdPlayer:Ge,midiPlayer:ye,audio:Ye,texthook:it,load_mincho_font:kt};window.xsystem35=In;typeof WebAssembly!="object"&&(document.getElementById("unsupported").hidden=!1);document.addEventListener("gamestart",()=>{let t=o("#xsystem35");t.addEventListener("touchstart",e=>{e.target===t&&_simulate_right_button(1)}),t.addEventListener("touchend",e=>{e.target===t&&_simulate_right_button(0)})});"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("service-worker.js")});window.addEventListener("beforeinstallprompt",t=>{t.userChoice.then(e=>{gtag("event","InstallPrompt",{event_category:"App",event_label:e.outcome})})});
//# sourceMappingURL=shell.js.map
